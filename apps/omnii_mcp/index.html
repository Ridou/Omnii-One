<!DOCTYPE html>
<html>
  <head>
    <title>People API Quickstart</title>
    <meta charset="utf-8" />
    <style>
      .form-group {
        margin: 10px 0;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
      }
      .form-group input {
        padding: 5px;
        width: 200px;
      }
      button {
        margin: 5px;
        padding: 8px 15px;
      }
    </style>
    <script>
      // Add error handling for script loading
      function handleScriptError(error) {
        console.error("Script loading error:", error);
        document.getElementById("content").innerText =
          "Error loading required scripts. Please check your internet connection.";
      }
    </script>
  </head>
  <body>
    <p>People API Quickstart</p>

    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
    <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>

    <!-- Add contact form -->
    <div id="contact_form" style="display: none; margin: 20px 0">
      <h3>Create New Contact</h3>
      <div class="form-group">
        <label for="givenName">First Name:</label>
        <input type="text" id="givenName" />
      </div>
      <div class="form-group">
        <label for="familyName">Last Name:</label>
        <input type="text" id="familyName" />
      </div>
      <button onclick="createContact()">Create Contact</button>
    </div>

    <pre id="content" style="white-space: pre-wrap"></pre>

    <script type="text/javascript">
      /* exported gapiLoaded */
      /* exported gisLoaded */
      /* exported handleAuthClick */
      /* exported handleSignoutClick */

      // TODO(developer): Replace with your actual API key from Google Cloud Console
      const CLIENT_ID =
        "31768914670-v6qqf961ersh1m2ahtlekff552ovis66.apps.googleusercontent.com";
      // This should be an API key, not an OAuth client secret
      const API_KEY = "AIzaSyC8_6_0KTOwHknXPuOQUVjr1_1OloSfIyo"; // Get this from Google Cloud Console -> APIs & Services -> Credentials

      // Discovery doc URL for APIs used by the quickstart
      const DISCOVERY_DOC =
        "https://www.googleapis.com/discovery/v1/apis/people/v1/rest";

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      const SCOPES =
        "https://www.googleapis.com/auth/contacts https://www.googleapis.com/auth/contacts.readonly";

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      document.getElementById("authorize_button").style.visibility = "hidden";
      document.getElementById("signout_button").style.visibility = "hidden";

      /**
       * Callback after api.js is loaded.
       */
      function gapiLoaded() {
        try {
          gapi.load("client", initializeGapiClient);
        } catch (error) {
          handleScriptError(error);
        }
      }

      /**
       * Callback after the API client is loaded. Loads the
       * discovery doc to initialize the API.
       */
      async function initializeGapiClient() {
        try {
          await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: [DISCOVERY_DOC],
          });
          gapiInited = true;
          maybeEnableButtons();
        } catch (error) {
          console.error("Error initializing GAPI client:", error);
          document.getElementById("content").innerText =
            "Error initializing Google API client. Please check your API key and make sure the People API is enabled.";
        }
      }

      /**
       * Callback after Google Identity Services are loaded.
       */
      function gisLoaded() {
        try {
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: "", // defined later
          });
          gisInited = true;
          maybeEnableButtons();
        } catch (error) {
          handleScriptError(error);
        }
      }

      /**
       * Enables user interaction after all libraries are loaded.
       */
      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          document.getElementById("authorize_button").style.visibility =
            "visible";
        }
      }

      /**
       * Create a new contact
       */
      async function createContact() {
        const givenName = document.getElementById("givenName").value;
        const familyName = document.getElementById("familyName").value;

        if (!givenName || !familyName) {
          document.getElementById("content").innerText =
            "Please fill in both first and last name";
          return;
        }

        try {
          const response = await gapi.client.people.people.createContact({
            resource: {
              names: [
                {
                  givenName: givenName,
                  familyName: familyName,
                },
              ],
            },
          });

          document.getElementById("content").innerText =
            "Contact created successfully!\n" +
            JSON.stringify(response.result, null, 2);

          // Clear form
          document.getElementById("givenName").value = "";
          document.getElementById("familyName").value = "";

          // Refresh contact list
          await listConnectionNames();
        } catch (err) {
          document.getElementById("content").innerText =
            "Error creating contact: " + err.message;
        }
      }

      /**
       *  Sign in the user upon button click.
       */
      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw resp;
          }
          document.getElementById("signout_button").style.visibility =
            "visible";
          document.getElementById("authorize_button").innerText = "Refresh";
          document.getElementById("contact_form").style.display = "block";
          await listConnectionNames();
        };

        if (gapi.client.getToken() === null) {
          // Prompt the user to select a Google Account and ask for consent to share their data
          // when establishing a new session.
          tokenClient.requestAccessToken({ prompt: "consent" });
        } else {
          // Skip display of account chooser and consent dialog for an existing session.
          tokenClient.requestAccessToken({ prompt: "" });
        }
      }

      /**
       *  Sign out the user upon button click.
       */
      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken("");
          document.getElementById("content").innerText = "";
          document.getElementById("authorize_button").innerText = "Authorize";
          document.getElementById("signout_button").style.visibility = "hidden";
          document.getElementById("contact_form").style.display = "none";
        }
      }

      /**
       * Print the display name if available for 10 connections.
       */
      async function listConnectionNames() {
        let response;
        try {
          // Fetch first 10 files
          response = await gapi.client.people.people.connections.list({
            resourceName: "people/me",
            pageSize: 10,
            personFields: "names,emailAddresses",
          });
        } catch (err) {
          document.getElementById("content").innerText = err.message;
          return;
        }
        const connections = response.result.connections;
        if (!connections || connections.length == 0) {
          document.getElementById("content").innerText =
            "No connections found.";
          return;
        }
        // Flatten to string to display
        const output = connections.reduce((str, person) => {
          if (!person.names || person.names.length === 0) {
            return `${str}Missing display name\n`;
          }
          return `${str}${person.names[0].displayName}\n`;
        }, "Connections:\n");
        document.getElementById("content").innerText = output;
      }
    </script>
    <script
      async
      defer
      src="https://apis.google.com/js/api.js"
      onload="gapiLoaded()"
    ></script>
    <script
      async
      defer
      src="https://accounts.google.com/gsi/client"
      onload="gisLoaded()"
    ></script>
  </body>
</html>
