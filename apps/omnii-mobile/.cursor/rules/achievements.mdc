---
description: 
globs: 
alwaysApply: false
---
# ðŸ† ACHIEVEMENTS SCREEN IMPLEMENTATION PLAN

## Overview
Transform the home tab into an achievements screen for authenticated users while maintaining the landing page for non-authenticated users. This creates a gamified hub that celebrates user progress and drives engagement through Shape of AI UX paradigms.

---

## ðŸŽ¯ Core Implementation Strategy

### 1. **Conditional Routing & Tab Behavior**

#### Current State Analysis
- `app/(tabs)/index.tsx` serves as landing page for all users
- `app/(tabs)/_layout.tsx` maps "index" to Home icon
- Tab bar hidden for non-authenticated users via `display: isAuthenticated ? 'flex' : 'none'`
- **EXISTING**: `useProfileXP.ts` hook already provides XP, level, mascotStage
- **EXISTING**: Profile context already manages achievements via milestones

#### Implementation Plan

**A. Tab Layout Modifications (`app/(tabs)/_layout.tsx`)**
```typescript
// FIXED: Add Trophy import to existing imports
import { CircleUser as UserCircle, Chrome as Home, TrendingUp, Settings, Trophy } from 'lucide-react-native';

// Dynamic tab configuration based on authentication
const getTabIcon = (isAuthenticated: boolean, { color, size }: any) => {
  if (isAuthenticated) {
    return <Trophy size={size} color={color} />; // Achievement icon
  }
  return <Home size={size} color={color} />; // Landing page icon
};

// Update tab screen options with proper function signature
<Tabs.Screen
  name="index"
  options={{
    tabBarIcon: ({ color, size }) => getTabIcon(isAuthenticated, { color, size }),
  }}
/>
```

**B. Conditional Screen Rendering (`app/(tabs)/index.tsx`)**
```typescript
import { AchievementsScreen } from '@/components/achievements/AchievementsScreen';
import { LandingPageContent } from '@/components/landing/LandingPageContent';

export default function IndexScreen() {
  const { user, session } = useAuth();
  const isAuthenticated = !!(user && session);

  // Route authenticated users to achievements
  if (isAuthenticated) {
    return <AchievementsScreen />;
  }

  // Show landing page for non-authenticated users
  return <LandingPageContent />;
}
```

**C. Extract Landing Page Content**
```typescript
// components/landing/LandingPageContent.tsx
// Move ALL current index.tsx content here
// Keep existing animations, styling, and functionality
// Maintain SEO and marketing content unchanged
```

---

## ðŸ—ï¸ Achievements Screen Architecture

### 2. **File Structure Implementation**

```
app/(tabs)/
â”œâ”€â”€ index.tsx                    # Conditional router (Landing vs Achievements)
components/
â”œâ”€â”€ achievements/
â”‚   â”œâ”€â”€ AchievementsScreen.tsx   # Main screen component
â”‚   â”œâ”€â”€ MascotEvolution.tsx      # Animated mascot with stage display
â”‚   â”œâ”€â”€ AchievementCard.tsx      # Individual achievement items
â”‚   â”œâ”€â”€ ProgressBar.tsx          # XP and level progress
â”‚   â”œâ”€â”€ CelebrationModal.tsx     # Achievement unlock animations
â”‚   â””â”€â”€ LeaderboardCard.tsx      # Social comparison
â”œâ”€â”€ landing/
â”‚   â””â”€â”€ LandingPageContent.tsx   # Extracted landing page
src/types/
â”œâ”€â”€ achievements.ts              # Extended achievement data structures
hooks/
â”œâ”€â”€ useFetchAchievements.ts      # Achievement data fetching
â”œâ”€â”€ useAchievementCelebrations.ts # Animation triggers
â””â”€â”€ useMascotAssets.ts          # Asset management hook
assets/images/mascot/            # Following created directory structure
```

---

## ðŸŽ® Achievement Screen Structure

### 3. **Integration with Existing Systems**

#### **A. Leverage Existing XP System**
```typescript
// Use existing useProfileXP hook instead of creating new one
import { useProfileXP } from '@/hooks/useProfileXP';
import { useProfile } from '@/context/ProfileContext';

export function AchievementsScreen() {
  const { currentXP, level, mascotStage, milestones } = useProfileXP();
  const { state } = useProfile();
  
  // Convert existing milestones to achievement format
  const achievements = useMemo(() => 
    convertMilestonesToAchievements(milestones), [milestones]
  );
}
```

#### **B. Asset Integration with Created Structure**
```typescript
// hooks/useMascotAssets.ts
import { useMemo } from 'react';

const MASCOT_ASSETS = {
  stages: {
    seed: {
      small: require('@/assets/images/mascot/stages/seed/seed-small.png'),
      medium: require('@/assets/images/mascot/stages/seed/seed-medium.png'),
      large: require('@/assets/images/mascot/stages/seed/seed-large.png'),
    },
    flower: {
      small: require('@/assets/images/mascot/stages/flower/flower-small.png'),
      medium: require('@/assets/images/mascot/stages/flower/flower-medium.png'),
      large: require('@/assets/images/mascot/stages/flower/flower-large.png'),
    },
    tree: {
      small: require('@/assets/images/mascot/stages/tree/tree-small.png'),
      medium: require('@/assets/images/mascot/stages/tree/tree-medium.png'),
      large: require('@/assets/images/mascot/stages/tree/tree-large.png'),
    }
  },
  expressions: {
    happy: require('@/assets/images/mascot/expressions/happy/happy-default.png'),
    surprised: require('@/assets/images/mascot/expressions/surprised/surprised-default.png'),
    focused: require('@/assets/images/mascot/expressions/focused/focused-default.png'),
    proud: require('@/assets/images/mascot/expressions/proud/proud-default.png'),
    encouraging: require('@/assets/images/mascot/expressions/encouraging/encouraging-default.png'),
  },
  animations: {
    evolution: {
      seedToFlower: require('@/assets/videos/mascot/evolution-sequences/seed-to-flower.mp4'),
      flowerToTree: require('@/assets/videos/mascot/evolution-sequences/flower-to-tree.mp4'),
    },
    celebration: require('@/assets/images/mascot/animations/celebration/celebration-sequence.gif'),
    idle: require('@/assets/images/mascot/animations/idle/idle-loop.gif'),
  },
  sounds: {
    achievements: {
      unlock: require('@/assets/sounds/achievements/achievement-unlock.mp3'),
      milestone: require('@/assets/sounds/achievements/milestone-complete.mp3'),
    },
    celebrations: {
      levelUp: require('@/assets/sounds/celebrations/level-up.mp3'),
      evolution: require('@/assets/sounds/celebrations/evolution-fanfare.mp3'),
    }
  }
};

export function useMascotAssets() {
  return useMemo(() => MASCOT_ASSETS, []);
}
```

#### **C. Deep Linking with Expo Router**
```typescript
// FIXED: Proper expo-router deep linking syntax
import { useRouter, useLocalSearchParams } from 'expo-router';

const navigateToAchievementAction = (achievement: Achievement) => {
  switch (achievement.actionRoute) {
    case 'analytics_patterns':
      // Use expo-router href syntax instead of query params
      router.push('/analytics?tab=insights');
      break;
    case 'approvals_queue':
      router.push('/approvals?filter=all');
      break;
    case 'profile_calibration':
      router.push('/profile?tab=ai');
      break;
    default:
      // Create achievement detail screen
      router.push(`/achievement/${achievement.id}`);
  }
};
```

---

## ðŸŽ® Enhanced Achievement Screen Structure

### 4. **Four-Tab System (Identical Animation System)**

Following **EXACT** patterns from `profile.tsx` and `analytics.tsx`:

```typescript
// Use identical tab configuration pattern
const achievementTabs: AchievementTabConfig[] = [
  {
    key: 'evolution',
    label: 'Evolution',
    icon: 'ðŸŒ±',
    gradient: [AppColors.aiGradientStart, AppColors.aiGradientEnd]
  },
  {
    key: 'discover',
    label: 'Discover',
    icon: 'ðŸ”',
    gradient: ['#667eea', '#764ba2']
  },
  {
    key: 'celebrate',
    label: 'Celebrate',
    icon: 'ðŸŽ‰',
    gradient: ['#4ECDC4', '#44A08D']
  },
  {
    key: 'social',
    label: 'Social',
    icon: 'ðŸ‘¥',
    gradient: ['#FFB347', '#FFD700']
  }
];

// IDENTICAL shimmer animations from profile.tsx/analytics.tsx
const shimmerAnimations = useRef(
  achievementTabs.reduce((acc, tab) => {
    acc[tab.key] = new Animated.Value(0);
    return acc;
  }, {} as Record<AchievementTab, Animated.Value>)
).current;

// IDENTICAL scale animations and handlers
const scaleAnimations = useRef(
  achievementTabs.reduce((acc, tab) => {
    acc[tab.key] = new Animated.Value(1);
    return acc;
  }, {} as Record<AchievementTab, Animated.Value>)
).current;
```

#### **A. Evolution Tab - Mascot Evolution Hub**
```typescript
const EvolutionContent = () => {
  const { currentXP, level, mascotStage } = useProfileXP();
  const mascotAssets = useMascotAssets();
  
  return (
    <ScrollView style={styles.tabContent}>
      {/* Large Animated Mascot Display */}
      <MascotEvolution 
        currentStage={mascotStage}
        level={level}
        currentXP={currentXP}
        assets={mascotAssets}
        onMascotPress={triggerMascotAnimation}
      />
      
      {/* Evolution Timeline using existing stage system */}
      <EvolutionTimeline 
        currentStage={mascotStage}
        currentLevel={level}
        stageFeatures={STAGE_FEATURES} // From useProfileXP
      />
      
      {/* Growth Prediction with AI */}
      <AIInsightCard 
        insight={{
          title: "Evolution Prediction",
          message: `At your current pace, you'll ${getNextEvolutionMessage(mascotStage, level)}!`,
          confidence: calculateEvolutionConfidence(currentXP, level),
          sources: ['XP earning rate', 'Daily activity', 'Milestone progress']
        }}
      />
    </ScrollView>
  );
};
```

#### **B. Discover Tab - Achievement Discovery Center**
```typescript
const DiscoverContent = () => {
  const { milestones } = useProfileXP();
  const { state } = useProfile();
  
  // Convert existing milestones to achievements
  const achievements = useMemo(() => 
    milestones.map(milestone => convertMilestoneToAchievement(milestone, state)), 
    [milestones, state]
  );
  
  return (
    <ScrollView style={styles.tabContent}>
      {/* AI-Recommended Achievements */}
      <AIRecommendations 
        achievements={achievements.filter(a => !a.completed)}
        userActivity={state}
        reasoning="Based on your productivity patterns and progress"
      />
      
      {/* Achievement Categories by Stage */}
      <AchievementCategories 
        seedAchievements={achievements.filter(a => a.unlocksAt === 'seed')}
        flowerAchievements={achievements.filter(a => a.unlocksAt === 'flower')}
        treeAchievements={achievements.filter(a => a.unlocksAt === 'tree')}
      />
      
      {/* Progress Tracking with Take Action Buttons */}
      {achievements.map((achievement) => (
        <AchievementCard 
          key={achievement.id}
          achievement={achievement}
          onTakeAction={() => navigateToAchievementAction(achievement)}
          showProgress={true}
          mascotAssets={useMascotAssets()}
        />
      ))}
    </ScrollView>
  );
};
```

#### **C. Celebrate Tab - Victory Celebration Hub**
```typescript
const CelebrateContent = () => {
  const { milestones, currentXP } = useProfileXP();
  const recentlyCompleted = milestones.filter(m => 
    m.completed && m.completedAt && 
    new Date(m.completedAt).getTime() > Date.now() - (7 * 24 * 60 * 60 * 1000)
  );
  
  return (
    <ScrollView style={styles.tabContent}>
      {/* Recent Unlocks with Claim Buttons */}
      <RecentUnlocks 
        unlocks={recentlyCompleted}
        onClaim={triggerCelebration}
        mascotAssets={useMascotAssets()}
      />
      
      {/* Active Streaks - integrate with existing analytics */}
      <StreakCounters 
        streaks={getActiveStreaks(state)} // From analytics data
        protectionOptions={getStreakProtectionOptions(currentXP)}
      />
      
      {/* Personal Records from Analytics */}
      <PersonalRecords 
        records={getPersonalBests(state)}
        challengeOptions={getBeatRecordChallenges()}
      />
      
      {/* Milestone Memories Gallery */}
      <MilestoneMemories 
        memories={getAchievementScreenshots(milestones)}
        shareOptions={getSocialSharingOptions()}
      />
    </ScrollView>
  );
};
```

#### **D. Social Tab - Community & Sharing**
```typescript
const SocialContent = () => (
  <ScrollView style={styles.tabContent}>
    {/* Achievement Leaderboards */}
    <Leaderboard 
      type="weekly"
      userXP={currentXP}
      userLevel={level}
      privacySettings={state.privacy}
    />
    
    {/* Team Challenges */}
    <TeamChallenges 
      teamSync={state.teamSync}
      achievements={achievements}
    />
    
    {/* Share Achievement Stories */}
    <ShareCenter 
      recentAchievements={recentlyCompleted}
      mascotStage={mascotStage}
      templates={getSocialTemplates()}
    />
  </ScrollView>
);
```

---

## ðŸ¤– Enhanced Shape of AI Integration

### 5. **Modern AI UX Paradigms Implementation**

#### **A. Governors & Trust Indicators**
```typescript
// Achievement Reasoning Cards - integrate with existing AIInsightCard
<AIInsightCard 
  insight={{
    title: "Pattern Recognition Achievement Ready",
    message: "You've reviewed analytics for 5 consecutive days",
    confidence: 94,
    sources: [
      "Analytics screen usage: 7 sessions",
      "Daily login patterns: consistent",
      "Screen time data: 15+ min daily"
    ],
    reasoning: "Based on your consistent daily review habit",
    action: "Claim 75 XP",
    actionRoute: "achievements_claim"
  }}
  onAction={() => claimAchievement('pattern-seeker')}
  showSources={true}
/>

// Progress Prediction with Confidence
<PredictionCard 
  prediction="You'll unlock 'Efficiency Expert' in 3 days"
  confidence={82}
  reasoning={[
    "Current task completion velocity: +15% above baseline",
    "Consistent 2-hour faster completion rate maintained",
    "Historical pattern analysis shows steady improvement"
  ]}
  evidenceSources={[
    "Task completion data (last 14 days)",
    "Efficiency metrics from analytics",
    "Performance trend analysis"
  ]}
/>
```

#### **B. Show the Work Pattern**
```typescript
// XP Calculation Transparency
<XPBreakdown 
  totalXP={currentXP}
  breakdown={[
    { 
      source: "Daily tasks completed", 
      xp: 180, 
      reasoning: "6 tasks Ã— 30 XP each (efficiency bonus applied)",
      confidence: 100 
    },
    { 
      source: "Efficiency bonus", 
      xp: 85, 
      reasoning: "Completed 2h faster than AI estimate",
      confidence: 92 
    },
    { 
      source: "Streak multiplier", 
      xp: 75, 
      reasoning: "5-day consistency streak Ã— 15 XP bonus",
      confidence: 100 
    }
  ]}
  showCalculation={true}
  onViewDetails={() => router.push('/xp-details')}
/>

// Achievement Progress Reasoning
<ProgressReasoning 
  achievement="Time Alchemist"
  progress={{ current: 7.2, target: 10, unit: "hours saved" }}
  reasoning="AI suggestions saved you time through smart scheduling and focus optimization"
  evidenceSources={[
    "Calendar analysis: 3.2h from smart scheduling",
    "Task completion data: 2.8h from focus optimization", 
    "Distraction reduction: 1.2h from notification timing"
  ]}
  confidence={89}
  methodology="Calculated by comparing actual completion times vs. baseline estimates"
/>
```

---

## ðŸ“Š Enhanced Data Architecture

### 6. **Type System Implementation (Extended)**

```typescript
// src/types/achievements.ts - Extended from existing profile types
export interface Achievement extends Omit<ProfileMilestone, 'category'> {
  id: string;
  title: string;
  description: string;
  xpReward: number;
  category: 'seed' | 'flower' | 'tree';
  progress: AchievementProgress;
  aiInsight?: AIAchievementInsight;
  actionRoute?: AchievementActionRoute;
  unlockAnimation?: CelebrationType;
  mascotReaction?: MascotExpression;
}

export interface AchievementProgress {
  current: number;
  target: number;
  percentage: number;
  completed: boolean;
  unlockedAt?: string;
  estimatedCompletion?: string;
  streakData?: StreakInfo;
}

export interface AIAchievementInsight {
  reasoning: string[];
  confidence: number;
  sources: string[];
  methodology?: string;
  suggestions: string[];
  timeToComplete?: string;
  difficulty: 'easy' | 'medium' | 'hard';
  evidenceQuality: 'low' | 'medium' | 'high';
}

export type AchievementActionRoute = 
  | 'analytics_patterns'
  | 'analytics_insights' 
  | 'analytics_trends'
  | 'approvals_queue'
  | 'approvals_filter'
  | 'profile_calibration'
  | 'profile_ai'
  | 'profile_connect'
  | 'achievements_claim';

export type MascotExpression = 
  | 'happy'
  | 'surprised'
  | 'focused'
  | 'proud'
  | 'encouraging';

export interface CelebrationConfig {
  type: 'minimal' | 'standard' | 'explosive';
  animations: AnimationSequence[];
  sounds: SoundEffect[];
  haptics: HapticPattern[];
  duration: number;
  mascotReaction: MascotExpression;
}
```

### 7. **Data Fetching & State Management (Enhanced)**

```typescript
// hooks/useFetchAchievements.ts - Integrate with existing systems
import { useProfileXP } from '@/hooks/useProfileXP';
import { useProfile } from '@/context/ProfileContext';
import { useFetchAnalytics } from '@/hooks/useFetchAnalytics';

export function useFetchAchievements() {
  const { milestones, currentXP, level, mascotStage } = useProfileXP();
  const { state } = useProfile();
  const { analytics } = useFetchAnalytics();
  
  const achievements = useMemo(() => {
    return milestones.map(milestone => 
      convertMilestoneToAchievement(milestone, state, analytics)
    );
  }, [milestones, state, analytics]);

  const aiRecommendations = useMemo(() => {
    return getAIRecommendedAchievements(achievements, state, analytics);
  }, [achievements, state, analytics]);

  return {
    achievements,
    aiRecommendations,
    mascotData: { stage: mascotStage, level, currentXP },
    isLoading: false, // Use existing loading states
    error: null,
    refetch: () => {
      // Trigger existing refetch mechanisms
    }
  };
}

// Convert existing milestone to achievement format
function convertMilestoneToAchievement(
  milestone: ProfileMilestone, 
  profileState: ProfileState,
  analytics?: AnalyticsData
): Achievement {
  return {
    ...milestone,
    category: getCategoryFromMilestone(milestone),
    progress: {
      current: milestone.progress,
      target: milestone.maxProgress,
      percentage: (milestone.progress / milestone.maxProgress) * 100,
      completed: milestone.completed,
      unlockedAt: milestone.completedAt?.toISOString(),
      estimatedCompletion: calculateEstimatedCompletion(milestone, profileState, analytics)
    },
    aiInsight: generateAIInsight(milestone, profileState, analytics),
    actionRoute: getActionRoute(milestone),
    mascotReaction: getMascotReaction(milestone)
  };
}
```

---

## ðŸŽ¨ Component Architecture (Enhanced)

### 8. **Reusable Components (Following Existing Patterns)**

#### **A. Achievement Components**
```typescript
// components/achievements/AchievementCard.tsx
interface AchievementCardProps {
  achievement: Achievement;
  onTakeAction?: (route: AchievementActionRoute) => void;
  onClaim?: () => void;
  showProgress?: boolean;
  mascotAssets: MascotAssets;
}

// IDENTICAL styling patterns to MetricCard.tsx and AIInsightCard.tsx
// Same AppColors usage: AppColors.cardBackground, AppColors.textPrimary
// Same shadow system: ...AppColors.shadows.card
// Same border radius (16) and padding (20)
// Same margin patterns and responsive design
```

#### **B. Mascot Evolution Component**
```typescript
// components/achievements/MascotEvolution.tsx
interface MascotEvolutionProps {
  currentStage: 'seed' | 'flower' | 'tree';
  level: number;
  currentXP: number;
  assets: MascotAssets;
  onMascotPress?: () => void;
  showEvolutionTimeline?: boolean;
}

// Integration with existing useProfileXP
const MascotEvolution = ({ currentStage, level, currentXP, assets, ...props }) => {
  const { getUnlockedFeatures, nextLevelXP, levelProgress } = useProfileXP();
  
  return (
    <View style={styles.mascotContainer}>
      {/* Animated mascot using assets structure */}
      <TouchableOpacity onPress={props.onMascotPress}>
        <Image 
          source={assets.stages[currentStage].large}
          style={styles.mascotImage}
        />
      </TouchableOpacity>
      
      {/* XP Progress Bar */}
      <ProgressBar 
        progress={levelProgress}
        total={100}
        color={AppColors.aiGradientStart}
      />
      
      {/* Level and Stage Info */}
      <Text style={styles.levelText}>Level {level}</Text>
      <Text style={styles.stageText}>
        {currentStage === 'seed' ? 'ðŸŒ± Seed' : 
         currentStage === 'flower' ? 'ðŸŒ¸ Flower' : 'ðŸŒ³ Tree'} Stage
      </Text>
    </View>
  );
};
```

---

## ðŸš€ Updated Implementation Timeline

### 9. **Phased Development Approach (Revised)**

#### **Phase 1: Foundation & Integration (Day 1-2)**
- [x] âœ… Create asset directory structure
- [ ] Extract landing page content to `components/landing/LandingPageContent.tsx`
- [ ] Implement conditional routing in `index.tsx`
- [ ] Update tab layout with Trophy import and conditional icon
- [ ] Create `useMascotAssets.ts` hook with asset imports
- [ ] Extend achievement types building on existing `ProfileMilestone`

#### **Phase 2: Core Screen Structure (Day 3-4)**
- [ ] Create `AchievementsScreen.tsx` with four-tab system
- [ ] Port EXACT animation system from `profile.tsx`/`analytics.tsx`
- [ ] Implement `MascotEvolution.tsx` component using existing XP system
- [ ] Build `AchievementCard.tsx` following `MetricCard.tsx` patterns
- [ ] Create `useFetchAchievements.ts` leveraging existing hooks

#### **Phase 3: Shape of AI Integration (Day 5-6)**
- [ ] Extend existing `AIInsightCard.tsx` for achievement reasoning
- [ ] Implement XP calculation transparency using `useProfileXP`
- [ ] Create achievement progress reasoning with confidence indicators
- [ ] Add smart achievement recommendations based on user patterns
- [ ] Build celebration modal with mascot animations

#### **Phase 4: Advanced Features & Polish (Day 7-8)**
- [ ] Implement social features using existing privacy settings
- [ ] Add deep linking with proper expo-router syntax
- [ ] Create streak protection system integrated with analytics
- [ ] Build meta-achievements extending existing milestone system
- [ ] Polish animations and add sound effects

#### **Phase 5: Testing & Optimization (Day 9-10)**
- [ ] Test conditional routing with authentication states
- [ ] Validate achievement progress with existing XP calculations
- [ ] Test celebration animations with actual asset files
- [ ] Verify deep linking across all app screens
- [ ] Performance testing and accessibility compliance

---

## ðŸ”§ Critical Implementation Notes

### 10. **Integration Considerations**

#### **A. Leverage Existing Systems**
- âœ… **XP System**: Use `useProfileXP` instead of creating new system
- âœ… **Milestones**: Extend existing `ProfileMilestone` instead of new achievements
- âœ… **AI Cards**: Reuse `AIInsightCard` component for consistency
- âœ… **Animations**: Copy EXACT animation code from `profile.tsx`
- âœ… **Styling**: Use identical `AppColors` and shadow patterns

#### **B. Asset Integration**
- âœ… **Directory Structure**: Created comprehensive mascot asset organization
- âœ… **Import Pattern**: Follow existing logo import pattern in `OmniiLogo.tsx`
- âœ… **Performance**: Implement lazy loading and caching strategies
- âœ… **Customization**: Support mascot customization from profile context

#### **C. Shape of AI Implementation**
- âœ… **Trust Indicators**: Show confidence scores and evidence sources
- âœ… **Transparency**: Explain XP calculations and achievement logic
- âœ… **User Control**: Allow customization of celebration styles
- âœ… **Privacy**: Respect existing privacy settings for social features

---

This updated implementation plan addresses all critical issues found during codebase review and ensures seamless integration with existing systems while maintaining the comprehensive gamification experience outlined in the original plan.
