---
description:
globs:
alwaysApply: true
---

-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.account_deletions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  deletion_reason text,
  deletion_requested_at timestamp with time zone DEFAULT now(),
  grace_period_ends timestamp with time zone DEFAULT (now() + '30 days'::interval),
  data_exported boolean DEFAULT false,
  export_download_count integer DEFAULT 0,
  recovery_token text UNIQUE,
  recovery_attempts integer DEFAULT 0,
  permanent_deletion_at timestamp with time zone,
  deletion_completed boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT account_deletions_pkey PRIMARY KEY (id),
  CONSTRAINT account_deletions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.achievement_unlocks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  achievement_id text NOT NULL,
  unlocked_at timestamp with time zone DEFAULT now(),
  xp_awarded integer NOT NULL DEFAULT 0,
  level_at_unlock integer,
  celebration_shown boolean DEFAULT false,
  celebration_shown_at timestamp with time zone,
  shared boolean DEFAULT false,
  shared_at timestamp with time zone,
  unlock_trigger text,
  metadata jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT achievement_unlocks_pkey PRIMARY KEY (id),
  CONSTRAINT achievement_unlocks_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT achievement_unlocks_achievement_id_fkey FOREIGN KEY (achievement_id) REFERENCES public.achievements(id)
);
CREATE TABLE public.achievements (
  id text NOT NULL,
  title text NOT NULL,
  description text NOT NULL,
  category text NOT NULL CHECK (category = ANY (ARRAY['exploration'::text, 'engagement'::text, 'mastery'::text, 'social'::text, 'milestone'::text])),
  difficulty text NOT NULL CHECK (difficulty = ANY (ARRAY['easy'::text, 'medium'::text, 'hard'::text, 'legendary'::text])),
  xp_reward integer NOT NULL DEFAULT 0 CHECK (xp_reward >= 0),
  icon text DEFAULT 'ðŸ†'::text,
  max_progress integer NOT NULL DEFAULT 1 CHECK (max_progress > 0),
  progress_type text NOT NULL CHECK (progress_type = ANY (ARRAY['counter'::text, 'streak'::text, 'milestone'::text, 'boolean'::text])),
  required_level integer DEFAULT 1,
  prerequisite_achievements ARRAY DEFAULT '{}'::text[],
  unlock_conditions jsonb DEFAULT '{}'::jsonb,
  is_hidden boolean DEFAULT false,
  is_shareable boolean DEFAULT true,
  community_tier text CHECK (community_tier = ANY (ARRAY['bronze'::text, 'silver'::text, 'gold'::text, 'platinum'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  active boolean DEFAULT true,
  CONSTRAINT achievements_pkey PRIMARY KEY (id)
);
CREATE TABLE public.app_config (
  key text NOT NULL,
  value text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT app_config_pkey PRIMARY KEY (key)
);
CREATE TABLE public.brain_memory_cache (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  memory_period text NOT NULL CHECK (memory_period = ANY (ARRAY['past_week'::text, 'current_week'::text, 'next_week'::text, 'tasks'::text, 'calendar'::text, 'contacts'::text, 'emails'::text])),
  concepts_data jsonb NOT NULL DEFAULT '{"concepts": [], "relationships": []}'::jsonb,
  total_concepts integer NOT NULL DEFAULT 0,
  cache_version integer NOT NULL DEFAULT 1,
  last_synced_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone DEFAULT (now() + '24:00:00'::interval),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  data_type text NOT NULL CHECK (data_type = ANY (ARRAY['neo4j_concepts'::text, 'google_tasks'::text, 'google_calendar'::text, 'google_contacts'::text, 'google_emails'::text])),
  cache_data jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT brain_memory_cache_pkey PRIMARY KEY (id),
  CONSTRAINT brain_memory_cache_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.brain_memory_stats (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  cache_hits integer DEFAULT 0,
  cache_misses integer DEFAULT 0,
  neo4j_queries_saved integer DEFAULT 0,
  avg_response_time_ms integer DEFAULT 0,
  last_reset_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT brain_memory_stats_pkey PRIMARY KEY (id),
  CONSTRAINT brain_memory_stats_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.consent_change_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  consent_type text NOT NULL,
  previous_value boolean,
  new_value boolean,
  change_reason text,
  ip_address inet,
  user_agent text,
  created_at timestamp with time zone DEFAULT now(),
  audit_id uuid,
  CONSTRAINT consent_change_log_pkey PRIMARY KEY (id),
  CONSTRAINT consent_change_log_audit_id_fkey FOREIGN KEY (audit_id) REFERENCES public.data_operations_audit(id),
  CONSTRAINT consent_change_log_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.data_access_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  accessed_tables ARRAY,
  access_type text CHECK (access_type = ANY (ARRAY['view'::text, 'export'::text, 'search'::text, 'edit'::text])),
  purpose text,
  ip_address inet,
  user_agent text,
  session_duration_seconds integer,
  created_at timestamp with time zone DEFAULT now(),
  audit_id uuid,
  CONSTRAINT data_access_log_pkey PRIMARY KEY (id),
  CONSTRAINT data_access_log_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT data_access_log_audit_id_fkey FOREIGN KEY (audit_id) REFERENCES public.data_operations_audit(id)
);
CREATE TABLE public.data_operations_audit (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  operation_type text NOT NULL,
  affected_tables ARRAY,
  record_count integer,
  operation_metadata jsonb DEFAULT '{}'::jsonb,
  legal_basis text,
  performed_by uuid,
  ip_address inet,
  user_agent text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT data_operations_audit_pkey PRIMARY KEY (id)
);
CREATE TABLE public.email_suppressions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email text NOT NULL UNIQUE,
  reason text NOT NULL,
  suppressed_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT email_suppressions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.high_impact_operations_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  audit_id uuid,
  operation_type text NOT NULL,
  user_id uuid,
  impact_level text CHECK (impact_level = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])),
  requires_review boolean DEFAULT false,
  reviewed_at timestamp with time zone,
  reviewed_by uuid,
  review_notes text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT high_impact_operations_log_pkey PRIMARY KEY (id),
  CONSTRAINT high_impact_operations_log_audit_id_fkey FOREIGN KEY (audit_id) REFERENCES public.data_operations_audit(id)
);
CREATE TABLE public.level_progressions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  from_level integer NOT NULL,
  to_level integer NOT NULL,
  xp_at_level_up integer NOT NULL,
  milestone_unlocks jsonb,
  celebration_shown boolean DEFAULT false,
  celebration_shown_at timestamp with time zone,
  unlock_animations_played jsonb DEFAULT '[]'::jsonb,
  achieved_at timestamp with time zone DEFAULT now(),
  CONSTRAINT level_progressions_pkey PRIMARY KEY (id),
  CONSTRAINT level_progressions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.level_progressions_anonymized (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id text NOT NULL,
  from_level integer NOT NULL,
  to_level integer NOT NULL,
  xp_at_level_up integer NOT NULL,
  milestone_unlocks jsonb,
  achieved_at timestamp with time zone,
  anonymized_at timestamp with time zone DEFAULT now(),
  anonymization_id uuid NOT NULL,
  CONSTRAINT level_progressions_anonymized_pkey PRIMARY KEY (id)
);
CREATE TABLE public.messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  chat_id uuid NOT NULL,
  user_id uuid NOT NULL,
  content text NOT NULL,
  role text NOT NULL CHECK (role = ANY (ARRAY['user'::text, 'assistant'::text])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT messages_pkey PRIMARY KEY (id),
  CONSTRAINT messages_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.oauth_tokens (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  provider character varying NOT NULL,
  access_token text NOT NULL,
  refresh_token text,
  expires_at timestamp with time zone,
  scope ARRAY,
  token_type character varying DEFAULT 'Bearer'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT oauth_tokens_pkey PRIMARY KEY (id),
  CONSTRAINT oauth_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.onboarding_quotes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  quote_id text NOT NULL UNIQUE,
  text text NOT NULL,
  author text NOT NULL,
  category text NOT NULL,
  difficulty text NOT NULL CHECK (difficulty = ANY (ARRAY['beginner'::text, 'intermediate'::text, 'advanced'::text])),
  order_index integer NOT NULL,
  psychological_markers jsonb NOT NULL DEFAULT '[]'::jsonb,
  expected_resonance numeric NOT NULL,
  life_domain text NOT NULL,
  active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT onboarding_quotes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.onboarding_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  started_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  total_quotes_shown integer DEFAULT 0,
  quotes_approved integer DEFAULT 0,
  quotes_declined integer DEFAULT 0,
  average_response_time_ms integer,
  final_level_reached integer,
  final_xp_earned integer,
  abandoned_at_quote integer,
  completion_rate numeric,
  discord_cta_shown boolean DEFAULT false,
  discord_cta_clicked boolean DEFAULT false,
  CONSTRAINT onboarding_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT onboarding_sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.onboarding_sessions_anonymized (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id text NOT NULL,
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  total_quotes_shown integer DEFAULT 0,
  quotes_approved integer DEFAULT 0,
  quotes_declined integer DEFAULT 0,
  average_response_time_ms integer,
  final_level_reached integer,
  final_xp_earned integer,
  completion_rate numeric,
  anonymized_at timestamp with time zone DEFAULT now(),
  anonymization_id uuid NOT NULL,
  CONSTRAINT onboarding_sessions_anonymized_pkey PRIMARY KEY (id)
);
CREATE TABLE public.shared_files (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  file_path text NOT NULL,
  owner uuid,
  shared_with uuid,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT shared_files_pkey PRIMARY KEY (id),
  CONSTRAINT shared_files_owner_fkey FOREIGN KEY (owner) REFERENCES auth.users(id),
  CONSTRAINT shared_files_shared_with_fkey FOREIGN KEY (shared_with) REFERENCES auth.users(id)
);
CREATE TABLE public.stripe_customers (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  user_id uuid NOT NULL UNIQUE,
  customer_id text NOT NULL UNIQUE,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  deleted_at timestamp with time zone,
  CONSTRAINT stripe_customers_pkey PRIMARY KEY (id),
  CONSTRAINT stripe_customers_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.stripe_orders (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  checkout_session_id text NOT NULL,
  payment_intent_id text NOT NULL,
  customer_id text NOT NULL,
  amount_subtotal bigint NOT NULL,
  amount_total bigint NOT NULL,
  currency text NOT NULL,
  payment_status text NOT NULL,
  status USER-DEFINED NOT NULL DEFAULT 'pending'::stripe_order_status,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  deleted_at timestamp with time zone,
  CONSTRAINT stripe_orders_pkey PRIMARY KEY (id)
);
CREATE TABLE public.stripe_subscriptions (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  customer_id text NOT NULL UNIQUE,
  subscription_id text,
  price_id text,
  current_period_start bigint,
  current_period_end bigint,
  cancel_at_period_end boolean DEFAULT false,
  payment_method_brand text,
  payment_method_last4 text,
  status USER-DEFINED NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  deleted_at timestamp with time zone,
  CONSTRAINT stripe_subscriptions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_achievement_progress (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  achievement_id text NOT NULL,
  current_progress integer NOT NULL DEFAULT 0 CHECK (current_progress >= 0),
  completed boolean DEFAULT false,
  completed_at timestamp with time zone,
  first_progress_at timestamp with time zone DEFAULT now(),
  last_updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_achievement_progress_pkey PRIMARY KEY (id),
  CONSTRAINT user_achievement_progress_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT user_achievement_progress_achievement_id_fkey FOREIGN KEY (achievement_id) REFERENCES public.achievements(id)
);
CREATE TABLE public.user_data_exports (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  request_type text NOT NULL,
  export_format text DEFAULT 'json'::text,
  file_size_bytes bigint,
  download_url text,
  expires_at timestamp with time zone DEFAULT (now() + '7 days'::interval),
  downloaded_at timestamp with time zone,
  download_count integer DEFAULT 0,
  export_completed boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_data_exports_pkey PRIMARY KEY (id),
  CONSTRAINT user_data_exports_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.user_feature_access (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  feature_name text NOT NULL,
  access_level text NOT NULL,
  unlocked_at timestamp with time zone DEFAULT now(),
  unlocked_by text NOT NULL,
  unlock_level integer,
  first_interaction_at timestamp with time zone,
  interaction_count integer DEFAULT 0,
  CONSTRAINT user_feature_access_pkey PRIMARY KEY (id),
  CONSTRAINT user_feature_access_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.user_feature_access_anonymized (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id text NOT NULL,
  feature_name text NOT NULL,
  access_level text NOT NULL,
  unlocked_at timestamp with time zone,
  unlocked_by text NOT NULL,
  unlock_level integer,
  first_interaction_at timestamp with time zone,
  interaction_count integer DEFAULT 0,
  anonymized_at timestamp with time zone DEFAULT now(),
  anonymization_id uuid NOT NULL,
  CONSTRAINT user_feature_access_anonymized_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_presence (
  user_id uuid NOT NULL,
  is_online boolean DEFAULT false,
  is_typing boolean DEFAULT false,
  last_seen timestamp with time zone DEFAULT now(),
  status text DEFAULT 'offline'::text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_presence_pkey PRIMARY KEY (user_id),
  CONSTRAINT user_presence_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.user_quote_responses (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  quote_id text NOT NULL,
  action text NOT NULL CHECK (action = ANY (ARRAY['approve'::text, 'decline'::text])),
  time_spent_ms integer NOT NULL,
  confidence_score numeric,
  session_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_quote_responses_pkey PRIMARY KEY (id),
  CONSTRAINT user_quote_responses_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT user_quote_responses_quote_id_fkey FOREIGN KEY (quote_id) REFERENCES public.onboarding_quotes(quote_id)
);
CREATE TABLE public.user_quote_responses_anonymized (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id text NOT NULL,
  quote_id text NOT NULL,
  action text NOT NULL,
  time_spent_ms integer NOT NULL,
  confidence_score numeric,
  created_at timestamp with time zone,
  anonymized_at timestamp with time zone DEFAULT now(),
  anonymization_id uuid NOT NULL,
  CONSTRAINT user_quote_responses_anonymized_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_settings (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL UNIQUE,
  settings jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_settings_pkey PRIMARY KEY (id),
  CONSTRAINT user_settings_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.xp_transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  amount integer NOT NULL,
  reason text NOT NULL,
  category text NOT NULL,
  source_action text,
  multiplier numeric DEFAULT 1.0,
  metadata jsonb DEFAULT '{}'::jsonb,
  quote_id text,
  level_before integer,
  level_after integer,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT xp_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT xp_transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.xp_transactions_anonymized (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id text NOT NULL,
  amount integer NOT NULL,
  reason text NOT NULL,
  category text NOT NULL,
  source_action text,
  multiplier numeric DEFAULT 1.0,
  metadata jsonb DEFAULT '{}'::jsonb,
  quote_id text,
  level_before integer,
  level_after integer,
  created_at timestamp with time zone DEFAULT now(),
  anonymized_at timestamp with time zone DEFAULT now(),
  anonymization_id uuid NOT NULL,
  CONSTRAINT xp_transactions_anonymized_pkey PRIMARY KEY (id)
);