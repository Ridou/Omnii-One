---
phase: 03-graphrag-advanced-mcp
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - apps/omnii_mcp/src/mcp/tools/search-nodes.ts
  - apps/omnii_mcp/src/mcp/tools/calendar-query.ts
  - apps/omnii_mcp/src/mcp/tools/contact-lookup.ts
  - apps/omnii_mcp/src/mcp/tools/task-operations.ts
  - apps/omnii_mcp/src/mcp/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "AI can query calendar events with time-based filters via MCP tool"
    - "AI can lookup contacts and find related entities via MCP tool"
    - "AI can query tasks with status filtering via MCP tool"
    - "AI can filter any search by temporal range via time_range parameter"
    - "All domain tools use dual-channel retrieval for context enrichment"
  artifacts:
    - path: "apps/omnii_mcp/src/mcp/tools/search-nodes.ts"
      provides: "Enhanced search_nodes with temporal filtering"
      exports: ["SearchNodesToolDefinition", "handleSearchNodes"]
    - path: "apps/omnii_mcp/src/mcp/tools/calendar-query.ts"
      provides: "Calendar query MCP tool"
      exports: ["CalendarQueryToolDefinition", "handleCalendarQuery"]
    - path: "apps/omnii_mcp/src/mcp/tools/contact-lookup.ts"
      provides: "Contact lookup MCP tool"
      exports: ["ContactLookupToolDefinition", "handleContactLookup"]
    - path: "apps/omnii_mcp/src/mcp/tools/task-operations.ts"
      provides: "Task operations MCP tool"
      exports: ["TaskOperationsToolDefinition", "handleTaskOperations"]
  key_links:
    - from: "search-nodes.ts"
      to: "services/graphrag/temporal-context.ts"
      via: "parseTemporalQuery for time_range filter"
      pattern: "parseTemporalQuery|queryTemporalNodes"
    - from: "calendar-query.ts"
      to: "services/graphrag/temporal-context.ts"
      via: "queryTemporalEvents"
      pattern: "queryTemporalEvents"
    - from: "contact-lookup.ts"
      to: "services/graphrag/local-search.ts"
      via: "localSearch with Contact filter"
      pattern: "localSearch.*Contact"
---

<objective>
Create domain-aware MCP tools for calendar queries, contact lookups, and task operations.

Purpose: Enable AI assistants to perform domain-specific queries with appropriate filtering and context enrichment. These tools build on the generic search_nodes tool with specialized schemas and temporal/relational awareness.

Output: Three domain MCP tools that use GraphRAG dual-channel retrieval
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-graphrag-advanced-mcp/03-RESEARCH.md

# Phase 2 MCP tool patterns
@apps/omnii_mcp/src/mcp/tools/search-nodes.ts
@apps/omnii_mcp/src/mcp/tools/index.ts

# Phase 3 dependencies (from 03-01 and 03-02)
# temporal-context.ts provides: queryTemporalEvents, TEMPORAL_DURATIONS
# local-search.ts provides: localSearch, LocalSearchOptions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add temporal filtering to search_nodes MCP tool</name>
  <files>
    apps/omnii_mcp/src/mcp/tools/search-nodes.ts
  </files>
  <action>
Update the existing `apps/omnii_mcp/src/mcp/tools/search-nodes.ts` to add temporal filtering:

1. **Update Zod input schema** - Add optional time_range parameter:
   ```typescript
   export const SearchNodesInputSchema = z.object({
     query: z.string().describe('Semantic search query'),
     node_types: z.array(z.enum(['Entity', 'Event', 'Contact', 'Concept'])).optional(),
     limit: z.number().min(1).max(100).default(20),
     // NEW: temporal filtering
     time_range: z.enum([
       'today', 'yesterday', 'this week', 'last week',
       'this month', 'last month', 'this year', 'last year'
     ]).optional().describe('Filter results by created_at/start_time within relative time range')
   });
   ```

2. **Update tool definition inputSchema** - Add time_range to properties:
   ```typescript
   time_range: {
     type: 'string',
     enum: ['today', 'yesterday', 'this week', 'last week', 'this month', 'last month', 'this year', 'last year'],
     description: 'Filter results by time range (optional)'
   }
   ```

3. **Update handler** - Integrate temporal filtering:
   - Import `parseTemporalQuery` from `../../services/graphrag/temporal-context`
   - If `time_range` provided:
     - Call `parseTemporalQuery(time_range)` to get duration config
     - Add temporal WHERE clause to Cypher query:
       `WHERE n.created_at >= datetime() - duration($duration)`
     - For Event nodes, also check `start_time`
   - Pass `time_range` option to `localSearch` if using dual-channel retrieval

This exposes the temporal service (from 03-01) to AI via the existing MCP tool interface.
  </action>
  <verify>
Run TypeScript compilation: `cd apps/omnii_mcp && bunx tsc --noEmit`

Check temporal integration: `grep -E "time_range|parseTemporalQuery" apps/omnii_mcp/src/mcp/tools/search-nodes.ts`
  </verify>
  <done>
- search_nodes tool accepts optional time_range parameter
- AI can filter any search by temporal range (today, last week, etc.)
- Temporal service from 03-01 is now accessible via MCP
  </done>
</task>

<task type="auto">
  <name>Task 2: Create calendar query MCP tool</name>
  <files>
    apps/omnii_mcp/src/mcp/tools/calendar-query.ts
  </files>
  <action>
Create `apps/omnii_mcp/src/mcp/tools/calendar-query.ts` following the pattern from search-nodes.ts:

1. **Zod input schema**:
   ```typescript
   export const CalendarQueryInputSchema = z.object({
     time_range: z.enum([
       'today', 'yesterday', 'this week', 'last week',
       'this month', 'last month', 'this year', 'last year'
     ]).describe('Relative time range for calendar query'),
     event_type: z.string().optional().describe('Filter by event type (meeting, appointment, reminder, etc.)'),
     query: z.string().optional().describe('Optional semantic search within time range'),
     include_attendees: z.boolean().default(true).describe('Include related contacts (attendees)')
   });
   ```

2. **Tool definition**:
   ```typescript
   export const CalendarQueryToolDefinition = {
     name: 'omnii_calendar_query',
     description: 'Query calendar events with time-based filtering. Use for questions about meetings, appointments, and scheduled events. Supports relative time ranges like "last week" or "this month".',
     inputSchema: {
       type: 'object',
       properties: {
         time_range: {
           type: 'string',
           enum: ['today', 'yesterday', 'this week', 'last week', 'this month', 'last month', 'this year', 'last year'],
           description: 'Relative time range for calendar query'
         },
         event_type: { type: 'string', description: 'Filter by event type' },
         query: { type: 'string', description: 'Optional semantic search within time range' },
         include_attendees: { type: 'boolean', default: true, description: 'Include related contacts' }
       },
       required: ['time_range']
     }
   };
   ```

3. **Handler function**:
   ```typescript
   export async function handleCalendarQuery(
     input: unknown,
     context: { userId: string; client: Neo4jClient }
   ): Promise<MCPToolResponse>
   ```
   - Validate input with Zod schema
   - Call `queryTemporalEvents` from temporal-context.ts with includeRelated based on include_attendees
   - If `query` provided, additionally filter results using vector similarity
   - Return formatted MCPToolResponse with event details
   - On error, return `{ isError: true, content: [{ type: 'text', text: error message with valid time_range options }] }`
  </action>
  <verify>
Run TypeScript compilation: `cd apps/omnii_mcp && bunx tsc --noEmit`

Check export: `grep "export" apps/omnii_mcp/src/mcp/tools/calendar-query.ts`
  </verify>
  <done>
- CalendarQueryToolDefinition exported with time_range enum
- handleCalendarQuery validates input and queries temporal events
- include_attendees controls whether to fetch related contacts
- Error responses include list of valid time_range options
  </done>
</task>

<task type="auto">
  <name>Task 3: Create contact lookup MCP tool</name>
  <files>
    apps/omnii_mcp/src/mcp/tools/contact-lookup.ts
  </files>
  <action>
Create `apps/omnii_mcp/src/mcp/tools/contact-lookup.ts`:

1. **Zod input schema**:
   ```typescript
   export const ContactLookupInputSchema = z.object({
     query: z.string().describe('Name, email, or description to search for'),
     include_interactions: z.boolean().default(true).describe('Include related events and entities'),
     limit: z.number().min(1).max(50).default(10).describe('Maximum contacts to return')
   });
   ```

2. **Tool definition** with name `omnii_contact_lookup`:
   - Description: "Look up contacts by name, email, or description. Returns contact details and optionally related interactions (meetings, emails, events)."

3. **Handler**:
   - Validate input with Zod schema
   - Call `localSearch` with `nodeTypes: ['Contact']`
   - If include_interactions=true, use `includeContext: true` to get related entities
   - Return contact details with organization, role, and interaction history
   - On error, return `{ isError: true, content: [{ type: 'text', text: error message }] }`
  </action>
  <verify>
Run TypeScript compilation: `cd apps/omnii_mcp && bunx tsc --noEmit`

Check export: `grep "export" apps/omnii_mcp/src/mcp/tools/contact-lookup.ts`
  </verify>
  <done>
- ContactLookupToolDefinition exported with query, include_interactions, limit params
- handleContactLookup validates input and calls localSearch with Contact filter
- Related interactions (events, entities) included when include_interactions=true
  </done>
</task>

<task type="auto">
  <name>Task 4: Create task operations MCP tool and register all new tools</name>
  <files>
    apps/omnii_mcp/src/mcp/tools/task-operations.ts
    apps/omnii_mcp/src/mcp/tools/index.ts
  </files>
  <action>
**Task Operations Tool** (`task-operations.ts`):

1. **Zod input schema**:
   ```typescript
   export const TaskOperationsInputSchema = z.object({
     operation: z.enum(['list', 'search']).describe('Operation to perform'),
     query: z.string().optional().describe('Search query (required for search operation)'),
     status: z.enum(['pending', 'completed', 'all']).default('all').describe('Filter by task status'),
     time_range: z.enum([
       'today', 'yesterday', 'this week', 'last week',
       'this month', 'last month', 'this year', 'last year'
     ]).optional().describe('Filter by due date time range'),
     limit: z.number().min(1).max(100).default(20).describe('Maximum tasks to return')
   });
   ```

2. **Tool definition** with name `omnii_task_operations`:
   - Description: "Query and search tasks. Supports filtering by status (pending/completed) and due date time range."

3. **Handler**:
   - Validate input with Zod schema
   - For 'list' operation: Query all tasks with filters using Cypher
   - For 'search' operation: Use localSearch with semantic query
   - Apply status and time_range filters
   - On error, return `{ isError: true, content: [{ type: 'text', text: error message }] }`

**Update tools/index.ts**:
- Import all three new tools (calendar-query, contact-lookup, task-operations)
- Add to TOOL_DEFINITIONS array
- Add handlers to TOOL_HANDLERS map
  </action>
  <verify>
Run TypeScript compilation: `cd apps/omnii_mcp && bunx tsc --noEmit`

Verify tool registration: `grep "omnii_" apps/omnii_mcp/src/mcp/tools/index.ts`

Expected tools: omnii_graph_search_nodes, omnii_graph_get_context, omnii_graph_list_entities, omnii_calendar_query, omnii_contact_lookup, omnii_task_operations
  </verify>
  <done>
- TaskOperationsToolDefinition and handleTaskOperations exported
- TOOL_DEFINITIONS array updated with 3 new domain tools
- TOOL_HANDLERS map updated with 3 new handlers
- Total of 6 MCP tools available
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. search_nodes tool has time_range parameter wired to temporal service
3. All four domain tools have definitions and handlers
4. Tools use Zod validation at handler entry
5. Calendar tool uses temporal context service
6. Contact and task tools use local search with appropriate filters
7. TOOL_DEFINITIONS and TOOL_HANDLERS updated with new tools
</verification>

<success_criteria>
- [ ] search_nodes tool accepts optional time_range parameter for temporal filtering
- [ ] omnii_calendar_query tool with time_range enum and include_attendees option
- [ ] omnii_contact_lookup tool with include_interactions option
- [ ] omnii_task_operations tool with list/search operations and status filter
- [ ] All tools return MCPToolResponse format with isError flag for failures
- [ ] Tools integrated into TOOL_DEFINITIONS and TOOL_HANDLERS
</success_criteria>

<output>
After completion, create `.planning/phases/03-graphrag-advanced-mcp/03-03-SUMMARY.md`
</output>
