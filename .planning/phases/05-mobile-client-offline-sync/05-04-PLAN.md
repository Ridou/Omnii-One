---
phase: 05-mobile-client-offline-sync
plan: 04
type: execute
wave: 2
depends_on: ["05-02", "05-03"]
files_modified:
  - apps/omnii-mobile/src/components/sync/ConnectionStatus.tsx
  - apps/omnii-mobile/src/components/sync/SyncIndicator.tsx
  - apps/omnii-mobile/src/components/sync/index.ts
autonomous: true

must_haves:
  truths:
    - "User can see current sync status (online/offline/syncing)"
    - "Connection indicator shows colored dot for status"
    - "Pending changes count is visible when offline"
  artifacts:
    - path: "apps/omnii-mobile/src/components/sync/ConnectionStatus.tsx"
      provides: "Full connection status display"
      min_lines: 50
    - path: "apps/omnii-mobile/src/components/sync/SyncIndicator.tsx"
      provides: "Compact sync indicator for headers"
      min_lines: 30
  key_links:
    - from: "apps/omnii-mobile/src/components/sync/ConnectionStatus.tsx"
      to: "apps/omnii-mobile/src/context/SyncContext.tsx"
      via: "useSyncState hook"
      pattern: "useSyncState"
---

<objective>
Create connection status UI components showing sync state (MOBILE-08 requirement).

Purpose: Users need clear visibility into sync state to trust the offline-first experience. Without indicators, users don't know if their changes are synced.

Output: Reusable sync status components (full display and compact indicator).
</objective>

<execution_context>
@/Users/santino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/santino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-mobile-client-offline-sync/05-RESEARCH.md
@apps/omnii-mobile/src/context/SyncContext.tsx
@apps/omnii-mobile/tailwind.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create full ConnectionStatus component</name>
  <files>apps/omnii-mobile/src/components/sync/ConnectionStatus.tsx</files>
  <action>
Create a comprehensive connection status component showing detailed sync information:

```typescript
// apps/omnii-mobile/src/components/sync/ConnectionStatus.tsx
import { View, Text, Pressable, ActivityIndicator } from 'react-native';
import { RefreshCw, Wifi, WifiOff, Check, AlertCircle, Clock } from 'lucide-react-native';
import Animated, {
  useAnimatedStyle,
  withRepeat,
  withTiming,
  Easing,
} from 'react-native-reanimated';
import { useSyncState, type SyncStatus } from '~/context/SyncContext';

// Status configuration
const STATUS_CONFIG: Record<SyncStatus, {
  icon: typeof Wifi;
  color: string;
  bgColor: string;
  label: string;
}> = {
  offline: {
    icon: WifiOff,
    color: 'text-gray-500',
    bgColor: 'bg-gray-100',
    label: 'Offline',
  },
  connecting: {
    icon: Wifi,
    color: 'text-yellow-500',
    bgColor: 'bg-yellow-50',
    label: 'Connecting...',
  },
  syncing: {
    icon: RefreshCw,
    color: 'text-blue-500',
    bgColor: 'bg-blue-50',
    label: 'Syncing...',
  },
  synced: {
    icon: Check,
    color: 'text-green-500',
    bgColor: 'bg-green-50',
    label: 'Synced',
  },
  error: {
    icon: AlertCircle,
    color: 'text-red-500',
    bgColor: 'bg-red-50',
    label: 'Sync Error',
  },
};

// Format relative time
const formatLastSynced = (date: Date | null): string => {
  if (!date) return 'Never';

  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  return `${diffDays}d ago`;
};

interface ConnectionStatusProps {
  /** Show detailed info (last synced, pending count) */
  detailed?: boolean;
  /** Allow tap to trigger sync */
  interactive?: boolean;
  /** Custom class names */
  className?: string;
}

export const ConnectionStatus = ({
  detailed = false,
  interactive = true,
  className = '',
}: ConnectionStatusProps) => {
  const {
    status,
    isSyncing,
    isConnected,
    lastSyncedAt,
    pendingChanges,
    error,
    triggerSync,
  } = useSyncState();

  const config = STATUS_CONFIG[status];
  const Icon = config.icon;

  // Spinning animation for syncing
  const spinStyle = useAnimatedStyle(() => ({
    transform: [
      {
        rotate: isSyncing
          ? withRepeat(
              withTiming('360deg', { duration: 1000, easing: Easing.linear }),
              -1,
              false
            )
          : '0deg',
      },
    ],
  }));

  const handlePress = async () => {
    if (interactive && !isSyncing && isConnected) {
      await triggerSync();
    }
  };

  return (
    <Pressable
      onPress={handlePress}
      disabled={!interactive || isSyncing}
      className={`flex-row items-center px-3 py-2 rounded-xl ${config.bgColor} ${className}`}
    >
      {/* Status Icon */}
      <Animated.View style={status === 'syncing' ? spinStyle : undefined}>
        <Icon size={16} className={config.color} strokeWidth={2.5} />
      </Animated.View>

      {/* Status Label */}
      <Text className={`ml-2 text-sm font-medium ${config.color}`}>
        {config.label}
      </Text>

      {/* Pending Changes Badge */}
      {pendingChanges > 0 && status !== 'syncing' && (
        <View className="ml-2 bg-blue-500 rounded-full px-2 py-0.5">
          <Text className="text-white text-xs font-bold">
            {pendingChanges}
          </Text>
        </View>
      )}

      {/* Detailed Info */}
      {detailed && (
        <View className="ml-auto flex-row items-center">
          {lastSyncedAt && (
            <View className="flex-row items-center">
              <Clock size={12} className="text-gray-400 mr-1" />
              <Text className="text-xs text-gray-500">
                {formatLastSynced(lastSyncedAt)}
              </Text>
            </View>
          )}
        </View>
      )}

      {/* Error Message */}
      {error && detailed && (
        <Text className="ml-2 text-xs text-red-500" numberOfLines={1}>
          {error}
        </Text>
      )}
    </Pressable>
  );
};

export default ConnectionStatus;
```
  </action>
  <verify>TypeScript compiles: `cd apps/omnii-mobile && npx tsc --noEmit`</verify>
  <done>ConnectionStatus shows status, icon, label, pending count, last synced time</done>
</task>

<task type="auto">
  <name>Task 2: Create compact SyncIndicator for headers</name>
  <files>apps/omnii-mobile/src/components/sync/SyncIndicator.tsx</files>
  <action>
Create a minimal sync indicator suitable for navigation headers:

```typescript
// apps/omnii-mobile/src/components/sync/SyncIndicator.tsx
import { View, Pressable } from 'react-native';
import Animated, {
  useAnimatedStyle,
  withRepeat,
  withTiming,
  withSequence,
  Easing,
} from 'react-native-reanimated';
import { useSyncState, type SyncStatus } from '~/context/SyncContext';

// Color mapping for status dot
const STATUS_COLORS: Record<SyncStatus, string> = {
  offline: 'bg-gray-400',
  connecting: 'bg-yellow-400',
  syncing: 'bg-blue-400',
  synced: 'bg-green-400',
  error: 'bg-red-400',
};

interface SyncIndicatorProps {
  /** Size of the dot in pixels */
  size?: number;
  /** Allow tap to trigger sync */
  interactive?: boolean;
  /** Custom class names */
  className?: string;
}

/**
 * Compact sync status indicator - just a colored dot.
 *
 * Usage in navigation header:
 * ```tsx
 * <Stack.Screen
 *   options={{
 *     headerRight: () => <SyncIndicator className="mr-4" />,
 *   }}
 * />
 * ```
 */
export const SyncIndicator = ({
  size = 8,
  interactive = true,
  className = '',
}: SyncIndicatorProps) => {
  const { status, isSyncing, isConnected, triggerSync } = useSyncState();

  // Pulsing animation for syncing/connecting states
  const pulseStyle = useAnimatedStyle(() => {
    if (status === 'syncing' || status === 'connecting') {
      return {
        opacity: withRepeat(
          withSequence(
            withTiming(0.3, { duration: 500, easing: Easing.ease }),
            withTiming(1, { duration: 500, easing: Easing.ease })
          ),
          -1,
          true
        ),
      };
    }
    return { opacity: 1 };
  });

  const handlePress = async () => {
    if (interactive && !isSyncing && isConnected) {
      await triggerSync();
    }
  };

  const colorClass = STATUS_COLORS[status];

  return (
    <Pressable
      onPress={handlePress}
      disabled={!interactive || isSyncing}
      className={`p-2 ${className}`}
      hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}
    >
      <Animated.View
        style={[
          {
            width: size,
            height: size,
            borderRadius: size / 2,
          },
          pulseStyle,
        ]}
        className={colorClass}
      />
    </Pressable>
  );
};

export default SyncIndicator;
```
  </action>
  <verify>TypeScript compiles: `cd apps/omnii-mobile && npx tsc --noEmit`</verify>
  <done>SyncIndicator shows colored dot with pulse animation for syncing states</done>
</task>

<task type="auto">
  <name>Task 3: Create barrel export and add to a visible location</name>
  <files>apps/omnii-mobile/src/components/sync/index.ts</files>
  <action>
1. Create barrel export file:

```typescript
// apps/omnii-mobile/src/components/sync/index.ts
export { ConnectionStatus } from './ConnectionStatus';
export { SyncIndicator } from './SyncIndicator';
```

2. Optionally, add SyncIndicator to an existing visible location for testing.
   Look for an appropriate place like the tabs layout header or profile screen.

   In `apps/omnii-mobile/src/app/(tabs)/_layout.tsx`, add to headerRight option:

```typescript
import { SyncIndicator } from '~/components/sync';

// In Stack.Screen or Tabs.Screen options:
headerRight: () => <SyncIndicator className="mr-4" />,
```

This makes the sync status immediately visible to users.
  </action>
  <verify>
1. Import `import { ConnectionStatus, SyncIndicator } from '~/components/sync'` works
2. If added to layout, verify sync indicator appears in header when app runs
  </verify>
  <done>Barrel export exists, components can be imported from ~/components/sync</done>
</task>

</tasks>

<verification>
1. ConnectionStatus displays: status icon, label, pending count, last synced time
2. SyncIndicator displays: colored dot matching sync status
3. Both components use useSyncState() hook
4. Syncing states show animation (spin for full, pulse for dot)
5. Interactive mode allows tap to trigger sync
6. Barrel export allows clean imports
</verification>

<success_criteria>
- ConnectionStatus shows all sync states with appropriate colors/icons
- SyncIndicator provides minimal header-suitable indicator
- Pending changes badge shows count when offline with changes
- Last synced time formatted as relative time
- Components animate during syncing state
- Error state shows error icon and optional message
</success_criteria>

<output>
After completion, create `.planning/phases/05-mobile-client-offline-sync/05-04-SUMMARY.md`
</output>
