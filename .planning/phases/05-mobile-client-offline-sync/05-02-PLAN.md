---
phase: 05-mobile-client-offline-sync
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/omnii-mobile/package.json
  - apps/omnii-mobile/src/lib/powersync/schema.ts
  - apps/omnii-mobile/src/lib/powersync/index.ts
  - apps/omnii-mobile/metro.config.js
autonomous: true

must_haves:
  truths:
    - "PowerSync packages are installed in mobile app"
    - "PowerSync schema matches backend sync tables"
    - "PowerSync database can be instantiated"
    - "Development build runs on iOS simulator"
    - "Development build runs on Android emulator"
  artifacts:
    - path: "apps/omnii-mobile/src/lib/powersync/schema.ts"
      provides: "PowerSync table schema definitions"
      contains: "new Table"
    - path: "apps/omnii-mobile/src/lib/powersync/index.ts"
      provides: "PowerSync database initialization"
      exports: ["AppSchema", "getPowerSync"]
  key_links:
    - from: "apps/omnii-mobile/src/lib/powersync/schema.ts"
      to: "Supabase sync_entities table"
      via: "matching column definitions"
      pattern: "name: 'sync_entities'"
---

<objective>
Install PowerSync packages and create schema definitions matching the backend Supabase tables.

Purpose: PowerSync requires native SQLite modules and schema definitions that mirror the server tables. This plan sets up the mobile-side infrastructure before wiring the connector.

Output: PowerSync installed, schema matching backend tables, database factory ready.
</objective>

<execution_context>
@/Users/santino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/santino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-mobile-client-offline-sync/05-RESEARCH.md
@apps/omnii-mobile/package.json
@apps/omnii-mobile/metro.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PowerSync packages</name>
  <files>apps/omnii-mobile/package.json</files>
  <action>
Run in `apps/omnii-mobile/`:

```bash
npx expo install @powersync/react-native @powersync/op-sqlite @op-engineering/op-sqlite @powersync/react
```

This installs:
- @powersync/react-native - Core PowerSync SDK
- @powersync/op-sqlite - SQLite adapter using OP-SQLite (fastest)
- @op-engineering/op-sqlite - The native SQLite implementation
- @powersync/react - React hooks and context for PowerSync

After installation, verify package.json has these dependencies.

IMPORTANT: Development builds are required. Expo Go won't work with native modules. The existing scripts already use `--dev-client` flag which is correct.
  </action>
  <verify>
Check apps/omnii-mobile/package.json contains @powersync/react-native
Run `pnpm install` from monorepo root to update lockfile
  </verify>
  <done>PowerSync packages in dependencies, pnpm-lock.yaml updated</done>
</task>

<task type="auto">
  <name>Task 2: Create PowerSync schema matching backend tables</name>
  <files>apps/omnii-mobile/src/lib/powersync/schema.ts</files>
  <action>
Create PowerSync schema file that mirrors the Supabase sync tables:

```typescript
// apps/omnii-mobile/src/lib/powersync/schema.ts
import { Schema, Table, Column, ColumnType } from '@powersync/react-native';

/**
 * PowerSync schema definition
 *
 * IMPORTANT: These tables mirror the Supabase sync_* tables exactly.
 * Column types map to SQLite types internally.
 *
 * Schema requirements:
 * - id column is always TEXT (UUIDs stored as strings)
 * - Timestamps are TEXT (ISO 8601 strings)
 * - JSONB becomes TEXT (JSON stringified)
 */

// sync_entities - Graph entities (tasks, emails, contacts, concepts)
export const syncEntitiesTable = new Table({
  name: 'sync_entities',
  columns: [
    new Column({ name: 'user_id', type: ColumnType.TEXT }),
    new Column({ name: 'entity_type', type: ColumnType.TEXT }),
    new Column({ name: 'name', type: ColumnType.TEXT }),
    new Column({ name: 'properties', type: ColumnType.TEXT }), // JSON string
    new Column({ name: 'source_id', type: ColumnType.TEXT }),
    new Column({ name: 'created_at', type: ColumnType.TEXT }),
    new Column({ name: 'updated_at', type: ColumnType.TEXT }),
  ],
  indexes: [
    // Index for filtering by entity type
    { name: 'idx_entity_type', columns: [{ name: 'entity_type' }] },
    // Index for finding by source ID (deduplication)
    { name: 'idx_source_id', columns: [{ name: 'source_id' }] },
  ],
});

// sync_events - Calendar events
export const syncEventsTable = new Table({
  name: 'sync_events',
  columns: [
    new Column({ name: 'user_id', type: ColumnType.TEXT }),
    new Column({ name: 'summary', type: ColumnType.TEXT }),
    new Column({ name: 'description', type: ColumnType.TEXT }),
    new Column({ name: 'start_time', type: ColumnType.TEXT }),
    new Column({ name: 'end_time', type: ColumnType.TEXT }),
    new Column({ name: 'location', type: ColumnType.TEXT }),
    new Column({ name: 'google_event_id', type: ColumnType.TEXT }),
    new Column({ name: 'attendees', type: ColumnType.TEXT }), // JSON array string
    new Column({ name: 'created_at', type: ColumnType.TEXT }),
    new Column({ name: 'updated_at', type: ColumnType.TEXT }),
  ],
  indexes: [
    // Index for date range queries
    { name: 'idx_start_time', columns: [{ name: 'start_time' }] },
    // Index for Google event deduplication
    { name: 'idx_google_event', columns: [{ name: 'google_event_id' }] },
  ],
});

// sync_relationships - Entity relationships
export const syncRelationshipsTable = new Table({
  name: 'sync_relationships',
  columns: [
    new Column({ name: 'user_id', type: ColumnType.TEXT }),
    new Column({ name: 'from_entity_id', type: ColumnType.TEXT }),
    new Column({ name: 'to_entity_id', type: ColumnType.TEXT }),
    new Column({ name: 'relationship_type', type: ColumnType.TEXT }),
    new Column({ name: 'properties', type: ColumnType.TEXT }), // JSON string
    new Column({ name: 'created_at', type: ColumnType.TEXT }),
    new Column({ name: 'updated_at', type: ColumnType.TEXT }),
  ],
  indexes: [
    // Index for traversing from entity
    { name: 'idx_from_entity', columns: [{ name: 'from_entity_id' }] },
    // Index for traversing to entity
    { name: 'idx_to_entity', columns: [{ name: 'to_entity_id' }] },
    // Index for relationship type queries
    { name: 'idx_rel_type', columns: [{ name: 'relationship_type' }] },
  ],
});

// Combined schema export
export const AppSchema = new Schema([
  syncEntitiesTable,
  syncEventsTable,
  syncRelationshipsTable,
]);

// Type helpers for query results
export interface SyncEntity {
  id: string;
  user_id: string;
  entity_type: 'task' | 'email' | 'contact' | 'concept' | 'entity';
  name: string;
  properties: string; // JSON string, parse with JSON.parse()
  source_id: string;
  created_at: string;
  updated_at: string;
}

export interface SyncEvent {
  id: string;
  user_id: string;
  summary: string;
  description: string | null;
  start_time: string;
  end_time: string;
  location: string | null;
  google_event_id: string | null;
  attendees: string; // JSON array string
  created_at: string;
  updated_at: string;
}

export interface SyncRelationship {
  id: string;
  user_id: string;
  from_entity_id: string;
  to_entity_id: string;
  relationship_type: string;
  properties: string; // JSON string
  created_at: string;
  updated_at: string;
}

// Helper to parse JSON properties safely
export const parseProperties = <T = Record<string, unknown>>(json: string | null): T => {
  if (!json) return {} as T;
  try {
    return JSON.parse(json) as T;
  } catch {
    return {} as T;
  }
};
```
  </action>
  <verify>TypeScript compiles without errors: `cd apps/omnii-mobile && npx tsc --noEmit`</verify>
  <done>Schema file exports AppSchema, table definitions match Supabase columns</done>
</task>

<task type="auto">
  <name>Task 3: Create PowerSync database factory</name>
  <files>apps/omnii-mobile/src/lib/powersync/index.ts, apps/omnii-mobile/metro.config.js</files>
  <action>
1. Create PowerSync database initialization in `apps/omnii-mobile/src/lib/powersync/index.ts`:

```typescript
// apps/omnii-mobile/src/lib/powersync/index.ts
import { PowerSyncDatabase } from '@powersync/react-native';
import { OPSqliteOpenFactory } from '@powersync/op-sqlite';
import { AppSchema } from './schema';

export { AppSchema } from './schema';
export type { SyncEntity, SyncEvent, SyncRelationship, parseProperties } from './schema';

// Database filename for SQLite
const DB_FILENAME = 'omnii-powersync.db';

// Singleton database instance
let dbInstance: PowerSyncDatabase | null = null;

/**
 * Get or create the PowerSync database instance.
 *
 * This creates a local SQLite database that PowerSync will sync
 * with the backend. The database persists across app restarts.
 *
 * Usage:
 * ```typescript
 * const db = await getPowerSync();
 * await db.init();
 * // Use db for queries
 * ```
 */
export const getPowerSync = (): PowerSyncDatabase => {
  if (dbInstance) {
    return dbInstance;
  }

  // Create database with OP-SQLite for best performance
  dbInstance = new PowerSyncDatabase({
    schema: AppSchema,
    database: new OPSqliteOpenFactory({
      dbFilename: DB_FILENAME,
    }),
  });

  return dbInstance;
};

/**
 * Reset the database instance (for logout/testing)
 */
export const resetPowerSync = async (): Promise<void> => {
  if (dbInstance) {
    await dbInstance.disconnectAndClear();
    dbInstance = null;
  }
};

/**
 * Check if database is initialized
 */
export const isPowerSyncReady = (): boolean => {
  return dbInstance !== null && dbInstance.connected;
};

// Re-export React hooks from @powersync/react
export {
  usePowerSync,
  usePowerSyncQuery,
  usePowerSyncWatchedQuery,
  usePowerSyncStatus,
  PowerSyncContext,
} from '@powersync/react';
```

2. Update `apps/omnii-mobile/metro.config.js` if needed to handle the native modules:

Check existing metro.config.js - if it doesn't have unstable_enablePackageExports, add it:

```javascript
// apps/omnii-mobile/metro.config.js
const { getDefaultConfig } = require('expo/metro-config');

const config = getDefaultConfig(__dirname);

// PowerSync requires package exports support
config.resolver.unstable_enablePackageExports = true;

module.exports = config;
```

Only add this if not already present. The existing config may already have this or similar settings.
  </action>
  <verify>
1. Import works: In a test file, `import { getPowerSync, AppSchema } from '~/lib/powersync'` compiles
2. Metro config has unstable_enablePackageExports: true
  </verify>
  <done>getPowerSync factory exported, AppSchema re-exported, metro.config.js updated</done>
</task>

<task type="auto">
  <name>Task 4: Verify development builds on iOS and Android</name>
  <files>apps/omnii-mobile/package.json</files>
  <action>
Verify that development builds with native PowerSync modules work on both platforms (MOBILE-01 cross-platform requirement).

1. Build and run iOS development build:

```bash
cd apps/omnii-mobile
npx expo run:ios --device simulator
```

Wait for the build to complete and app to launch in iOS Simulator.

2. Build and run Android development build:

```bash
cd apps/omnii-mobile
npx expo run:android --device emulator
```

Wait for the build to complete and app to launch in Android Emulator.

3. Verify both builds:
- App launches without crash
- No native module linking errors in console
- App navigates to main screen

If builds fail due to missing native dependencies, run:
```bash
npx expo prebuild --clean
```

Then retry the build commands.

Note: This task validates MOBILE-01 (cross-platform) requirement explicitly. Both iOS and Android must work with the native PowerSync modules installed.
  </action>
  <verify>
1. iOS Simulator: App launches, no native module errors
2. Android Emulator: App launches, no native module errors
3. Console shows no "Native module not found" errors
  </verify>
  <done>Development builds verified on both iOS Simulator and Android Emulator</done>
</task>

</tasks>

<verification>
1. package.json has @powersync/react-native, @powersync/op-sqlite, @powersync/react
2. Schema file has three tables matching backend: sync_entities, sync_events, sync_relationships
3. Index.ts exports getPowerSync, AppSchema, type helpers
4. TypeScript compiles without errors
5. Metro config supports package exports
6. iOS development build runs on Simulator
7. Android development build runs on Emulator
</verification>

<success_criteria>
- `pnpm install` succeeds with PowerSync packages
- PowerSync schema has tables: sync_entities, sync_events, sync_relationships
- Each table schema matches Supabase column definitions
- getPowerSync() returns PowerSyncDatabase instance
- Exports include AppSchema, type helpers, React hooks
- iOS Simulator runs the dev build without native module errors
- Android Emulator runs the dev build without native module errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-mobile-client-offline-sync/05-02-SUMMARY.md`
</output>
