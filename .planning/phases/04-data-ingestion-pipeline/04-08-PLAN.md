---
phase: 04-data-ingestion-pipeline
plan: 08
type: execute
wave: 6
depends_on: ["04-07"]
files_modified:
  - apps/omnii_mcp/src/ingestion/sources/google-calendar.ts
  - apps/omnii_mcp/src/ingestion/sources/google-gmail.ts
  - apps/omnii_mcp/src/ingestion/sources/google-tasks.ts
  - apps/omnii_mcp/src/ingestion/jobs/workers.ts
autonomous: false

must_haves:
  truths:
    - "Calendar events trigger entity extraction after insertion"
    - "Gmail messages trigger entity extraction after insertion"
    - "Tasks trigger entity extraction from title/notes after insertion"
    - "Extracted entities are linked to source event/email/task"
    - "Entity extraction uses existing relationship discovery service"
    - "Convenience functions forward extractEntities parameter to sync methods"
    - "Workers can control extraction via extractEntities flag (default: true)"
  artifacts:
    - path: "apps/omnii_mcp/src/ingestion/sources/google-calendar.ts"
      provides: "Calendar ingestion with entity extraction wiring"
      contains: "discoverRelationships"
    - path: "apps/omnii_mcp/src/ingestion/sources/google-gmail.ts"
      provides: "Gmail ingestion with entity extraction wiring"
      contains: "discoverRelationships"
    - path: "apps/omnii_mcp/src/ingestion/sources/google-tasks.ts"
      provides: "Tasks ingestion with entity extraction from title/notes"
      contains: "discoverRelationships"
    - path: "apps/omnii_mcp/src/ingestion/jobs/workers.ts"
      provides: "Workers with extractEntities parameter forwarding"
      contains: "extractEntities"
  key_links:
    - from: "apps/omnii_mcp/src/ingestion/sources/google-calendar.ts"
      to: "apps/omnii_mcp/src/services/graphrag/relationship-discovery.ts"
      via: "discoverRelationships import"
      pattern: "discoverRelationships"
    - from: "apps/omnii_mcp/src/ingestion/sources/google-tasks.ts"
      to: "apps/omnii_mcp/src/services/graphrag/relationship-discovery.ts"
      via: "discoverRelationships import"
      pattern: "discoverRelationships"
  notes:
    - "Contacts do NOT get entity extraction - contacts ARE entities (people/organizations), not content containing entities. Entity extraction is for extracting mentions from text content."
---

<objective>
Wire entity extraction into ingestion pipeline and verify full end-to-end flow

Purpose: Extract people, organizations, and concepts from ingested content to build rich relationship graphs automatically
Output: Ingestion services that create both raw data nodes AND extracted entity relationships
</objective>

<execution_context>
@/Users/santino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/santino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-data-ingestion-pipeline/04-RESEARCH.md
@.planning/phases/03-graphrag-advanced-mcp/03-04-SUMMARY.md
@apps/omnii_mcp/src/services/graphrag/relationship-discovery.ts
@apps/omnii_mcp/src/ingestion/sources/google-calendar.ts
@apps/omnii_mcp/src/ingestion/sources/google-gmail.ts
@apps/omnii_mcp/src/ingestion/sources/google-tasks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire entity extraction into Calendar ingestion</name>
  <files>apps/omnii_mcp/src/ingestion/sources/google-calendar.ts</files>
  <action>
Add entity extraction to Calendar ingestion for event titles and descriptions.

In `apps/omnii_mcp/src/ingestion/sources/google-calendar.ts`:

1. Add import for relationship discovery:
```typescript
import { discoverRelationships } from "../../services/graphrag/relationship-discovery";
```

2. Update the syncEvents method to optionally extract entities. Add parameter:
```typescript
async syncEvents(
  userId: string,
  client: Neo4jHTTPClient,
  forceFullSync: boolean = false,
  extractEntities: boolean = true // New parameter
): Promise<CalendarSyncResult>
```

3. Add entity extraction after event insertion. After the line that creates the event node, add:

```typescript
// Extract entities from event (title + description)
if (extractEntities && (event.summary || event.description)) {
  const textToAnalyze = [
    event.summary,
    event.description,
    // Include attendee names for context
    ...(event.attendees?.map(a => a.displayName).filter(Boolean) || []),
  ].filter(Boolean).join(". ");

  try {
    const extractionResult = await discoverRelationships(
      client,
      textToAnalyze,
      {
        sourceContext: `calendar_event:${event.id}`,
        userId,
      }
    );

    if (extractionResult.relationships.length > 0) {
      console.log(
        `Extracted ${extractionResult.entities.length} entities and ${extractionResult.relationships.length} relationships from event "${event.summary}"`
      );
    }
  } catch (extractError) {
    // Log but don't fail the sync for extraction errors
    console.warn(`Entity extraction failed for event ${event.id}:`, extractError);
  }
}
```

4. Update the CalendarSyncResult interface to include extraction stats:
```typescript
export interface CalendarSyncResult {
  success: boolean;
  eventsProcessed: number;
  eventsCreated: number;
  eventsSkipped: number;
  contactsCreated: number;
  entitiesExtracted: number; // New field
  relationshipsCreated: number; // New field
  errors: string[];
  nextSyncToken?: string;
}
```

5. Track extraction counts in the sync loop.

6. Update the convenience function to forward extractEntities:
```typescript
export async function ingestCalendarEvents(
  userId: string,
  client: Neo4jHTTPClient,
  forceFullSync: boolean = false,
  extractEntities: boolean = true // New parameter with default true
): Promise<CalendarSyncResult> {
  const service = getCalendarIngestionService();
  return service.syncEvents(userId, client, forceFullSync, extractEntities);
}
```
  </action>
  <verify>
File compiles: `cd apps/omnii_mcp && bunx tsc --noEmit src/ingestion/sources/google-calendar.ts`
Grep confirms discoverRelationships import.
Grep confirms ingestCalendarEvents accepts extractEntities parameter.
  </verify>
  <done>Calendar ingestion extracts entities from event titles and descriptions, convenience function forwards extractEntities</done>
</task>

<task type="auto">
  <name>Task 2: Wire entity extraction into Gmail and Tasks ingestion</name>
  <files>apps/omnii_mcp/src/ingestion/sources/google-gmail.ts, apps/omnii_mcp/src/ingestion/sources/google-tasks.ts</files>
  <action>
Add entity extraction to Gmail and Tasks ingestion services.

**1. Gmail (apps/omnii_mcp/src/ingestion/sources/google-gmail.ts):**

Add import for relationship discovery:
```typescript
import { discoverRelationships } from "../../services/graphrag/relationship-discovery";
```

Update syncMessages method signature:
```typescript
async syncMessages(
  userId: string,
  client: Neo4jHTTPClient,
  forceFullSync: boolean = false,
  extractEntities: boolean = true // New parameter
): Promise<GmailSyncResult>
```

Update GmailSyncResult interface:
```typescript
export interface GmailSyncResult {
  success: boolean;
  messagesProcessed: number;
  messagesCreated: number;
  messagesSkipped: number;
  contactsCreated: number;
  entitiesExtracted: number; // New field
  relationshipsCreated: number; // New field
  errors: string[];
  latestHistoryId?: string;
}
```

Add entity extraction after message insertion:

```typescript
// Extract entities from email (subject + snippet)
if (extractEntities) {
  const subject = message.payload?.headers?.find(
    (h) => h.name.toLowerCase() === "subject"
  )?.value || "";

  const textToAnalyze = [subject, message.snippet].filter(Boolean).join(". ");

  if (textToAnalyze.length > 20) { // Only analyze if there's meaningful content
    try {
      const extractionResult = await discoverRelationships(
        client,
        textToAnalyze,
        {
          sourceContext: `gmail_message:${message.id}`,
          userId,
        }
      );

      if (extractionResult.relationships.length > 0) {
        result.entitiesExtracted += extractionResult.entities.length;
        result.relationshipsCreated += extractionResult.relationships.length;
      }
    } catch (extractError) {
      console.warn(`Entity extraction failed for email ${message.id}:`, extractError);
    }
  }
}
```

Update the convenience function:
```typescript
export async function ingestGmail(
  userId: string,
  client: Neo4jHTTPClient,
  forceFullSync: boolean = false,
  extractEntities: boolean = true // New parameter with default true
): Promise<GmailSyncResult> {
  return getGmailIngestionService().syncMessages(userId, client, forceFullSync, extractEntities);
}
```

**2. Tasks (apps/omnii_mcp/src/ingestion/sources/google-tasks.ts):**

Add import for relationship discovery:
```typescript
import { discoverRelationships } from "../../services/graphrag/relationship-discovery";
```

Update syncTasks method signature:
```typescript
async syncTasks(
  userId: string,
  client: Neo4jHTTPClient,
  forceFullSync: boolean = false,
  extractEntities: boolean = true // New parameter
): Promise<TasksSyncResult>
```

Update TasksSyncResult interface:
```typescript
export interface TasksSyncResult {
  success: boolean;
  tasksProcessed: number;
  tasksCreated: number;
  tasksSkipped: number;
  entitiesExtracted: number; // New field
  relationshipsCreated: number; // New field
  errors: string[];
  nextUpdatedMin?: string;
}
```

Add entity extraction after task insertion (in upsertTaskNode or after the call):
```typescript
// Extract entities from task (title + notes)
if (extractEntities && (task.title || task.notes)) {
  const textToAnalyze = [task.title, task.notes].filter(Boolean).join(". ");

  if (textToAnalyze.length > 10) { // Only analyze if there's meaningful content
    try {
      const extractionResult = await discoverRelationships(
        client,
        textToAnalyze,
        {
          sourceContext: `google_task:${task.id}`,
          userId,
        }
      );

      if (extractionResult.relationships.length > 0) {
        result.entitiesExtracted += extractionResult.entities.length;
        result.relationshipsCreated += extractionResult.relationships.length;
        console.log(
          `Extracted ${extractionResult.entities.length} entities from task "${task.title}"`
        );
      }
    } catch (extractError) {
      console.warn(`Entity extraction failed for task ${task.id}:`, extractError);
    }
  }
}
```

Update the convenience function:
```typescript
export async function ingestTasks(
  userId: string,
  client: Neo4jHTTPClient,
  forceFullSync: boolean = false,
  extractEntities: boolean = true // New parameter with default true
): Promise<TasksSyncResult> {
  return getTasksIngestionService().syncTasks(userId, client, forceFullSync, extractEntities);
}
```

Note: Contacts (google-contacts.ts) do NOT need entity extraction. Contacts ARE entities - they represent people and organizations directly. Entity extraction is for extracting mentions of people/organizations from TEXT content (event descriptions, email subjects, task notes). The contacts themselves are already structured entity data.
  </action>
  <verify>
Gmail compiles: `cd apps/omnii_mcp && bunx tsc --noEmit src/ingestion/sources/google-gmail.ts`
Tasks compiles: `cd apps/omnii_mcp && bunx tsc --noEmit src/ingestion/sources/google-tasks.ts`
Grep confirms discoverRelationships import in both files.
Grep confirms ingestGmail and ingestTasks accept extractEntities parameter.
  </verify>
  <done>Gmail and Tasks ingestion extract entities, convenience functions forward extractEntities parameter</done>
</task>

<task type="auto">
  <name>Task 3: Update workers to pass extractEntities parameter</name>
  <files>apps/omnii_mcp/src/ingestion/jobs/workers.ts</files>
  <action>
Update the workers to pass extractEntities parameter through to ingestion functions.

In `apps/omnii_mcp/src/ingestion/jobs/workers.ts`:

1. Update SyncJobData interface (if not in sync-scheduler.ts, update both):
```typescript
export interface SyncJobData {
  source: SyncSource;
  userId?: string;
  extractEntities?: boolean; // New field, default true if not specified
}
```

2. Update the switch statement in processSyncJob to pass extractEntities:

```typescript
// Default extractEntities to true if not specified
const shouldExtractEntities = job.data.extractEntities ?? true;

switch (source) {
  case "google_calendar":
    result = await ingestCalendarEvents(userId, client, false, shouldExtractEntities);
    break;

  case "google_tasks": {
    const { ingestTasks } = await import("../sources/google-tasks");
    const taskResult = await ingestTasks(userId, client, false, shouldExtractEntities);
    result = {
      success: taskResult.success,
      eventsProcessed: taskResult.tasksProcessed,
      eventsCreated: taskResult.tasksCreated,
      eventsSkipped: taskResult.tasksSkipped,
      contactsCreated: 0,
      entitiesExtracted: taskResult.entitiesExtracted,
      relationshipsCreated: taskResult.relationshipsCreated,
      errors: taskResult.errors,
    };
    break;
  }

  case "google_gmail": {
    const { ingestGmail } = await import("../sources/google-gmail");
    const gmailResult = await ingestGmail(userId, client, false, shouldExtractEntities);
    result = {
      success: gmailResult.success,
      eventsProcessed: gmailResult.messagesProcessed,
      eventsCreated: gmailResult.messagesCreated,
      eventsSkipped: gmailResult.messagesSkipped,
      contactsCreated: gmailResult.contactsCreated,
      entitiesExtracted: gmailResult.entitiesExtracted,
      relationshipsCreated: gmailResult.relationshipsCreated,
      errors: gmailResult.errors,
    };
    break;
  }

  case "google_contacts": {
    // Contacts don't extract entities - they ARE entities
    const { ingestContacts } = await import("../sources/google-contacts");
    const contactResult = await ingestContacts(userId, client, false);
    result = {
      success: contactResult.success,
      eventsProcessed: contactResult.contactsProcessed,
      eventsCreated: contactResult.contactsCreated,
      eventsSkipped: contactResult.contactsSkipped,
      contactsCreated: 0,
      entitiesExtracted: 0,
      relationshipsCreated: 0,
      errors: contactResult.errors,
    };
    break;
  }

  default:
    throw new Error(`Unsupported sync source: ${source}`);
}
```

3. Update the CalendarSyncResult type used in workers to include new fields:
```typescript
// Result type that workers use (union of all sync results)
interface WorkerSyncResult {
  success: boolean;
  eventsProcessed: number;
  eventsCreated: number;
  eventsSkipped: number;
  contactsCreated: number;
  entitiesExtracted: number;
  relationshipsCreated: number;
  errors: string[];
}
```

4. Update the completion log to include extraction stats:
```typescript
console.log(
  `Sync complete for user ${userId}: ${result.eventsCreated} items, ` +
  `${result.contactsCreated} contacts, ${result.entitiesExtracted} entities extracted`
);
```
  </action>
  <verify>
Workers compile: `cd apps/omnii_mcp && bunx tsc --noEmit src/ingestion/jobs/workers.ts`
Grep confirms extractEntities is used in switch cases.
  </verify>
  <done>Workers pass extractEntities to all ingestion functions, default true for entity extraction</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify end-to-end ingestion pipeline</name>
  <what-built>
Complete data ingestion pipeline with:
1. Google OAuth connection via Composio
2. Incremental sync for all 4 services (Calendar, Tasks, Gmail, Contacts)
3. Quality gate validation before graph insertion
4. Entity extraction from Calendar events, Gmail messages, and Tasks (title/notes)
5. Background job scheduling with BullMQ
6. Rate limiting and jitter for API quota protection
7. extractEntities parameter propagation through convenience functions and workers

Note: Contacts do NOT have entity extraction - they ARE entities (people/organizations), not content containing entity mentions.
  </what-built>
  <how-to-verify>
**Prerequisites:**
1. Set COMPOSIO_API_KEY in .env
2. Set OMNII_REDIS_URL in .env (or have Redis running locally)
3. Have a test Google account to connect

**Test Steps:**

1. Start the MCP server:
   ```bash
   cd apps/omnii_mcp && bun run dev
   ```

2. Initiate Google Calendar OAuth connection:
   ```bash
   curl -X POST http://localhost:8081/api/ingestion/connect \
     -H "Content-Type: application/json" \
     -d '{"service": "calendar", "userId": "test-user-123"}'
   ```
   Expected: Returns redirectUrl for Google OAuth

3. After completing OAuth (manually visit the URL), check connection status:
   ```bash
   curl http://localhost:8081/api/ingestion/status/test-user-123
   ```
   Expected: Shows calendar as connected

4. Trigger manual calendar sync:
   ```bash
   curl -X POST http://localhost:8081/api/ingestion/sync/calendar \
     -H "Content-Type: application/json" \
     -d '{"userId": "test-user-123"}'
   ```
   Expected: Returns sync result with events processed/created AND entitiesExtracted count

5. Trigger manual tasks sync:
   ```bash
   curl -X POST http://localhost:8081/api/ingestion/sync/tasks \
     -H "Content-Type: application/json" \
     -d '{"userId": "test-user-123"}'
   ```
   Expected: Returns sync result with tasks processed/created AND entitiesExtracted count

6. Query the graph to verify events were created:
   ```bash
   curl http://localhost:8081/api/graph/events?userId=test-user-123
   ```
   Expected: Returns calendar events as Event nodes

7. Check for extracted entities (if events/tasks had meaningful content):
   - Look for Entity nodes with source="google_calendar" or "google_tasks"
   - Look for relationships created from entity extraction

**Success Indicators:**
- OAuth flow works end-to-end
- Calendar events appear in Neo4j as Event nodes
- Tasks appear with entity extraction from title/notes
- Contacts from event attendees created
- Entity extraction runs without errors
- Sync state tracks sync tokens
- entitiesExtracted and relationshipsCreated counts are returned in results
  </how-to-verify>
  <resume-signal>Type "approved" if pipeline works, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. Calendar ingestion includes entity extraction call and convenience function forwards extractEntities
2. Gmail ingestion includes entity extraction call and convenience function forwards extractEntities
3. Tasks ingestion includes entity extraction call and convenience function forwards extractEntities
4. Workers pass extractEntities parameter to all ingestion functions
5. All files compile without errors
6. Human verification confirms end-to-end flow works
</verification>

<success_criteria>
- Entity extraction wired into Calendar, Gmail, AND Tasks ingestion
- discoverRelationships called with appropriate source context
- Extraction errors logged but don't fail sync
- New result fields track extraction counts (entitiesExtracted, relationshipsCreated)
- Convenience functions (ingestCalendarEvents, ingestGmail, ingestTasks) accept and forward extractEntities parameter
- Workers pass extractEntities (defaulting to true) to all ingestion calls
- Contacts explicitly do NOT extract entities (documented in must_haves.notes)
- Human verifies OAuth -> Sync -> Graph insertion works
- Phase 4 requirements (INGEST-01 through INGEST-08) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-ingestion-pipeline/04-08-SUMMARY.md`
</output>
