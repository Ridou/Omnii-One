---
phase: 04-data-ingestion-pipeline
plan: 08
type: execute
wave: 6
depends_on: ["04-07"]
files_modified:
  - apps/omnii_mcp/src/ingestion/sources/google-calendar.ts
  - apps/omnii_mcp/src/ingestion/sources/google-gmail.ts
autonomous: false

must_haves:
  truths:
    - "Calendar events trigger entity extraction after insertion"
    - "Gmail messages trigger entity extraction after insertion"
    - "Extracted entities are linked to source event/email"
    - "Entity extraction uses existing relationship discovery service"
  artifacts:
    - path: "apps/omnii_mcp/src/ingestion/sources/google-calendar.ts"
      provides: "Calendar ingestion with entity extraction wiring"
      contains: "discoverRelationships"
    - path: "apps/omnii_mcp/src/ingestion/sources/google-gmail.ts"
      provides: "Gmail ingestion with entity extraction wiring"
      contains: "discoverRelationships"
  key_links:
    - from: "apps/omnii_mcp/src/ingestion/sources/google-calendar.ts"
      to: "apps/omnii_mcp/src/services/graphrag/relationship-discovery.ts"
      via: "discoverRelationships import"
      pattern: "discoverRelationships"
---

<objective>
Wire entity extraction into ingestion pipeline and verify full end-to-end flow

Purpose: Extract people, organizations, and concepts from ingested content to build rich relationship graphs automatically
Output: Ingestion services that create both raw data nodes AND extracted entity relationships
</objective>

<execution_context>
@/Users/santino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/santino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-data-ingestion-pipeline/04-RESEARCH.md
@.planning/phases/03-graphrag-advanced-mcp/03-04-SUMMARY.md
@apps/omnii_mcp/src/services/graphrag/relationship-discovery.ts
@apps/omnii_mcp/src/ingestion/sources/google-calendar.ts
@apps/omnii_mcp/src/ingestion/sources/google-gmail.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire entity extraction into Calendar ingestion</name>
  <files>apps/omnii_mcp/src/ingestion/sources/google-calendar.ts</files>
  <action>
Add entity extraction to Calendar ingestion for event titles and descriptions.

In `apps/omnii_mcp/src/ingestion/sources/google-calendar.ts`:

1. Add import for relationship discovery:
```typescript
import { discoverRelationships } from "../../services/graphrag/relationship-discovery";
```

2. Update the syncEvents method to optionally extract entities. Add parameter:
```typescript
async syncEvents(
  userId: string,
  client: Neo4jHTTPClient,
  forceFullSync: boolean = false,
  extractEntities: boolean = true // New parameter
): Promise<CalendarSyncResult>
```

3. Add entity extraction after event insertion. After the line that creates the event node, add:

```typescript
// Extract entities from event (title + description)
if (extractEntities && (event.summary || event.description)) {
  const textToAnalyze = [
    event.summary,
    event.description,
    // Include attendee names for context
    ...(event.attendees?.map(a => a.displayName).filter(Boolean) || []),
  ].filter(Boolean).join(". ");

  try {
    const extractionResult = await discoverRelationships(
      client,
      textToAnalyze,
      {
        sourceContext: `calendar_event:${event.id}`,
        userId,
      }
    );

    if (extractionResult.relationships.length > 0) {
      console.log(
        `Extracted ${extractionResult.entities.length} entities and ${extractionResult.relationships.length} relationships from event "${event.summary}"`
      );
    }
  } catch (extractError) {
    // Log but don't fail the sync for extraction errors
    console.warn(`Entity extraction failed for event ${event.id}:`, extractError);
  }
}
```

4. Update the CalendarSyncResult interface to include extraction stats:
```typescript
export interface CalendarSyncResult {
  success: boolean;
  eventsProcessed: number;
  eventsCreated: number;
  eventsSkipped: number;
  contactsCreated: number;
  entitiesExtracted: number; // New field
  relationshipsCreated: number; // New field
  errors: string[];
  nextSyncToken?: string;
}
```

5. Track extraction counts in the sync loop.
  </action>
  <verify>
File compiles: `cd apps/omnii_mcp && bunx tsc --noEmit src/ingestion/sources/google-calendar.ts`
Grep confirms discoverRelationships import.
  </verify>
  <done>Calendar ingestion extracts entities from event titles and descriptions</done>
</task>

<task type="auto">
  <name>Task 2: Wire entity extraction into Gmail ingestion</name>
  <files>apps/omnii_mcp/src/ingestion/sources/google-gmail.ts</files>
  <action>
Add entity extraction to Gmail ingestion for email content.

In `apps/omnii_mcp/src/ingestion/sources/google-gmail.ts`:

1. Add import for relationship discovery:
```typescript
import { discoverRelationships } from "../../services/graphrag/relationship-discovery";
```

2. Update syncMessages method signature:
```typescript
async syncMessages(
  userId: string,
  client: Neo4jHTTPClient,
  forceFullSync: boolean = false,
  extractEntities: boolean = true // New parameter
): Promise<GmailSyncResult>
```

3. Update GmailSyncResult interface:
```typescript
export interface GmailSyncResult {
  success: boolean;
  messagesProcessed: number;
  messagesCreated: number;
  messagesSkipped: number;
  contactsCreated: number;
  entitiesExtracted: number; // New field
  relationshipsCreated: number; // New field
  errors: string[];
  latestHistoryId?: string;
}
```

4. Add entity extraction after message insertion:

```typescript
// Extract entities from email (subject + snippet)
if (extractEntities) {
  const subject = message.payload?.headers?.find(
    (h) => h.name.toLowerCase() === "subject"
  )?.value || "";

  const textToAnalyze = [subject, message.snippet].filter(Boolean).join(". ");

  if (textToAnalyze.length > 20) { // Only analyze if there's meaningful content
    try {
      const extractionResult = await discoverRelationships(
        client,
        textToAnalyze,
        {
          sourceContext: `gmail_message:${message.id}`,
          userId,
        }
      );

      if (extractionResult.relationships.length > 0) {
        result.entitiesExtracted += extractionResult.entities.length;
        result.relationshipsCreated += extractionResult.relationships.length;
      }
    } catch (extractError) {
      console.warn(`Entity extraction failed for email ${message.id}:`, extractError);
    }
  }
}
```

5. Initialize the new counters in result object.
  </action>
  <verify>
File compiles: `cd apps/omnii_mcp && bunx tsc --noEmit src/ingestion/sources/google-gmail.ts`
Grep confirms discoverRelationships import.
  </verify>
  <done>Gmail ingestion extracts entities from email subjects and snippets</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify end-to-end ingestion pipeline</name>
  <what-built>
Complete data ingestion pipeline with:
1. Google OAuth connection via Composio
2. Incremental sync for all 4 services (Calendar, Tasks, Gmail, Contacts)
3. Quality gate validation before graph insertion
4. Entity extraction from Calendar events and Gmail messages
5. Background job scheduling with BullMQ
6. Rate limiting and jitter for API quota protection
  </what-built>
  <how-to-verify>
**Prerequisites:**
1. Set COMPOSIO_API_KEY in .env
2. Set OMNII_REDIS_URL in .env (or have Redis running locally)
3. Have a test Google account to connect

**Test Steps:**

1. Start the MCP server:
   ```bash
   cd apps/omnii_mcp && bun run dev
   ```

2. Initiate Google Calendar OAuth connection:
   ```bash
   curl -X POST http://localhost:8081/api/ingestion/connect \
     -H "Content-Type: application/json" \
     -d '{"service": "calendar", "userId": "test-user-123"}'
   ```
   Expected: Returns redirectUrl for Google OAuth

3. After completing OAuth (manually visit the URL), check connection status:
   ```bash
   curl http://localhost:8081/api/ingestion/status/test-user-123
   ```
   Expected: Shows calendar as connected

4. Trigger manual calendar sync:
   ```bash
   curl -X POST http://localhost:8081/api/ingestion/sync/calendar \
     -H "Content-Type: application/json" \
     -d '{"userId": "test-user-123"}'
   ```
   Expected: Returns sync result with events processed/created

5. Query the graph to verify events were created:
   ```bash
   curl http://localhost:8081/api/graph/events?userId=test-user-123
   ```
   Expected: Returns calendar events as Event nodes

6. Check for extracted entities (if events had meaningful content):
   - Look for Entity nodes with source="google_calendar"
   - Look for relationships created from entity extraction

**Success Indicators:**
- OAuth flow works end-to-end
- Calendar events appear in Neo4j as Event nodes
- Contacts from event attendees created
- Entity extraction runs without errors
- Sync state tracks sync tokens
  </how-to-verify>
  <resume-signal>Type "approved" if pipeline works, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. Calendar ingestion includes entity extraction call
2. Gmail ingestion includes entity extraction call
3. Both files compile without errors
4. Human verification confirms end-to-end flow works
</verification>

<success_criteria>
- Entity extraction wired into Calendar and Gmail ingestion
- discoverRelationships called with appropriate source context
- Extraction errors logged but don't fail sync
- New result fields track extraction counts
- Human verifies OAuth -> Sync -> Graph insertion works
- Phase 4 requirements (INGEST-01 through INGEST-08) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-ingestion-pipeline/04-08-SUMMARY.md`
</output>
