---
phase: 04-data-ingestion-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/omnii_mcp/src/ingestion/composio-client.ts
  - apps/omnii_mcp/src/ingestion/jobs/queue.ts
  - apps/omnii_mcp/src/ingestion/index.ts
  - apps/omnii_mcp/package.json
autonomous: true

user_setup:
  - service: composio
    why: "Google OAuth abstraction for Calendar/Tasks/Gmail/Contacts"
    env_vars:
      - name: COMPOSIO_API_KEY
        source: "Composio Dashboard -> Settings -> API Keys"

must_haves:
  truths:
    - "BullMQ queue can be instantiated with Redis connection"
    - "Composio client singleton is reusable across services"
    - "bullmq and exponential-backoff packages are installed"
  artifacts:
    - path: "apps/omnii_mcp/src/ingestion/composio-client.ts"
      provides: "Singleton Composio client with API key from env"
      exports: ["getComposioClient", "ComposioClient"]
    - path: "apps/omnii_mcp/src/ingestion/jobs/queue.ts"
      provides: "BullMQ queue and Redis connection factory"
      exports: ["createIngestionQueue", "getRedisConnection"]
    - path: "apps/omnii_mcp/src/ingestion/index.ts"
      provides: "Barrel export for ingestion module"
  key_links:
    - from: "apps/omnii_mcp/src/ingestion/composio-client.ts"
      to: "process.env.COMPOSIO_API_KEY"
      via: "env variable access"
      pattern: "COMPOSIO_API_KEY"
    - from: "apps/omnii_mcp/src/ingestion/jobs/queue.ts"
      to: "process.env.OMNII_REDIS_URL"
      via: "Redis connection string"
      pattern: "OMNII_REDIS_URL"
---

<objective>
Set up ingestion infrastructure: Composio client singleton and BullMQ job queue with Redis

Purpose: Foundation layer for all data ingestion - OAuth (Composio), background jobs (BullMQ), rate limiting (exponential-backoff)
Output: Reusable ingestion infrastructure with zero external dependencies on other Phase 4 work
</objective>

<execution_context>
@/Users/santino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/santino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-data-ingestion-pipeline/04-RESEARCH.md
@apps/omnii_mcp/src/config/env.ts
@apps/omnii_mcp/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install BullMQ and exponential-backoff dependencies</name>
  <files>apps/omnii_mcp/package.json</files>
  <action>
Install required packages for background job processing and retry logic:

```bash
cd apps/omnii_mcp && pnpm add bullmq exponential-backoff
```

BullMQ requires Redis which is already available via ioredis (installed in package.json).

Do NOT add @composio/core - the project already has composio-core installed.
  </action>
  <verify>
Run `pnpm list bullmq exponential-backoff` in apps/omnii_mcp to confirm packages installed.
Check package.json contains both dependencies.
  </verify>
  <done>bullmq and exponential-backoff appear in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create Composio client singleton</name>
  <files>apps/omnii_mcp/src/ingestion/composio-client.ts</files>
  <action>
Create a singleton Composio client that:

1. Imports from `composio-core` (not @composio/core - check existing imports in codebase)
2. Reads COMPOSIO_API_KEY from environment
3. Provides lazy initialization (only create client on first use)
4. Exports both the getter function and the client type

Pattern from research:
```typescript
import { Composio } from "composio-core";

let _client: Composio | null = null;

export function getComposioClient(): Composio {
  if (!_client) {
    const apiKey = process.env.COMPOSIO_API_KEY;
    if (!apiKey) {
      throw new Error("COMPOSIO_API_KEY not set in environment");
    }
    _client = new Composio({ apiKey });
  }
  return _client;
}

export type ComposioClient = Composio;
```

Check existing usage in `apps/omnii_mcp/src/services/plugins/calendar-plugin.ts` to match import style.
  </action>
  <verify>
File exists at apps/omnii_mcp/src/ingestion/composio-client.ts.
TypeScript compiles without errors: `cd apps/omnii_mcp && bunx tsc --noEmit src/ingestion/composio-client.ts`
  </verify>
  <done>Composio client singleton exports getComposioClient() and ComposioClient type</done>
</task>

<task type="auto">
  <name>Task 3: Create BullMQ queue factory with Redis connection</name>
  <files>apps/omnii_mcp/src/ingestion/jobs/queue.ts, apps/omnii_mcp/src/ingestion/index.ts</files>
  <action>
Create BullMQ queue factory for ingestion jobs:

1. Create `apps/omnii_mcp/src/ingestion/jobs/queue.ts`:
   - Use ioredis (already installed) for Redis connection
   - Read OMNII_REDIS_URL from environment (fallback to localhost:6379)
   - Export `getRedisConnection()` - returns shared Redis instance
   - Export `createIngestionQueue(name: string)` - creates named BullMQ queue

Pattern from research:
```typescript
import { Queue } from "bullmq";
import Redis from "ioredis";

let _redis: Redis | null = null;

export function getRedisConnection(): Redis {
  if (!_redis) {
    const redisUrl = process.env.OMNII_REDIS_URL || "redis://localhost:6379";
    _redis = new Redis(redisUrl, {
      maxRetriesPerRequest: null, // Required for BullMQ
    });
  }
  return _redis;
}

export function createIngestionQueue(name: string): Queue {
  return new Queue(name, {
    connection: getRedisConnection(),
    defaultJobOptions: {
      attempts: 3,
      backoff: {
        type: "exponential",
        delay: 1000,
      },
      removeOnComplete: 100, // Keep last 100 completed jobs
      removeOnFail: 500, // Keep last 500 failed jobs for debugging
    },
  });
}
```

2. Create `apps/omnii_mcp/src/ingestion/index.ts` barrel export:
```typescript
export { getComposioClient, type ComposioClient } from "./composio-client";
export { getRedisConnection, createIngestionQueue } from "./jobs/queue";
```
  </action>
  <verify>
Both files exist.
TypeScript compiles: `cd apps/omnii_mcp && bunx tsc --noEmit src/ingestion/index.ts`
  </verify>
  <done>BullMQ queue factory exports getRedisConnection() and createIngestionQueue(), barrel export aggregates ingestion module</done>
</task>

</tasks>

<verification>
1. Package check: `cd apps/omnii_mcp && pnpm list bullmq exponential-backoff`
2. TypeScript check: `cd apps/omnii_mcp && bunx tsc --noEmit src/ingestion/index.ts`
3. Import test: Create temporary test file that imports from ingestion module
</verification>

<success_criteria>
- bullmq and exponential-backoff installed in apps/omnii_mcp
- Composio client singleton created with lazy initialization
- BullMQ queue factory with Redis connection
- All files type-check without errors
- Barrel export aggregates all ingestion infrastructure
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-ingestion-pipeline/04-01-SUMMARY.md`
</output>
