---
phase: 02-graph-core-mcp-server
plan: 06
type: execute
wave: 5
depends_on: ["02-01", "02-02", "02-05"]
files_modified:
  - apps/omnii_mcp/src/routes/webhooks/auth.ts
  - apps/omnii_mcp/scripts/setup-user-schema.ts
autonomous: true

must_haves:
  truths:
    - "New user databases get schema constraints automatically"
    - "New user databases get vector index automatically"
    - "Schema setup runs after database provisioning completes"
    - "Schema setup errors are logged but don't fail provisioning"
  artifacts:
    - path: "apps/omnii_mcp/scripts/setup-user-schema.ts"
      provides: "Standalone schema setup script for manual runs"
      exports: ["setupUserSchema"]
  key_links:
    - from: "apps/omnii_mcp/src/routes/webhooks/auth.ts"
      to: "apps/omnii_mcp/src/graph/schema/constraints.ts"
      via: "setupSchemaConstraints()"
      pattern: "setupSchemaConstraints"
    - from: "apps/omnii_mcp/src/routes/webhooks/auth.ts"
      to: "apps/omnii_mcp/src/graph/schema/vector-index.ts"
      via: "createVectorIndex()"
      pattern: "createVectorIndex"
---

<objective>
Wire graph schema setup into user database provisioning flow.

Purpose: When a new user signs up and their Neo4j database becomes ready, automatically apply schema constraints and create the vector index. This ensures every user database is query-ready.

Output: Updated provisioning webhook that triggers schema setup, plus a standalone script for manual schema setup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-graph-core-mcp-server/02-RESEARCH.md

# From prior plans
@apps/omnii_mcp/src/graph/schema/constraints.ts
@apps/omnii_mcp/src/graph/schema/vector-index.ts
@apps/omnii_mcp/src/routes/webhooks/auth.ts
@apps/omnii_mcp/src/services/neo4j/provisioning.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create schema setup module</name>
  <files>apps/omnii_mcp/scripts/setup-user-schema.ts</files>
  <action>
Create a reusable schema setup function and CLI script:

1. Create `apps/omnii_mcp/scripts/setup-user-schema.ts`:

```typescript
#!/usr/bin/env bun
/**
 * User Schema Setup Script
 *
 * Sets up graph schema (constraints + vector index) for a user's database.
 * Can be run standalone for manual setup or imported for programmatic use.
 *
 * Usage:
 *   bun scripts/setup-user-schema.ts <userId>
 */

import { createClientForUser } from '../src/services/neo4j/http-client';
import { setupSchemaConstraints, checkConstraints } from '../src/graph/schema/constraints';
import { createVectorIndex, checkVectorIndex, VECTOR_INDEX_NAME } from '../src/graph/schema/vector-index';

export interface SchemaSetupResult {
  success: boolean;
  constraints: {
    created: number;
    existing: string[];
    errors: string[];
  };
  vectorIndex: {
    created: boolean;
    name: string;
    error?: string;
  };
}

/**
 * Set up graph schema for a user's database
 */
export async function setupUserSchema(userId: string): Promise<SchemaSetupResult> {
  console.log(`[Schema] Setting up schema for user: ${userId}`);

  const result: SchemaSetupResult = {
    success: false,
    constraints: { created: 0, existing: [], errors: [] },
    vectorIndex: { created: false, name: VECTOR_INDEX_NAME }
  };

  try {
    // Get user's database client
    const client = await createClientForUser(userId);

    // Step 1: Set up constraints
    console.log('[Schema] Creating constraints...');
    try {
      const constraintResult = await setupSchemaConstraints(client);
      result.constraints.created = constraintResult.constraintsCreated;

      // Check what constraints exist now
      const existing = await checkConstraints(client);
      result.constraints.existing = existing.map((c: any) => c.name);
      console.log(`[Schema] Constraints created: ${result.constraints.created}, total: ${result.constraints.existing.length}`);
    } catch (error) {
      const message = error instanceof Error ? error.message : 'Unknown error';
      console.error('[Schema] Constraint error:', message);
      result.constraints.errors.push(message);
    }

    // Step 2: Create vector index
    console.log('[Schema] Creating vector index...');
    try {
      await createVectorIndex(client);
      result.vectorIndex.created = true;

      // Verify index exists
      const indexStatus = await checkVectorIndex(client);
      console.log(`[Schema] Vector index status:`, indexStatus);
    } catch (error) {
      const message = error instanceof Error ? error.message : 'Unknown error';
      console.error('[Schema] Vector index error:', message);
      result.vectorIndex.error = message;
    }

    // Success if at least constraints worked (vector index can fail on free tier)
    result.success = result.constraints.errors.length === 0;

    return result;
  } catch (error) {
    console.error('[Schema] Setup failed:', error);
    throw error;
  }
}

// CLI runner
if (import.meta.main) {
  const userId = process.argv[2];

  if (!userId) {
    console.error('Usage: bun scripts/setup-user-schema.ts <userId>');
    process.exit(1);
  }

  setupUserSchema(userId)
    .then((result) => {
      console.log('\n[Schema] Setup complete:');
      console.log(JSON.stringify(result, null, 2));
      process.exit(result.success ? 0 : 1);
    })
    .catch((error) => {
      console.error('\n[Schema] Setup failed:', error);
      process.exit(1);
    });
}
```

Make the script executable and add to package.json:
```bash
chmod +x apps/omnii_mcp/scripts/setup-user-schema.ts
```

Add script to package.json:
```json
"scripts": {
  "setup-schema": "bun scripts/setup-user-schema.ts"
}
```
  </action>
  <verify>
TypeScript compilation:
```bash
cd apps/omnii_mcp && npx tsc --noEmit scripts/setup-user-schema.ts
```

Check script exists and is importable:
```bash
cd apps/omnii_mcp && bun -e "import { setupUserSchema } from './scripts/setup-user-schema'; console.log('Schema setup module loaded:', typeof setupUserSchema);"
```
  </verify>
  <done>
Schema setup module exists with setupUserSchema function. Can be run as CLI script or imported programmatically.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire schema setup into provisioning webhook</name>
  <files>apps/omnii_mcp/src/routes/webhooks/auth.ts</files>
  <action>
Update the auth webhook to trigger schema setup after database provisioning:

1. Read the current `apps/omnii_mcp/src/routes/webhooks/auth.ts`

2. Find the `pollForDatabaseReady` function or wherever the database status is updated to 'ready'

3. Add schema setup trigger after database becomes ready:

Import the setup function:
```typescript
import { setupUserSchema } from '../../scripts/setup-user-schema';
```

In the polling success handler (when status becomes 'ready'), add:
```typescript
// After updating status to 'ready':
// Trigger schema setup in background (don't block the polling response)
setupUserSchema(userId)
  .then((result) => {
    if (result.success) {
      console.log(`[Webhook] Schema setup complete for user ${userId}`);
    } else {
      console.warn(`[Webhook] Schema setup had issues for user ${userId}:`, result);
    }
  })
  .catch((error) => {
    // Log but don't fail - schema can be set up manually if needed
    console.error(`[Webhook] Schema setup failed for user ${userId}:`, error);
  });
```

The key is:
- Schema setup runs in background (Promise without await)
- Errors are logged but don't fail the provisioning
- User can start using their database even if schema setup is delayed

4. Add a manual schema setup endpoint for admin/debugging:
```typescript
// Add to auth webhooks routes
app.post('/setup-schema/:userId', async ({ params, headers }) => {
  // Basic admin check (you could add proper admin auth)
  const adminKey = headers['x-admin-key'];
  if (adminKey !== process.env.ADMIN_KEY) {
    return { error: 'Unauthorized' };
  }

  const result = await setupUserSchema(params.userId);
  return result;
});
```
  </action>
  <verify>
TypeScript compilation:
```bash
cd apps/omnii_mcp && npx tsc --noEmit src/routes/webhooks/auth.ts
```

Check import exists:
```bash
cd apps/omnii_mcp && grep "setupUserSchema" src/routes/webhooks/auth.ts
```
  </verify>
  <done>
Auth webhook triggers schema setup when user database becomes ready. Errors logged but don't block provisioning. Manual setup endpoint available for admin use.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add schema status to health check</name>
  <files>apps/omnii_mcp/src/mcp/transport.ts</files>
  <action>
Enhance the MCP health check to report schema status:

1. Update the health check endpoint in `apps/omnii_mcp/src/mcp/transport.ts`:

Add a parameter to optionally check a user's schema status:

```typescript
// Update the health check route
app.get('/health', async ({ query, headers }) => {
  const { isInitialized } = getMCPServer();

  const baseHealth = {
    status: 'ok',
    initialized: isInitialized(),
    server: SERVER_INFO.name,
    version: SERVER_INFO.version,
    tools: TOOL_DEFINITIONS.length
  };

  // If userId provided (for debugging), check their schema
  const userId = query.userId as string | undefined;
  if (userId) {
    try {
      const client = await createClientForUser(userId);
      const constraints = await checkConstraints(client);
      const vectorIndex = await checkVectorIndex(client);

      return {
        ...baseHealth,
        userSchema: {
          userId,
          constraintCount: constraints.length,
          vectorIndex: vectorIndex
        }
      };
    } catch (error) {
      return {
        ...baseHealth,
        userSchema: {
          userId,
          error: error instanceof Error ? error.message : 'Unknown error'
        }
      };
    }
  }

  return baseHealth;
});
```

Add necessary imports:
```typescript
import { checkConstraints } from '../graph/schema/constraints';
import { checkVectorIndex } from '../graph/schema/vector-index';
```
  </action>
  <verify>
TypeScript compilation:
```bash
cd apps/omnii_mcp && npx tsc --noEmit src/mcp/transport.ts
```

Check imports added:
```bash
cd apps/omnii_mcp && grep "checkConstraints\|checkVectorIndex" src/mcp/transport.ts
```
  </verify>
  <done>
MCP health check can report schema status for a specific user when userId query param provided. Useful for debugging and verification.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Full compilation:
```bash
cd apps/omnii_mcp && npx tsc --noEmit
```

2. Check script exists:
```bash
ls -la apps/omnii_mcp/scripts/setup-user-schema.ts
```

3. Verify webhook has schema setup:
```bash
cd apps/omnii_mcp && grep -n "setupUserSchema" src/routes/webhooks/auth.ts
```

4. Verify health check has schema status:
```bash
cd apps/omnii_mcp && grep -n "checkConstraints\|checkVectorIndex" src/mcp/transport.ts
```
</verification>

<success_criteria>
- setupUserSchema function creates constraints and vector index
- Auth webhook triggers schema setup when database becomes ready
- Schema setup errors are logged but don't fail provisioning
- Manual schema setup endpoint exists for admin use
- MCP health check can report schema status for debugging
- Standalone CLI script can set up schema for any user
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-graph-core-mcp-server/02-06-SUMMARY.md`
</output>
