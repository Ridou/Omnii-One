---
phase: 02-graph-core-mcp-server
plan: 07
type: execute
wave: 6
depends_on: ["02-05", "02-06"]
files_modified:
  - docs/mcp-integration.md
  - apps/omnii_mcp/.env.example
autonomous: false

must_haves:
  truths:
    - "Claude Desktop can connect to MCP server"
    - "MCP tools execute successfully via Claude Desktop"
    - "User sees search results from their graph"
  artifacts:
    - path: "docs/mcp-integration.md"
      provides: "Claude Desktop integration guide"
      contains: "claude_desktop_config.json"
  key_links:
    - from: "Claude Desktop config"
      to: "/mcp endpoint"
      via: "HTTP transport"
      pattern: "localhost.*mcp"

user_setup:
  - service: "Claude Desktop"
    why: "MCP client for testing integration"
    dashboard_config:
      - task: "Add server to claude_desktop_config.json"
        location: "~/Library/Application Support/Claude/claude_desktop_config.json (macOS)"
---

<objective>
Test MCP server integration with Claude Desktop and create documentation.

Purpose: Validate that the complete MCP stack works end-to-end with a real AI client. Document the integration process for future reference.

Output: Working Claude Desktop integration, tested tools, and integration guide.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-graph-core-mcp-server/02-RESEARCH.md

# From prior plans
@apps/omnii_mcp/src/mcp/transport.ts
@apps/omnii_mcp/src/mcp/tools/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update environment example and start server</name>
  <files>apps/omnii_mcp/.env.example</files>
  <action>
Ensure .env.example has all required variables documented:

1. Update `apps/omnii_mcp/.env.example` to include all Phase 2 requirements:

```bash
# === Shared Infrastructure (OMNII_* namespace) ===

# Supabase (required for auth)
OMNII_SUPABASE_URL=https://your-project.supabase.co
OMNII_SUPABASE_ANON_KEY=your-anon-key
OMNII_SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Neo4j Aura (required for database provisioning)
OMNII_NEO4J_AURA_API_TOKEN=your-aura-api-token
OMNII_NEO4J_AURA_TENANT_ID=your-tenant-id

# OpenAI (required for embeddings)
OMNII_OPENAI_API_KEY=sk-your-openai-key

# Redis (optional - for distributed rate limiting in production)
# OMNII_REDIS_URL=redis://localhost:6379

# === MCP App-Specific ===
MCP_BASE_URL=http://localhost:8081
MCP_PORT=8081

# === Legacy Neo4j (optional - for local development without Aura) ===
# NEO4J_URI=neo4j+s://your-instance.neo4j.io
# NEO4J_USER=neo4j
# NEO4J_PASSWORD=your-password
# NEO4J_DATABASE=neo4j

# === Admin (optional) ===
# ADMIN_KEY=your-secret-admin-key

# === Environment ===
NODE_ENV=development
```

2. Verify server starts with required env vars:
```bash
cd apps/omnii_mcp && bun run dev
```

Note: Server will fail on missing env vars - that's expected. The goal is to verify the code loads.
  </action>
  <verify>
Check .env.example has all required vars:
```bash
cd apps/omnii_mcp && grep -E "OMNII_|MCP_" .env.example | wc -l
```
Should show at least 8 environment variables documented.

Check server can at least parse (will fail on env validation, that's OK):
```bash
cd apps/omnii_mcp && bun -e "import './src/mcp'" 2>&1 | head -5
```
  </verify>
  <done>
Environment example updated with all Phase 2 variables. Server code loads (actual startup requires real env vars).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Claude Desktop integration guide</name>
  <files>docs/mcp-integration.md</files>
  <action>
Create documentation for Claude Desktop integration:

1. Create `docs/mcp-integration.md`:

```markdown
# MCP Server Integration Guide

This guide explains how to connect AI assistants to the Omnii Graph MCP server.

## Prerequisites

- Omnii MCP server running (`bun run dev` in apps/omnii_mcp)
- Valid Supabase account with auth configured
- User account created and database provisioned

## Claude Desktop Integration

### Step 1: Configure Claude Desktop

1. Open Claude Desktop settings
2. Navigate to Developer settings
3. Edit the MCP servers configuration file:

**macOS:** `~/Library/Application Support/Claude/claude_desktop_config.json`
**Windows:** `%APPDATA%\Claude\claude_desktop_config.json`

Add the Omnii server configuration:

```json
{
  "mcpServers": {
    "omnii-graph": {
      "type": "http",
      "url": "http://localhost:8081/mcp",
      "headers": {
        "Authorization": "Bearer YOUR_SUPABASE_JWT_TOKEN"
      }
    }
  }
}
```

### Step 2: Get Your Auth Token

1. Log into your Omnii account via the mobile app or web interface
2. Use the browser developer tools to find the JWT token
3. Or use the Supabase dashboard to generate a token for testing

### Step 3: Restart Claude Desktop

After saving the configuration, restart Claude Desktop for the changes to take effect.

### Step 4: Verify Connection

Ask Claude:
> "Can you list my entities using the omnii graph tools?"

Claude should call the `omnii_graph_list_entities` tool and return results.

## Available Tools

### omnii_graph_search_nodes

Search the knowledge graph using semantic similarity.

**Parameters:**
- `query` (required): Natural language search query
- `limit` (optional): Max results (1-50, default 10)
- `nodeTypes` (optional): Filter by node type (Concept, Entity, Event, Contact)
- `minScore` (optional): Minimum similarity score (0-1, default 0.7)

**Example prompt:**
> "Search my graph for anything related to project deadlines"

### omnii_graph_get_context

Get detailed information about a specific node and its relationships.

**Parameters:**
- `nodeId` (required): UUID of the node
- `includeRelated` (optional): Include related nodes (default true)
- `maxDepth` (optional): Relationship depth 1-3 (default 1)

**Example prompt:**
> "Get the context for node [UUID from search results]"

### omnii_graph_list_entities

List nodes by type with pagination.

**Parameters:**
- `nodeType` (required): Concept, Entity, Event, or Contact
- `limit` (optional): Max results (1-100, default 20)
- `offset` (optional): Skip N results for pagination

**Example prompt:**
> "List my recent contacts from the graph"

## Troubleshooting

### "Tool not found" Error

- Check Claude Desktop logs for connection issues
- Verify the server URL is correct
- Ensure the server is running

### "Authentication failed" Error

- Verify your JWT token is valid and not expired
- Check the Authorization header format (must be "Bearer TOKEN")
- Try generating a fresh token from Supabase

### "Database not ready" Error

- Your user database is still provisioning
- Check provisioning status via the admin endpoint
- Wait a few minutes and try again

### No Results from Search

- Verify your database has data (use list_entities first)
- Check the vector index is created (use /mcp/health?userId=YOUR_ID)
- Lower the minScore parameter

## Rate Limits

- 100 requests per minute per user
- Rate limit headers included in responses
- 429 error returned when limit exceeded

## Security Notes

- Never commit your JWT token to version control
- Tokens expire - refresh periodically
- Each user has isolated database access
```
  </action>
  <verify>
Check documentation exists:
```bash
ls -la docs/mcp-integration.md
cat docs/mcp-integration.md | head -20
```
  </verify>
  <done>
Claude Desktop integration guide created with configuration instructions, tool documentation, and troubleshooting tips.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Claude Desktop Integration</name>
  <what-built>
Complete MCP server with:
- Graph schema (Concept, Entity, Event, Contact nodes)
- CRUD operations for graph manipulation
- Vector index for semantic search
- Three MCP tools (search_nodes, get_context, list_entities)
- Authentication via Supabase JWT
- Rate limiting (100 req/min per user)
- Claude Desktop integration documentation
  </what-built>
  <how-to-verify>
1. **Start the server:**
   ```bash
   cd apps/omnii_mcp && bun run dev
   ```
   Verify it starts without errors and shows "MCP routes created"

2. **Test the health endpoint:**
   ```bash
   curl http://localhost:8081/mcp/health
   ```
   Should return JSON with status: "ok" and tools: 3

3. **Configure Claude Desktop** (follow docs/mcp-integration.md):
   - Add server to claude_desktop_config.json
   - Add your Supabase JWT token
   - Restart Claude Desktop

4. **Test tool discovery in Claude:**
   Ask Claude: "What MCP tools do you have available from omnii?"
   Should list the three omnii_graph_* tools

5. **Test a tool call:**
   Ask Claude: "List my contacts using the omnii graph"
   Should either return contacts or "no data" (if database empty)

6. **Verify auth works:**
   Remove the Authorization header and try again
   Should get "Authentication failed" error

Report any issues encountered.
  </how-to-verify>
  <resume-signal>
Type "approved" if Claude Desktop successfully connects and can call tools.
Or describe any issues for debugging.
  </resume-signal>
</task>

</tasks>

<verification>
Phase 2 verification (all success criteria from roadmap):

1. Graph schema supports concepts, entities, events, and contacts with proper relationships
   - Check: NodeLabel enum exists with all four types
   - Check: RelationshipType enum exists with semantic types

2. Basic CRUD operations work for creating, reading, updating, and deleting nodes and relationships
   - Check: crud.ts exports createNode, getNode, updateNode, deleteNode, createRelationship

3. Vector index configured for semantic search on entity embeddings
   - Check: vector-index.ts creates HNSW index with 1536 dimensions

4. MCP server exposes working tools for basic graph queries
   - Check: TOOL_DEFINITIONS has 3 tools
   - Check: tools/list returns valid JSON-RPC response

5. Claude Desktop can connect to MCP server and execute graph query tools successfully
   - Check: Human verification in Task 3

6. MCP requests are authenticated and rate-limited to prevent abuse
   - Check: 401 returned for missing/invalid token
   - Check: Rate limit headers present
</verification>

<success_criteria>
- Environment example documents all required variables
- Integration guide provides clear Claude Desktop setup instructions
- Server starts and responds to health checks
- Claude Desktop connects and lists available tools
- At least one tool call executes successfully
- Unauthenticated requests properly rejected
</success_criteria>

<output>
After completion, create `.planning/phases/02-graph-core-mcp-server/02-07-SUMMARY.md`
</output>
