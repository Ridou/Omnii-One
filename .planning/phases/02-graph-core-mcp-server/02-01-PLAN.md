---
phase: 02-graph-core-mcp-server
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/omnii_mcp/src/graph/schema/nodes.ts
  - apps/omnii_mcp/src/graph/schema/relationships.ts
  - apps/omnii_mcp/src/graph/operations/crud.ts
  - apps/omnii_mcp/src/graph/index.ts
autonomous: true

must_haves:
  truths:
    - "Graph nodes can be created with proper labels (Concept, Entity, Event, Contact)"
    - "Relationships can be created between nodes"
    - "Nodes can be read, updated, and deleted"
    - "All operations use user-isolated database via createClientForUser"
  artifacts:
    - path: "apps/omnii_mcp/src/graph/schema/nodes.ts"
      provides: "Node label constants and property interfaces"
      exports: ["NodeLabel", "ConceptNode", "EntityNode", "EventNode", "ContactNode", "BaseNodeProperties"]
    - path: "apps/omnii_mcp/src/graph/schema/relationships.ts"
      provides: "Relationship type constants"
      exports: ["RelationshipType"]
    - path: "apps/omnii_mcp/src/graph/operations/crud.ts"
      provides: "CRUD operations for graph nodes"
      exports: ["createNode", "getNode", "updateNode", "deleteNode", "createRelationship"]
  key_links:
    - from: "apps/omnii_mcp/src/graph/operations/crud.ts"
      to: "apps/omnii_mcp/src/services/neo4j/http-client.ts"
      via: "Neo4jHTTPClient.query()"
      pattern: "client\\.query"
---

<objective>
Implement graph schema definition and basic CRUD operations for the Omnii knowledge graph.

Purpose: Establish the data model foundation that all MCP tools will operate on. Without defined node labels and CRUD operations, MCP tools cannot interact with user data.

Output: Graph schema constants, TypeScript interfaces for node types, and CRUD operations module that uses the existing Neo4jHTTPClient.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-graph-core-mcp-server/02-RESEARCH.md

# Existing code to build upon
@apps/omnii_mcp/src/services/neo4j/http-client.ts
@apps/omnii_mcp/src/types/neo4j.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define graph schema constants and interfaces</name>
  <files>
    apps/omnii_mcp/src/graph/schema/nodes.ts
    apps/omnii_mcp/src/graph/schema/relationships.ts
  </files>
  <action>
Create the graph directory structure and schema definitions:

1. Create `apps/omnii_mcp/src/graph/schema/nodes.ts`:
   - Define NodeLabel enum: Concept, Entity, Event, Contact
   - Define BaseNodeProperties interface with common fields:
     - id: string (UUID)
     - name: string
     - createdAt: string (ISO datetime)
     - updatedAt?: string (ISO datetime)
     - embedding?: number[] (for vector search - 1536 dimensions for OpenAI ada-002)
   - Define specific interfaces for each node type:
     - ConceptNode: BaseNodeProperties + { description?: string, category?: string }
     - EntityNode: BaseNodeProperties + { type: string (person/organization/place/thing), properties?: Record<string, unknown> }
     - EventNode: BaseNodeProperties + { startTime: string, endTime?: string, location?: string, description?: string }
     - ContactNode: BaseNodeProperties + { email?: string, phone?: string, organization?: string }

2. Create `apps/omnii_mcp/src/graph/schema/relationships.ts`:
   - Define RelationshipType enum with semantic types (SCREAMING_SNAKE_CASE per Neo4j convention):
     - MENTIONED_IN (entity mentioned in event/concept)
     - ATTENDED_BY (event attended by contact)
     - RELATED_TO (generic relationship between concepts)
     - OCCURRED_AT (event occurred at location entity)
     - KNOWS (contact knows another contact)
     - WORKS_AT (contact works at organization entity)
     - CREATED_BY (entity/concept created by contact)
   - Define RelationshipProperties interface with optional weight and metadata

Follow TypeScript strict mode. Export all types for use by CRUD operations.
  </action>
  <verify>
Run TypeScript compilation check:
```bash
cd apps/omnii_mcp && npx tsc --noEmit src/graph/schema/nodes.ts src/graph/schema/relationships.ts
```
Should complete with no type errors.
  </verify>
  <done>
Node labels enum, relationship types enum, and TypeScript interfaces exist. All types properly exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement CRUD operations module</name>
  <files>
    apps/omnii_mcp/src/graph/operations/crud.ts
    apps/omnii_mcp/src/graph/index.ts
  </files>
  <action>
Create CRUD operations that use the existing Neo4jHTTPClient:

1. Create `apps/omnii_mcp/src/graph/operations/crud.ts`:

   Import Neo4jHTTPClient from services/neo4j/http-client.
   Import node/relationship types from schema.

   Implement these functions (all take client: Neo4jHTTPClient as first param):

   **createNode<T extends BaseNodeProperties>(client, label: NodeLabel, properties: Omit<T, 'id' | 'createdAt'>)**
   - Generate UUID for id using crypto.randomUUID()
   - Add createdAt: new Date().toISOString()
   - Use CREATE (not MERGE) to create new node
   - Return created node

   **getNode(client, id: string)**
   - MATCH by id property
   - Return node with all properties and labels, or null if not found

   **getNodesByLabel(client, label: NodeLabel, limit?: number)**
   - MATCH all nodes with given label
   - ORDER BY createdAt DESC
   - LIMIT with default of 100
   - Return array of nodes

   **updateNode(client, id: string, updates: Partial<BaseNodeProperties>)**
   - MATCH by id
   - SET properties using += operator (preserves existing)
   - Always add updatedAt: new Date().toISOString()
   - Return updated node or null if not found

   **deleteNode(client, id: string)**
   - MATCH by id
   - Use DETACH DELETE to remove node and all relationships
   - Return boolean success

   **createRelationship(client, fromId: string, toId: string, type: RelationshipType, properties?: RelationshipProperties)**
   - MERGE nodes by id first (they must exist)
   - MERGE relationship (idempotent - won't create duplicates)
   - Set relationship properties if provided
   - Return success boolean

   Use parameterized queries for all operations (prevent injection).
   Handle HTTP client errors gracefully - let them propagate with context.

2. Create `apps/omnii_mcp/src/graph/index.ts`:
   - Export all from schema/nodes
   - Export all from schema/relationships
   - Export all from operations/crud
  </action>
  <verify>
Run TypeScript compilation and a simple unit test:
```bash
cd apps/omnii_mcp && npx tsc --noEmit src/graph/index.ts
```

Verify exports are correct:
```bash
cd apps/omnii_mcp && bun -e "import * as graph from './src/graph'; console.log(Object.keys(graph));"
```
Should list: NodeLabel, RelationshipType, createNode, getNode, updateNode, deleteNode, etc.
  </verify>
  <done>
CRUD operations implemented with proper error handling. All functions use Neo4jHTTPClient. Index file exports all graph module contents.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add database constraints for data integrity</name>
  <files>apps/omnii_mcp/src/graph/schema/constraints.ts</files>
  <action>
Create schema constraints that should be run once per user database:

1. Create `apps/omnii_mcp/src/graph/schema/constraints.ts`:

   Define async function `setupSchemaConstraints(client: Neo4jHTTPClient)`:

   Create uniqueness constraints for node IDs:
   ```cypher
   CREATE CONSTRAINT concept_id IF NOT EXISTS FOR (n:Concept) REQUIRE n.id IS UNIQUE
   CREATE CONSTRAINT entity_id IF NOT EXISTS FOR (n:Entity) REQUIRE n.id IS UNIQUE
   CREATE CONSTRAINT event_id IF NOT EXISTS FOR (n:Event) REQUIRE n.id IS UNIQUE
   CREATE CONSTRAINT contact_id IF NOT EXISTS FOR (n:Contact) REQUIRE n.id IS UNIQUE
   ```

   Create existence constraints for required properties:
   ```cypher
   CREATE CONSTRAINT concept_name IF NOT EXISTS FOR (n:Concept) REQUIRE n.name IS NOT NULL
   CREATE CONSTRAINT entity_name IF NOT EXISTS FOR (n:Entity) REQUIRE n.name IS NOT NULL
   CREATE CONSTRAINT event_name IF NOT EXISTS FOR (n:Event) REQUIRE n.name IS NOT NULL
   CREATE CONSTRAINT contact_name IF NOT EXISTS FOR (n:Contact) REQUIRE n.name IS NOT NULL
   ```

   Execute each constraint in sequence (Neo4j requires separate statements).
   Return { success: boolean, constraintsCreated: number }.

   Add `checkConstraints(client: Neo4jHTTPClient)` function:
   - Run `SHOW CONSTRAINTS` query
   - Return list of existing constraints for verification

   Export both functions.

2. Update `apps/omnii_mcp/src/graph/index.ts`:
   - Add export for constraints module
  </action>
  <verify>
TypeScript compilation:
```bash
cd apps/omnii_mcp && npx tsc --noEmit src/graph/schema/constraints.ts
```

Verify function exports:
```bash
cd apps/omnii_mcp && bun -e "import { setupSchemaConstraints, checkConstraints } from './src/graph'; console.log('Constraints module loaded');"
```
  </verify>
  <done>
Schema constraints module exists. setupSchemaConstraints function creates all uniqueness and existence constraints. checkConstraints function can verify constraint state.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Full module compilation:
```bash
cd apps/omnii_mcp && npx tsc --noEmit src/graph/index.ts
```

2. Verify all exports:
```bash
cd apps/omnii_mcp && bun -e "
import * as graph from './src/graph';
const expected = ['NodeLabel', 'RelationshipType', 'createNode', 'getNode', 'getNodesByLabel', 'updateNode', 'deleteNode', 'createRelationship', 'setupSchemaConstraints', 'checkConstraints'];
const missing = expected.filter(e => !(e in graph));
if (missing.length) { console.error('Missing exports:', missing); process.exit(1); }
console.log('All exports present');
"
```

3. Directory structure check:
```bash
ls -la apps/omnii_mcp/src/graph/
ls -la apps/omnii_mcp/src/graph/schema/
ls -la apps/omnii_mcp/src/graph/operations/
```
</verification>

<success_criteria>
- Graph schema directory structure exists at apps/omnii_mcp/src/graph/
- NodeLabel enum defines Concept, Entity, Event, Contact
- RelationshipType enum defines semantic relationship types
- TypeScript interfaces exist for each node type with proper properties
- CRUD operations use Neo4jHTTPClient and parameterized queries
- Constraints module can set up uniqueness and existence constraints
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-graph-core-mcp-server/02-01-SUMMARY.md`
</output>
