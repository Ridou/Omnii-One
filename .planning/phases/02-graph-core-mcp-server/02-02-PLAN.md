---
phase: 02-graph-core-mcp-server
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/omnii_mcp/src/graph/schema/vector-index.ts
  - apps/omnii_mcp/src/graph/operations/search.ts
  - apps/omnii_mcp/src/graph/operations/embeddings.ts
  - apps/omnii_mcp/src/graph/index.ts
autonomous: true

must_haves:
  truths:
    - "Vector index exists on Entity nodes for semantic search"
    - "Nodes can be searched by semantic similarity using embeddings"
    - "Embeddings are generated via OpenAI ada-002 API"
    - "Search results include similarity scores"
  artifacts:
    - path: "apps/omnii_mcp/src/graph/schema/vector-index.ts"
      provides: "Vector index setup for semantic search"
      exports: ["createVectorIndex", "checkVectorIndex", "VECTOR_INDEX_NAME", "VECTOR_DIMENSIONS"]
    - path: "apps/omnii_mcp/src/graph/operations/embeddings.ts"
      provides: "OpenAI embedding generation"
      exports: ["generateEmbedding", "generateEmbeddings"]
    - path: "apps/omnii_mcp/src/graph/operations/search.ts"
      provides: "Vector similarity search operations"
      exports: ["searchByEmbedding", "searchByText"]
  key_links:
    - from: "apps/omnii_mcp/src/graph/operations/search.ts"
      to: "apps/omnii_mcp/src/graph/operations/embeddings.ts"
      via: "generateEmbedding() call"
      pattern: "generateEmbedding"
    - from: "apps/omnii_mcp/src/graph/operations/search.ts"
      to: "apps/omnii_mcp/src/services/neo4j/http-client.ts"
      via: "db.index.vector.queryNodes"
      pattern: "vector\\.queryNodes"
---

<objective>
Implement vector index configuration and semantic search operations for the graph.

Purpose: Enable MCP tools to search user data by meaning rather than exact keywords. This is the foundation for the search_nodes MCP tool.

Output: Vector index setup functions, embedding generation module, and semantic search operations that return ranked results.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-graph-core-mcp-server/02-RESEARCH.md

# From prior plan
@apps/omnii_mcp/src/graph/schema/nodes.ts
@apps/omnii_mcp/src/graph/operations/crud.ts

# Existing config
@apps/omnii_mcp/src/config/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create vector index configuration</name>
  <files>apps/omnii_mcp/src/graph/schema/vector-index.ts</files>
  <action>
Create vector index setup for Neo4j semantic search:

1. Create `apps/omnii_mcp/src/graph/schema/vector-index.ts`:

Define constants:
```typescript
export const VECTOR_INDEX_NAME = 'entity_embeddings';
export const VECTOR_DIMENSIONS = 1536; // OpenAI ada-002
export const VECTOR_SIMILARITY = 'cosine';
```

Implement `createVectorIndex(client: Neo4jHTTPClient)`:
- Create VECTOR INDEX on Entity nodes
- Use embedding property
- Configure with HNSW algorithm, cosine similarity, 1536 dimensions
- Enable quantization for performance

Cypher:
```cypher
CREATE VECTOR INDEX entity_embeddings IF NOT EXISTS
FOR (n:Entity)
ON n.embedding
OPTIONS {
  indexConfig: {
    `vector.dimensions`: 1536,
    `vector.similarity_function`: 'cosine',
    `vector.quantization.enabled`: true
  }
}
```

Implement `checkVectorIndex(client: Neo4jHTTPClient)`:
- Run `SHOW INDEXES` query
- Filter for vector indexes
- Return index status (name, state, populationPercent)

Implement `dropVectorIndex(client: Neo4jHTTPClient)`:
- DROP INDEX IF EXISTS for testing/reset scenarios
- Return boolean success

All functions should handle errors gracefully and provide meaningful error messages.
  </action>
  <verify>
TypeScript compilation:
```bash
cd apps/omnii_mcp && npx tsc --noEmit src/graph/schema/vector-index.ts
```

Check exports:
```bash
cd apps/omnii_mcp && bun -e "import { createVectorIndex, VECTOR_DIMENSIONS } from './src/graph/schema/vector-index'; console.log('Dimensions:', VECTOR_DIMENSIONS);"
```
Should output: Dimensions: 1536
  </verify>
  <done>
Vector index configuration module exists with createVectorIndex, checkVectorIndex, dropVectorIndex functions and constants.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement embedding generation</name>
  <files>apps/omnii_mcp/src/graph/operations/embeddings.ts</files>
  <action>
Create OpenAI embedding generation module:

1. Create `apps/omnii_mcp/src/graph/operations/embeddings.ts`:

Import OpenAI from the existing openai package.
Import VECTOR_DIMENSIONS from schema/vector-index.

Create OpenAI client using OMNII_OPENAI_API_KEY from env:
```typescript
import { env } from '../../config/env';
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: env.OMNII_OPENAI_API_KEY
});
```

Implement `generateEmbedding(text: string): Promise<number[]>`:
- Use text-embedding-ada-002 model
- Call openai.embeddings.create()
- Extract embedding from response.data[0].embedding
- Validate embedding length === VECTOR_DIMENSIONS
- Throw descriptive error if validation fails

Implement `generateEmbeddings(texts: string[]): Promise<number[][]>`:
- Batch embedding generation for efficiency
- Use same model
- Return embeddings in same order as input texts
- Validate each embedding length

Add rate limit handling:
- Catch rate limit errors (status 429)
- Implement exponential backoff (1s, 2s, 4s, max 3 retries)
- Re-throw after max retries

Export both functions.
  </action>
  <verify>
TypeScript compilation:
```bash
cd apps/omnii_mcp && npx tsc --noEmit src/graph/operations/embeddings.ts
```

Verify import structure (won't call API without key):
```bash
cd apps/omnii_mcp && bun -e "import { generateEmbedding, generateEmbeddings } from './src/graph/operations/embeddings'; console.log('Embeddings module loaded');" 2>&1 || echo "Expected to fail without env - structure ok if import error not shown"
```
  </verify>
  <done>
Embedding generation module exists. generateEmbedding and generateEmbeddings functions implemented with OpenAI ada-002. Rate limiting with exponential backoff included.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement semantic search operations</name>
  <files>
    apps/omnii_mcp/src/graph/operations/search.ts
    apps/omnii_mcp/src/graph/index.ts
  </files>
  <action>
Create semantic search operations:

1. Create `apps/omnii_mcp/src/graph/operations/search.ts`:

Import Neo4jHTTPClient, NodeLabel, generateEmbedding, VECTOR_INDEX_NAME.

Define SearchResult interface:
```typescript
export interface SearchResult {
  id: string;
  name: string;
  labels: string[];
  score: number;
  properties: Record<string, unknown>;
}
```

Implement `searchByEmbedding(client, embedding: number[], options?)`:
- Options: { limit?: number, nodeTypes?: NodeLabel[], minScore?: number }
- Default limit: 10, minScore: 0.7
- Use db.index.vector.queryNodes Cypher procedure:
```cypher
CALL db.index.vector.queryNodes($indexName, $k, $queryVector)
YIELD node, score
WHERE score >= $minScore
RETURN node.id as id, node.name as name, labels(node) as labels, score, properties(node) as properties
ORDER BY score DESC
```
- If nodeTypes specified, add WHERE filter on labels
- Return SearchResult[]

Implement `searchByText(client, query: string, options?)`:
- Generate embedding from query text using generateEmbedding()
- Call searchByEmbedding with the embedding
- This is the primary interface MCP tools will use

Implement `findRelatedNodes(client, nodeId: string, options?)`:
- Options: { maxDepth?: number, limit?: number }
- Traverse relationships from given node
- Use variable-length path pattern: (n)-[*1..maxDepth]-(related)
- Return connected nodes with relationship paths

2. Update `apps/omnii_mcp/src/graph/index.ts`:
- Add exports from schema/vector-index
- Add exports from operations/embeddings
- Add exports from operations/search
  </action>
  <verify>
TypeScript compilation:
```bash
cd apps/omnii_mcp && npx tsc --noEmit src/graph/operations/search.ts
```

Verify full module exports:
```bash
cd apps/omnii_mcp && bun -e "
import * as graph from './src/graph';
const searchExports = ['searchByEmbedding', 'searchByText', 'findRelatedNodes', 'generateEmbedding', 'createVectorIndex'];
const missing = searchExports.filter(e => !(e in graph));
if (missing.length) { console.error('Missing:', missing); process.exit(1); }
console.log('Search exports present');
" 2>&1 || echo "May fail on env - check for import errors only"
```
  </verify>
  <done>
Semantic search module exists. searchByText provides natural language search. searchByEmbedding provides direct vector search. findRelatedNodes enables graph traversal. All functions exported from graph index.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Full module compilation:
```bash
cd apps/omnii_mcp && npx tsc --noEmit src/graph/index.ts
```

2. Directory structure:
```bash
ls -la apps/omnii_mcp/src/graph/schema/
ls -la apps/omnii_mcp/src/graph/operations/
```
Should show: vector-index.ts in schema/, embeddings.ts and search.ts in operations/

3. Export verification:
```bash
cd apps/omnii_mcp && bun -e "
import { VECTOR_DIMENSIONS, VECTOR_INDEX_NAME } from './src/graph/schema/vector-index';
console.log('Index name:', VECTOR_INDEX_NAME);
console.log('Dimensions:', VECTOR_DIMENSIONS);
"
```
</verification>

<success_criteria>
- Vector index configuration defines 1536 dimensions for OpenAI ada-002
- createVectorIndex function generates correct Cypher for HNSW index
- generateEmbedding calls OpenAI API with proper error handling
- searchByText combines embedding generation and vector search
- searchByEmbedding uses db.index.vector.queryNodes procedure
- findRelatedNodes enables graph traversal from any node
- All modules compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-graph-core-mcp-server/02-02-SUMMARY.md`
</output>
