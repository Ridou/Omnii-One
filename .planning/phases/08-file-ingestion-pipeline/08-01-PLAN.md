---
phase: 08-file-ingestion-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/omnii_mcp/package.json
  - apps/omnii_mcp/src/graph/schema/nodes.ts
  - apps/omnii_mcp/src/ingestion/sources/files/types.ts
autonomous: true

must_haves:
  truths:
    - "Document and Chunk node types are defined in graph schema"
    - "File parsing libraries are installed and importable"
    - "File ingestion type definitions exist for parsers and workers"
  artifacts:
    - path: "apps/omnii_mcp/src/graph/schema/nodes.ts"
      provides: "Document, Chunk node interfaces and labels"
      contains: "DocumentNode"
    - path: "apps/omnii_mcp/src/ingestion/sources/files/types.ts"
      provides: "ParseResult, ChunkConfig, QualityMetrics interfaces"
      exports: ["ParseResult", "ChunkConfig", "QualityMetrics"]
  key_links:
    - from: "apps/omnii_mcp/src/ingestion/sources/files/types.ts"
      to: "apps/omnii_mcp/src/graph/schema/nodes.ts"
      via: "imports DocumentNode, ChunkNode types"
      pattern: "import.*from.*graph/schema/nodes"
---

<objective>
Install file parsing dependencies and extend graph schema with Document/Chunk node types.

Purpose: Establish foundation types and libraries before building parsers and workers.
Output: Extended node schema with Document/Chunk types, installed parsing libraries, file ingestion type definitions.
</objective>

<execution_context>
@/Users/santino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/santino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-file-ingestion-pipeline/08-RESEARCH.md

@apps/omnii_mcp/package.json
@apps/omnii_mcp/src/graph/schema/nodes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install file parsing dependencies</name>
  <files>apps/omnii_mcp/package.json</files>
  <action>
Install the following dependencies in apps/omnii_mcp:

Production dependencies:
- unpdf (^1.4.0) - PDF text extraction, serverless-optimized
- mammoth (^1.8.0) - Word .docx parsing
- markdown-it (^14.1.0) - Markdown parsing
- file-type (^19.6.0) - MIME detection via magic numbers (security-critical)
- @langchain/textsplitters (latest) - Semantic chunking
- @langchain/core (latest) - Required peer dependency

Run from apps/omnii_mcp directory:
```
bun add unpdf mammoth markdown-it file-type @langchain/textsplitters @langchain/core
```

Do NOT install tree-sitter yet (code parsing is optional for FILE-03 MVP, can add later).
  </action>
  <verify>
Run `bun install` in apps/omnii_mcp, then verify imports work:
```typescript
// Test in Bun REPL or temp file
import { extractText } from 'unpdf';
import mammoth from 'mammoth';
import MarkdownIt from 'markdown-it';
import { fileTypeFromBuffer } from 'file-type';
import { RecursiveCharacterTextSplitter } from '@langchain/textsplitters';
```
All imports should resolve without error.
  </verify>
  <done>
Dependencies added to package.json, lockfile updated, imports resolve successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend graph schema with Document and Chunk node types</name>
  <files>apps/omnii_mcp/src/graph/schema/nodes.ts</files>
  <action>
Extend the existing nodes.ts file with Document and Chunk node types.

1. Add to NodeLabel enum:
```typescript
/** Uploaded files with extracted content */
Document = 'Document',
/** Text segments of documents for RAG retrieval */
Chunk = 'Chunk',
```

2. Add DocumentNode interface:
```typescript
/**
 * Document node - uploaded files with extracted content.
 * Examples: "quarterly_report.pdf", "meeting_notes.docx"
 */
export interface DocumentNode extends BaseNodeProperties {
  /** Original filename as uploaded */
  originalName: string;
  /** File type: pdf, docx, txt, md, code */
  fileType: 'pdf' | 'docx' | 'txt' | 'md' | 'code';
  /** MIME type detected from file content */
  mimeType: string;
  /** SHA-256 hash of file content for deduplication */
  fileHash: string;
  /** Path in Supabase Storage */
  storagePath: string;
  /** File size in bytes */
  size: number;
  /** Extraction confidence score (0-1) */
  extractionConfidence: number;
  /** Whether extraction needs human review */
  needsReview: boolean;
  /** ISO 8601 datetime when file was uploaded */
  uploadedAt: string;
  /** Number of chunks created from this document */
  chunkCount?: number;
}
```

3. Add ChunkNode interface:
```typescript
/**
 * Chunk node - text segment from a document for RAG retrieval.
 * Related to parent Document via HAS_CHUNK relationship.
 */
export interface ChunkNode extends BaseNodeProperties {
  /** Text content of this chunk */
  text: string;
  /** Position in document (0-indexed) */
  position: number;
  /** Parent document ID */
  documentId: string;
}
```

4. Update AnyNode union type to include DocumentNode and ChunkNode.

5. Add type guards:
```typescript
export function isDocumentNode(node: AnyNode): node is DocumentNode {
  return 'fileHash' in node && 'storagePath' in node;
}

export function isChunkNode(node: AnyNode): node is ChunkNode {
  return 'position' in node && 'documentId' in node && 'text' in node;
}
```
  </action>
  <verify>
TypeScript compiles without errors:
```
cd apps/omnii_mcp && bun build src/graph/schema/nodes.ts --outdir /tmp --target node
```
  </verify>
  <done>
nodes.ts contains DocumentNode, ChunkNode interfaces and type guards, compiles successfully.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create file ingestion type definitions</name>
  <files>apps/omnii_mcp/src/ingestion/sources/files/types.ts</files>
  <action>
Create the directory and types file for file ingestion:

```
mkdir -p apps/omnii_mcp/src/ingestion/sources/files
```

Create types.ts with:

```typescript
/**
 * File Ingestion Type Definitions
 *
 * Types for file parsing, chunking, and quality scoring.
 */

import type { DocumentNode, ChunkNode } from '../../../graph/schema/nodes';

/**
 * Supported file types for ingestion
 */
export type SupportedFileType = 'pdf' | 'docx' | 'txt' | 'md' | 'code';

/**
 * MIME types we accept (verified via magic numbers, not extension)
 */
export const SUPPORTED_MIME_TYPES: Record<string, SupportedFileType> = {
  'application/pdf': 'pdf',
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx',
  'text/plain': 'txt',
  'text/markdown': 'md',
  // Code files detected as text/plain, but we check extension for code-specific handling
};

/**
 * File extensions for code files (when MIME is text/plain)
 */
export const CODE_EXTENSIONS = [
  '.js', '.ts', '.jsx', '.tsx', '.py', '.rb', '.go', '.rs',
  '.java', '.kt', '.swift', '.c', '.cpp', '.h', '.cs',
  '.php', '.sh', '.bash', '.zsh', '.yaml', '.yml', '.json',
  '.html', '.css', '.scss', '.sql', '.graphql',
];

/**
 * Result from parsing a file
 */
export interface ParseResult {
  /** Extracted text content */
  text: string;
  /** Parser-specific metadata */
  metadata: {
    /** Total pages (PDF only) */
    totalPages?: number;
    /** Parser warnings */
    warnings?: string[];
    /** File format */
    format: string;
  };
  /** Initial confidence from parser (0-1) */
  confidence: number;
}

/**
 * Configuration for chunking strategy
 */
export interface ChunkConfig {
  /** Maximum characters per chunk */
  chunkSize: number;
  /** Overlap between adjacent chunks */
  chunkOverlap: number;
  /** Separators for splitting (ordered by priority) */
  separators: string[];
}

/**
 * Recommended chunk configs by file type
 */
export const CHUNK_CONFIGS: Record<SupportedFileType, ChunkConfig> = {
  pdf: { chunkSize: 512, chunkOverlap: 100, separators: ['\n\n', '\n', '. ', ' ', ''] },
  docx: { chunkSize: 512, chunkOverlap: 100, separators: ['\n\n', '\n', '. ', ' ', ''] },
  txt: { chunkSize: 400, chunkOverlap: 80, separators: ['\n\n', '\n', '. ', ' ', ''] },
  md: { chunkSize: 512, chunkOverlap: 100, separators: ['\n\n', '\n', '. ', ' ', ''] },
  code: { chunkSize: 800, chunkOverlap: 200, separators: ['\n\nfunction ', '\n\nclass ', '\n\n', '\n'] },
};

/**
 * Quality metrics for extraction validation
 */
export interface QualityMetrics {
  /** Overall confidence score (0-1) */
  confidence: number;
  /** Estimated text completeness (0-1) */
  completeness: number;
  /** Warning messages */
  warnings: string[];
  /** Whether extraction needs human review (confidence < 0.8) */
  needsReview: boolean;
}

/**
 * File processing job data for BullMQ
 */
export interface FileProcessingJobData {
  /** User ID who uploaded the file */
  userId: string;
  /** Path in Supabase Storage */
  storagePath: string;
  /** Detected file type */
  fileType: SupportedFileType;
  /** Original filename */
  originalName: string;
  /** SHA-256 hash for deduplication */
  fileHash: string;
  /** File size in bytes */
  fileSize: number;
  /** MIME type */
  mimeType: string;
}

/**
 * Result from file processing worker
 */
export interface FileProcessingResult {
  /** Processing succeeded */
  success: boolean;
  /** Document node ID created */
  documentId?: string;
  /** Number of chunks created */
  chunksCreated?: number;
  /** Extraction quality metrics */
  quality?: QualityMetrics;
  /** Error message if failed */
  error?: string;
}

/**
 * File upload response (immediate, before processing)
 */
export interface FileUploadResponse {
  /** Processing status */
  status: 'processing' | 'duplicate' | 'error';
  /** File hash (ID for tracking) */
  fileHash: string;
  /** Message for client */
  message: string;
  /** Existing document ID if duplicate */
  existingDocumentId?: string;
}

// Re-export node types for convenience
export type { DocumentNode, ChunkNode };
```
  </action>
  <verify>
TypeScript compiles:
```
cd apps/omnii_mcp && bun build src/ingestion/sources/files/types.ts --outdir /tmp --target node
```
  </verify>
  <done>
types.ts exists with all interfaces, compiles successfully, exports ParseResult, ChunkConfig, QualityMetrics.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `bun install` in apps/omnii_mcp succeeds
2. File parsing libraries importable without errors
3. TypeScript compilation succeeds for nodes.ts and types.ts
4. DocumentNode, ChunkNode types exported from nodes.ts
5. File ingestion types exported from files/types.ts
</verification>

<success_criteria>
- unpdf, mammoth, markdown-it, file-type, @langchain/textsplitters installed
- DocumentNode and ChunkNode interfaces defined in graph schema
- File ingestion type definitions created with ParseResult, ChunkConfig, QualityMetrics
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-file-ingestion-pipeline/08-01-SUMMARY.md`
</output>
