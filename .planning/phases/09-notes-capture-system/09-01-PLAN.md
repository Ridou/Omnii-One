---
phase: 09-notes-capture-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/omnii_mcp/package.json
  - apps/omnii_mcp/src/graph/schema/nodes.ts
  - apps/omnii_mcp/src/notes/types.ts
autonomous: true

must_haves:
  truths:
    - "Note node type exists in graph schema"
    - "Wikilink parsing dependencies installed"
    - "Note type definitions ready for parser implementation"
  artifacts:
    - path: "apps/omnii_mcp/src/graph/schema/nodes.ts"
      provides: "NoteNode interface with title, content, normalizedTitle"
      contains: "Note = 'Note'"
    - path: "apps/omnii_mcp/src/notes/types.ts"
      provides: "Type definitions for notes, wikilinks, templates"
      exports: ["NoteInput", "WikilinkMatch", "NoteTemplate"]
  key_links:
    - from: "apps/omnii_mcp/src/notes/types.ts"
      to: "apps/omnii_mcp/src/graph/schema/nodes.ts"
      via: "imports NoteNode interface"
      pattern: "import.*NoteNode.*from.*schema/nodes"
---

<objective>
Install note parsing dependencies and extend graph schema with Note node type for wiki-style linking

Purpose: Establishes foundation for bidirectional note linking by adding Note as a first-class graph citizen with normalized titles for wikilink matching
Output: Graph schema with NoteNode, type definitions for notes/templates/wikilinks, installed markdown-it-wikilinks and gray-matter libraries
</objective>

<execution_context>
@/Users/santino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/santino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-notes-capture-system/09-RESEARCH.md
@apps/omnii_mcp/src/graph/schema/nodes.ts
@apps/omnii_mcp/src/ingestion/sources/files/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install note parsing dependencies</name>
  <files>apps/omnii_mcp/package.json</files>
  <action>
Install note parsing libraries in omnii_mcp workspace:

```bash
cd apps/omnii_mcp && bun add markdown-it-wikilinks gray-matter compromise nanoid date-fns
```

Dependencies and their purposes:
- markdown-it-wikilinks: Parse `[[wikilinks]]` syntax in markdown (battle-tested in PKM apps)
- gray-matter: YAML frontmatter parsing for note templates
- compromise: Lightweight NLP for entity extraction (1MB/sec processing)
- nanoid: Generate human-readable note IDs like `note_abc123def456`
- date-fns: Date formatting for daily journal templates

Note: markdown-it is already installed from Phase 8 file ingestion.
  </action>
  <verify>Run `bun install` from monorepo root to update lockfile. Verify with `grep -E "markdown-it-wikilinks|gray-matter|compromise|nanoid|date-fns" apps/omnii_mcp/package.json` shows all 5 dependencies.</verify>
  <done>package.json contains markdown-it-wikilinks, gray-matter, compromise, nanoid, and date-fns dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Extend graph schema with Note node type</name>
  <files>apps/omnii_mcp/src/graph/schema/nodes.ts</files>
  <action>
Add Note to NodeLabel enum and create NoteNode interface following established pattern from DocumentNode.

1. Add `Note = 'Note'` to NodeLabel enum after Chunk

2. Create NoteNode interface extending BaseNodeProperties:
```typescript
/**
 * Note node - user-created notes with wiki-style linking.
 * Examples: "Meeting with John", "Daily Journal - 2026-01-29"
 */
export interface NoteNode extends BaseNodeProperties {
  /** Note title as entered by user */
  title: string;
  /** Normalized title for wikilink matching (lowercase, hyphens for spaces) */
  normalizedTitle: string;
  /** Markdown content of the note */
  content: string;
  /** YAML frontmatter as JSON string (from templates) */
  frontmatter?: string;
  /** Template type used to create this note (if from template) */
  templateType?: 'meeting-notes' | 'daily-journal' | 'contact-notes' | null;
  /** Whether this is a stub created from a forward wikilink reference */
  isStub: boolean;
  /** How the note was created */
  createdVia: 'manual' | 'voice' | 'template' | 'wikilink-stub';
  /** Number of outgoing wikilinks in this note */
  linkCount?: number;
  /** Number of incoming backlinks to this note */
  backlinkCount?: number;
}
```

3. Update AnyNode union type to include NoteNode

4. Add isNoteNode type guard:
```typescript
/**
 * Type guard to check if a node is a NoteNode
 */
export function isNoteNode(node: AnyNode): node is NoteNode {
  return 'normalizedTitle' in node && 'content' in node && 'isStub' in node;
}
```
  </action>
  <verify>Run `bun typecheck --filter omnii_mcp` to verify no TypeScript errors. Check that NoteNode is exported and appears in AnyNode union.</verify>
  <done>NodeLabel includes Note, NoteNode interface defined with title/normalizedTitle/content/isStub/createdVia properties, isNoteNode type guard exists, AnyNode includes NoteNode</done>
</task>

<task type="auto">
  <name>Task 3: Create note type definitions module</name>
  <files>apps/omnii_mcp/src/notes/types.ts</files>
  <action>
Create new notes module with comprehensive type definitions.

Create `apps/omnii_mcp/src/notes/types.ts`:

```typescript
/**
 * Note System Type Definitions
 *
 * Types for wiki-style note creation, wikilink parsing,
 * templates, and note processing.
 */

import type { NoteNode } from '../graph/schema/nodes';

/**
 * Input for creating a new note
 */
export interface NoteInput {
  /** Note title (will be normalized for wikilink matching) */
  title: string;
  /** Markdown content with optional [[wikilinks]] */
  content: string;
  /** How the note is being created */
  createdVia: 'manual' | 'voice' | 'template';
  /** Template type if created from template */
  templateType?: 'meeting-notes' | 'daily-journal' | 'contact-notes';
  /** Pre-parsed frontmatter (when creating from template) */
  frontmatter?: Record<string, unknown>;
}

/**
 * Result from creating a note
 */
export interface CreateNoteResult {
  /** Created note ID */
  noteId: string;
  /** Normalized title for lookups */
  normalizedTitle: string;
  /** Extracted wikilinks from content */
  wikilinks: string[];
  /** Number of new stub notes created for forward references */
  stubsCreated: number;
  /** Number of LINKS_TO relationships created */
  linksCreated: number;
}

/**
 * Match from wikilink parsing
 */
export interface WikilinkMatch {
  /** Full match text including brackets [[...]] */
  raw: string;
  /** Target page/note reference */
  target: string;
  /** Display text (after pipe if piped link, otherwise same as target) */
  display: string;
  /** Normalized target for database lookup */
  normalizedTarget: string;
  /** Position in original text (start index) */
  position: number;
}

/**
 * Template types supported
 */
export type TemplateType = 'meeting-notes' | 'daily-journal' | 'contact-notes';

/**
 * Context data for filling templates
 */
export interface TemplateContext {
  /** Current user name/identifier */
  currentUser: string;
  /** Current date (for date formatting) */
  currentDate: Date;
  /** Meeting-specific context */
  meeting?: {
    title: string;
    attendees: string[];
    project?: string;
    calendarEventId?: string;
  };
  /** Contact-specific context */
  contact?: {
    name: string;
    company?: string;
    email?: string;
  };
  /** Daily journal context */
  journal?: {
    previousDate?: string;
    nextDate?: string;
  };
}

/**
 * Template definition
 */
export interface NoteTemplate {
  /** Template identifier */
  type: TemplateType;
  /** Display name */
  name: string;
  /** Template content with {{placeholders}} */
  template: string;
  /** Default frontmatter fields */
  defaultFrontmatter: Record<string, unknown>;
}

/**
 * Backlink result from query
 */
export interface BacklinkResult {
  /** Linking note ID */
  noteId: string;
  /** Linking note title */
  title: string;
  /** Preview text around the link (context) */
  preview: string;
  /** When the linking note was last updated */
  updatedAt: string;
}

/**
 * Backlinks panel data
 */
export interface BacklinksData {
  /** Target note/entity ID */
  targetId: string;
  /** Target title */
  targetTitle: string;
  /** Notes that link to this target */
  backlinks: BacklinkResult[];
  /** Total count (may be more than returned) */
  totalCount: number;
}

/**
 * Note processing job data (for BullMQ)
 */
export interface NoteProcessingJobData {
  /** User ID for database routing */
  userId: string;
  /** Note ID to process */
  noteId: string;
  /** Processing actions to perform */
  actions: ('extract-entities' | 'update-backlink-counts')[];
}

/**
 * Note update input
 */
export interface NoteUpdateInput {
  /** New title (optional) */
  title?: string;
  /** New content (optional) */
  content?: string;
  /** Updated frontmatter (optional) */
  frontmatter?: Record<string, unknown>;
}

/**
 * Note search result
 */
export interface NoteSearchResult {
  /** Note ID */
  id: string;
  /** Note title */
  title: string;
  /** Preview/snippet */
  preview: string;
  /** Search score */
  score: number;
  /** Match highlights */
  highlights?: string[];
}

/**
 * Voice transcription result
 */
export interface VoiceTranscriptionResult {
  /** Transcribed text */
  transcript: string;
  /** Whether this is a final result */
  isFinal: boolean;
  /** Confidence score (0-1) */
  confidence?: number;
  /** Detected language */
  language?: string;
}
```
  </action>
  <verify>Run `bun typecheck --filter omnii_mcp` to verify types compile. Check file exists with `ls apps/omnii_mcp/src/notes/types.ts`.</verify>
  <done>notes/types.ts created with NoteInput, WikilinkMatch, TemplateContext, NoteTemplate, BacklinkResult, BacklinksData, NoteProcessingJobData, NoteUpdateInput, NoteSearchResult, VoiceTranscriptionResult types</done>
</task>

</tasks>

<verification>
1. All 5 dependencies present in package.json
2. `bun typecheck --filter omnii_mcp` passes with no errors
3. NodeLabel.Note exists in schema
4. NoteNode interface has all required properties
5. notes/types.ts exports all interfaces
</verification>

<success_criteria>
- Graph schema extended with Note node (following Document pattern)
- Type definitions cover notes, wikilinks, templates, backlinks, voice
- No TypeScript compilation errors
- Ready for wikilink parser implementation in 09-02
</success_criteria>

<output>
After completion, create `.planning/phases/09-notes-capture-system/09-01-SUMMARY.md`
</output>
