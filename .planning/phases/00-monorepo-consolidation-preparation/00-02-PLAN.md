---
phase: 00-monorepo-consolidation-preparation
plan: 02
type: execute
wave: 2
depends_on: ["00-01"]
files_modified:
  - /Users/santino/Projects/Omnii One/.planning/phases/00-monorepo-consolidation-preparation/00-DIVERGENCE.md
  - /Users/santino/Projects/Omnii One/.planning/phases/00-monorepo-consolidation-preparation/00-MERGE-STRATEGY.md
autonomous: true

must_haves:
  truths:
    - "All version conflicts between codebases are documented"
    - "Source of truth decided for each domain (mobile, MCP, graph schema)"
    - "Environment variable namespaces catalogued with collision plan"
  artifacts:
    - path: "/Users/santino/Projects/Omnii One/.planning/phases/00-monorepo-consolidation-preparation/00-DIVERGENCE.md"
      provides: "Complete divergence analysis"
      contains: "React Native"
      min_lines: 100
    - path: "/Users/santino/Projects/Omnii One/.planning/phases/00-monorepo-consolidation-preparation/00-MERGE-STRATEGY.md"
      provides: "Merge strategy with source of truth decisions"
      contains: "source of truth"
      min_lines: 80
  key_links:
    - from: "00-DIVERGENCE.md"
      to: "00-MERGE-STRATEGY.md"
      via: "divergence informs strategy"
      pattern: "divergence|conflict"
---

<objective>
Analyze divergence across three codebases and document merge strategy decisions.

Purpose: Identify all incompatibilities before migration to avoid the 34% complexity spike failure rate. Decisions made here prevent future merge conflicts and version hell.

Output: Two documents - DIVERGENCE.md (what's different) and MERGE-STRATEGY.md (how to resolve).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/santino/Projects/Omnii One/.planning/PROJECT.md
@/Users/santino/Projects/Omnii One/.planning/ROADMAP.md
@/Users/santino/Projects/Omnii One/.planning/phases/00-monorepo-consolidation-preparation/00-RESEARCH.md

Source codebases to analyze:
- /Users/santino/Projects/omnii (now in Omnii One after plan 01)
- /Users/santino/Projects/omnii-mobile (standalone)
- /Users/santino/Projects/omnii-mcp (standalone)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deep divergence analysis</name>
  <files>
    /Users/santino/Projects/Omnii One/.planning/phases/00-monorepo-consolidation-preparation/00-DIVERGENCE.md
  </files>
  <action>
Analyze all three codebases and document divergences. Create 00-DIVERGENCE.md with:

**1. React Native/Expo Version Matrix**
Extract from package.json files:
- omnii/apps/omnii-mobile: expo 53.0.10, react-native 0.79.3, react 19
- omnii-mobile (standalone): expo ~52.0.46, react-native 0.76.9, react 18.3.1

Document upgrade path (standalone needs upgrade to match monorepo versions).

**2. MCP Server Comparison**
Compare omnii/apps/omnii_mcp vs omnii-mcp (standalone):
- Package name: @omnii/omnii_mcp vs omnii-mcp
- Dependencies: workspace:* vs plain versions
- Test coverage differences
- Which has newer features (check git log dates)

**3. Shared Package Dependencies**
Check what standalone repos are missing:
- omnii-mcp doesn't use @omnii/api, @omnii/validators
- omnii-mobile standalone doesn't use @omnii/* packages

**4. Environment Variable Audit**
Extract all env vars from each repo:
```bash
grep -r "process.env\." --include="*.ts" --include="*.js" | grep -oE "process\.env\.[A-Z_]+" | sort -u
```
Identify collisions and namespace issues.

**5. Script Name Divergence**
Compare package.json scripts across all three - document which need standardization for Turborepo pipeline.

Format as detailed markdown with tables showing:
| Aspect | omnii | omnii-mobile | omnii-mcp | Action |
  </action>
  <verify>
File exists at: /Users/santino/Projects/Omnii One/.planning/phases/00-monorepo-consolidation-preparation/00-DIVERGENCE.md
Contains sections: Version Matrix, MCP Comparison, Package Dependencies, Environment Variables, Script Divergence
Tables show all three codebases
  </verify>
  <done>
DIVERGENCE.md exists with complete analysis of all incompatibilities, specific version numbers documented, environment variables catalogued.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create merge strategy document</name>
  <files>
    /Users/santino/Projects/Omnii One/.planning/phases/00-monorepo-consolidation-preparation/00-MERGE-STRATEGY.md
  </files>
  <action>
Based on divergence analysis, create 00-MERGE-STRATEGY.md documenting:

**1. Source of Truth Decisions**

| Domain | Source of Truth | Rationale |
|--------|-----------------|-----------|
| Mobile architecture | omnii/apps/omnii-mobile | Newer SDK 53, React 19, already workspace-integrated |
| MCP patterns | omnii/apps/omnii_mcp | Has workspace:* deps, integrated with shared packages |
| Graph schema | omnii/apps/omnii_mcp | Single source, most recent development |

Note: standalone omnii-mobile has gamification features to PRESERVE during migration (extract to separate package or merge into mobile).

**2. Migration Order**
1. omnii-mcp standalone -> Diff against apps/omnii_mcp, cherry-pick unique features
2. omnii-mobile standalone -> Extract gamification, upgrade to SDK 53/RN 0.79.3

**3. Version Reconciliation Plan**
Document root package.json resolutions:
```json
{
  "resolutions": {
    "react": "19.0.0",
    "react-native": "0.79.3",
    "expo": "~53.0.10"
  }
}
```

**4. Environment Variable Namespace Plan**
Define naming convention:
- `OMNII_*` for shared config
- `MCP_*` for MCP-specific
- `MOBILE_*` for mobile-specific
Document migration mapping from old to new names.

**5. Package Naming Convention**
All packages use @omnii/* scope. Standalone packages renamed on migration.

**6. Risk Assessment**
| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| RN version conflict | HIGH | HIGH | Strict resolutions in root package.json |
| Lost gamification | MEDIUM | MEDIUM | Extract to @omnii/gamification before merge |
| Env var collision | MEDIUM | LOW | Namespace all vars pre-migration |
  </action>
  <verify>
File exists at: /Users/santino/Projects/Omnii One/.planning/phases/00-monorepo-consolidation-preparation/00-MERGE-STRATEGY.md
Contains: Source of Truth table, Migration Order, Version Reconciliation, Environment namespace plan
Decisions are explicit and actionable (not "TBD" or "decide later")
  </verify>
  <done>
MERGE-STRATEGY.md exists with concrete decisions for source of truth, migration order, version pinning, and environment namespacing.
  </done>
</task>

</tasks>

<verification>
1. Both documents exist and are substantive:
   ```bash
   wc -l .planning/phases/00-monorepo-consolidation-preparation/00-DIVERGENCE.md  # >100 lines
   wc -l .planning/phases/00-monorepo-consolidation-preparation/00-MERGE-STRATEGY.md  # >80 lines
   ```

2. DIVERGENCE.md has specific version numbers (not placeholders)

3. MERGE-STRATEGY.md has explicit decisions (source of truth, versions, namespaces)

4. Documents reference each other appropriately
</verification>

<success_criteria>
- DIVERGENCE.md documents all version conflicts with specific numbers
- MERGE-STRATEGY.md has source of truth decision for each domain
- Environment variable namespace plan is complete
- Migration order is documented with rationale
- Risk assessment identifies top risks with mitigations
</success_criteria>

<output>
After completion, create `.planning/phases/00-monorepo-consolidation-preparation/00-02-SUMMARY.md`
</output>
