---
phase: 00-monorepo-consolidation-preparation
plan: 04
type: execute
wave: 3
depends_on: ["00-02"]
files_modified:
  - /Users/santino/Projects/Omnii One/.planning/phases/00-monorepo-consolidation-preparation/00-ENV-RECONCILIATION.md
  - /Users/santino/Projects/Omnii One/turbo.json
  - /Users/santino/Projects/Omnii One/.env.example
autonomous: true

must_haves:
  truths:
    - "All environment variables from all codebases catalogued"
    - "Namespace collisions identified and resolution documented"
    - "turbo.json updated with environment variable awareness"
  artifacts:
    - path: "/Users/santino/Projects/Omnii One/.planning/phases/00-monorepo-consolidation-preparation/00-ENV-RECONCILIATION.md"
      provides: "Environment variable reconciliation plan"
      contains: "namespace"
      min_lines: 60
    - path: "/Users/santino/Projects/Omnii One/turbo.json"
      provides: "Updated Turborepo config with env awareness"
      contains: "env"
    - path: "/Users/santino/Projects/Omnii One/.env.example"
      provides: "Documented env vars template"
      min_lines: 20
  key_links:
    - from: "/Users/santino/Projects/Omnii One/turbo.json"
      to: "environment variables"
      via: "globalEnv and task env"
      pattern: "NEO4J|SUPABASE|OPENAI"
---

<objective>
Create environment variable reconciliation plan and update Turborepo configuration.

Purpose: Prevent the "app connects to wrong database" failure by cataloguing all env vars, identifying namespace collisions, and configuring Turborepo to invalidate caches when env vars change.

Output: ENV-RECONCILIATION.md with complete plan, updated turbo.json with env awareness, .env.example template.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/santino/Projects/Omnii One/.planning/PROJECT.md
@/Users/santino/Projects/Omnii One/.planning/phases/00-monorepo-consolidation-preparation/00-RESEARCH.md
@/Users/santino/Projects/Omnii One/.planning/phases/00-monorepo-consolidation-preparation/00-MERGE-STRATEGY.md

Source codebases:
- /Users/santino/Projects/Omnii One (after plan 01 - omnii merged)
- /Users/santino/Projects/omnii-mobile (standalone)
- /Users/santino/Projects/omnii-mcp (standalone)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit all environment variables</name>
  <files>
    /Users/santino/Projects/Omnii One/.planning/phases/00-monorepo-consolidation-preparation/00-ENV-RECONCILIATION.md
  </files>
  <action>
Extract and catalogue all environment variables from all codebases:

1. Extract from omnii (now in Omnii One):
   ```bash
   cd "/Users/santino/Projects/Omnii One"
   grep -rh "process\.env\." --include="*.ts" --include="*.js" --include="*.tsx" apps/ packages/ 2>/dev/null | grep -oE "process\.env\.[A-Z_0-9]+" | sort -u
   ```

2. Extract from standalone omnii-mobile:
   ```bash
   grep -rh "process\.env\." --include="*.ts" --include="*.js" --include="*.tsx" /Users/santino/Projects/omnii-mobile/ 2>/dev/null | grep -oE "process\.env\.[A-Z_0-9]+" | sort -u
   ```

3. Extract from standalone omnii-mcp:
   ```bash
   grep -rh "process\.env\." --include="*.ts" --include="*.js" /Users/santino/Projects/omnii-mcp/ 2>/dev/null | grep -oE "process\.env\.[A-Z_0-9]+" | sort -u
   ```

4. Also check for .env files and .env.example files for documented vars.

Create 00-ENV-RECONCILIATION.md with:

**Section 1: Complete Variable Inventory**
| Variable | omnii | omnii-mobile | omnii-mcp | Purpose |
|----------|-------|--------------|-----------|---------|

**Section 2: Collision Analysis**
Variables used by multiple apps with potentially different values:
- DATABASE_URL (which database?)
- SUPABASE_URL/KEY (same or different projects?)
- NEO4J_* (same instance?)
- OPENAI_API_KEY (same key or different?)

**Section 3: Namespace Resolution**
Define naming convention:
- Shared vars: `OMNII_*` prefix for truly shared (OPENAI, SUPABASE if same project)
- App-specific: `MCP_*`, `MOBILE_*` for app-specific overrides
- Build vars: `NODE_ENV`, `CI` stay as-is

**Section 4: Migration Mapping**
| Old Name | New Name | Apps Affected |
|----------|----------|---------------|
| DATABASE_URL | OMNII_DATABASE_URL | all |

**Section 5: Loading Order**
Document precedence:
1. Root .env (shared defaults)
2. apps/{app}/.env (app defaults)
3. apps/{app}/.env.local (local overrides, gitignored)
  </action>
  <verify>
00-ENV-RECONCILIATION.md exists
Contains complete inventory table with 15+ variables
Collision analysis section identifies overlapping vars
Namespace convention is defined
Migration mapping provided
  </verify>
  <done>
Complete environment variable audit with namespace plan and migration mapping.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update turbo.json with environment awareness</name>
  <files>
    /Users/santino/Projects/Omnii One/turbo.json
    /Users/santino/Projects/Omnii One/.env.example
  </files>
  <action>
Update turbo.json to be environment-variable aware per Turborepo best practices:

1. Read current turbo.json
2. Update globalEnv to include all shared environment variables:
   ```json
   "globalEnv": [
     "NODE_ENV",
     "CI",
     "OMNII_SUPABASE_URL",
     "OMNII_SUPABASE_ANON_KEY",
     "OMNII_OPENAI_API_KEY"
   ]
   ```

3. Add task-specific env vars to build task:
   ```json
   "build": {
     "dependsOn": ["^build"],
     "outputs": [".cache/tsbuildinfo.json", "dist/**", ".expo/**"],
     "env": [
       "NEO4J_URI",
       "NEO4J_USERNAME",
       "NEO4J_PASSWORD",
       "COMPOSIO_API_KEY",
       "TWILIO_*"
     ]
   }
   ```

4. Add globalDependencies for .env files:
   ```json
   "globalDependencies": [
     "**/.env",
     "**/.env.local",
     "**/.env.example"
   ]
   ```

5. Create .env.example at root with all documented variables:
   ```
   # Shared Configuration
   NODE_ENV=development

   # Supabase (shared across apps)
   OMNII_SUPABASE_URL=
   OMNII_SUPABASE_ANON_KEY=
   OMNII_SUPABASE_SERVICE_ROLE_KEY=

   # Neo4j
   NEO4J_URI=
   NEO4J_USERNAME=
   NEO4J_PASSWORD=

   # OpenAI
   OMNII_OPENAI_API_KEY=

   # Composio (MCP)
   COMPOSIO_API_KEY=

   # Twilio (MCP)
   TWILIO_ACCOUNT_SID=
   TWILIO_AUTH_TOKEN=

   # Redis
   REDIS_URL=
   ```

Write updated turbo.json and create .env.example.
  </action>
  <verify>
Run: `cat turbo.json | grep -A5 '"globalEnv"'` shows env vars listed
Run: `cat turbo.json | grep -A10 '"build"'` shows env array in build task
Run: `cat .env.example | wc -l` shows 20+ lines
Run: `pnpm turbo build --dry-run` completes without env errors
  </verify>
  <done>
turbo.json updated with environment awareness, .env.example created with all documented variables.
  </done>
</task>

</tasks>

<verification>
1. Reconciliation doc is comprehensive:
   ```bash
   grep -c "|" .planning/phases/00-monorepo-consolidation-preparation/00-ENV-RECONCILIATION.md  # Multiple table rows
   ```

2. turbo.json has env config:
   ```bash
   grep "globalEnv" turbo.json && grep '"env"' turbo.json
   ```

3. .env.example exists and is useful:
   ```bash
   head -30 .env.example
   ```

4. Turborepo accepts config:
   ```bash
   pnpm turbo build --dry-run 2>&1 | head -10
   ```
</verification>

<success_criteria>
- All environment variables from all three codebases catalogued in ENV-RECONCILIATION.md
- Namespace collisions identified with resolution plan
- turbo.json includes globalEnv and task-level env arrays
- .env.example provides template for all required variables
- Turborepo dry-run succeeds with updated config
</success_criteria>

<output>
After completion, create `.planning/phases/00-monorepo-consolidation-preparation/00-04-SUMMARY.md`
</output>
