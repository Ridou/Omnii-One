# Plan 10-04: Heads-Up Notification Trigger System

## Overview
Implement the trigger system that surfaces meeting briefings 15-30 minutes before events.

## Dependencies
- 10-03: Pre-event context aggregation
- Existing: BullMQ job queue infrastructure

## Tasks

### 1. Create heads-up scheduler
Create `apps/omnii_mcp/src/services/ai/heads-up-scheduler.ts`:
- `scheduleHeadsUp()`: Schedule briefing delivery for event
  - Default: 30 minutes before for meetings > 30min
  - Default: 15 minutes before for short meetings
  - User-configurable timing
- `rescheduleOnEventChange()`: Handle event updates
- `cancelHeadsUp()`: Cancel on event deletion
- Use BullMQ delayed jobs

### 2. Create heads-up worker
Create `apps/omnii_mcp/src/workers/heads-up-worker.ts`:
- BullMQ worker for `heads-up-queue`
- Job handler:
  1. Fetch event details
  2. Generate or retrieve cached briefing
  3. Deliver via configured channel
- Error handling with retry (max 2 attempts)
- Skip if event cancelled or user declined

### 3. Create delivery channels
Create `apps/omnii_mcp/src/services/ai/heads-up-delivery.ts`:
- `deliverBriefing()`: Route to appropriate channel
- Channels:
  - Push notification (mobile)
  - In-app notification (stored in Supabase)
  - Email digest (optional)
- Delivery preferences per user
- Rate limiting (max 5 heads-ups per hour)

### 4. Create calendar sync hook
Update `apps/omnii_mcp/src/ingestion/sources/google-calendar.ts`:
- After syncing event, check if heads-up should be scheduled
- Only for events with attendees (meetings, not personal events)
- Only for events in next 7 days
- Call `scheduleHeadsUp()` for qualifying events

### 5. Create heads-up preferences
Create `apps/omnii_mcp/src/services/ai/heads-up-preferences.ts`:
- User preference storage (Supabase `user_preferences` table)
- Configurable:
  - Enable/disable heads-up
  - Timing (15/30/60 min before)
  - Minimum meeting duration threshold
  - Quiet hours (no notifications during)
  - Delivery channel preference

## Acceptance Criteria
- [ ] Heads-up scheduled when calendar syncs
- [ ] Briefing delivered 15-30 min before event
- [ ] User can configure timing preferences
- [ ] Cancelled events don't trigger heads-up

## Wave
3 (depends on 10-03)
