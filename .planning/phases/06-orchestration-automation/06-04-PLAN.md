---
phase: 06-orchestration-automation
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - apps/omnii_mcp/src/services/workflows/webhook-validator.ts
  - apps/omnii_mcp/src/services/workflows/index.ts
  - apps/omnii_mcp/src/routes/n8n-webhooks.ts
autonomous: true

must_haves:
  truths:
    - "Webhook requests are validated using HMAC-SHA256 signatures"
    - "Invalid signatures are rejected with 401 and logged as security events"
    - "Replay attacks are prevented via timestamp validation"
  artifacts:
    - path: "apps/omnii_mcp/src/services/workflows/webhook-validator.ts"
      provides: "HMAC signature validation for n8n webhooks"
      exports: ["validateWebhookSignature", "createWebhookSignature", "WebhookValidationResult"]
  key_links:
    - from: "apps/omnii_mcp/src/services/workflows/webhook-validator.ts"
      to: "crypto"
      via: "HMAC-SHA256 creation and comparison"
      pattern: "crypto\\.createHmac\\('sha256'"
    - from: "apps/omnii_mcp/src/routes/n8n-webhooks.ts"
      to: "webhook-validator"
      via: "validation middleware"
      pattern: "validateWebhookSignature"
---

<objective>
Implement HMAC webhook signature validation for n8n webhook security (ORCH-02, SEC-04).

Purpose: Prevent webhook spoofing and replay attacks by validating cryptographic signatures on all incoming n8n webhook requests. Audit log failed validation attempts for security monitoring.

Output: Webhook validator service with timing-safe HMAC comparison and optional timestamp validation.
</objective>

<execution_context>
@/Users/santino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/santino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-orchestration-automation/06-RESEARCH.md

# Existing webhook routes to be enhanced
@apps/omnii_mcp/src/routes/n8n-webhooks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create webhook signature validator</name>
  <files>
    apps/omnii_mcp/src/services/workflows/webhook-validator.ts
  </files>
  <action>
1. Create `apps/omnii_mcp/src/services/workflows/webhook-validator.ts`:

   a. Import crypto (Node built-in) and audit logger:
      ```typescript
      import crypto from 'crypto';
      import { logAuditEvent } from '../audit';
      ```

   b. Define configuration interface and validation result:
      ```typescript
      export interface WebhookValidatorConfig {
        secret: string;
        timestampTolerance?: number; // Default 5 minutes (300000ms)
        signatureHeader?: string; // Default 'x-n8n-signature'
        timestampHeader?: string; // Default 'x-n8n-timestamp'
      }

      export interface WebhookValidationResult {
        valid: boolean;
        reason?: string;
        timestamp?: number;
      }
      ```

   c. Create core validation functions:

      - `createWebhookSignature(payload: string, secret: string): string`
        - Create HMAC-SHA256 of payload with secret
        - Return hex-encoded signature

      - `timingSafeCompare(a: string, b: string): boolean`
        - Use crypto.timingSafeEqual for constant-time comparison
        - Handle different lengths gracefully (return false)

      - `validateWebhookSignature(options: ValidationOptions): WebhookValidationResult`
        ```typescript
        interface ValidationOptions {
          payload: string;
          signature: string | null;
          timestamp?: string | null;
          secret: string;
          timestampTolerance?: number;
        }
        ```
        Implementation:
        1. Check if signature is provided, return invalid if missing
        2. Compute expected signature from payload + secret
        3. Use timingSafeCompare to check signature match
        4. If timestamp provided and tolerance set:
           - Parse timestamp as number
           - Check if within tolerance window
           - Return invalid if outside window (replay attack prevention)
        5. Return { valid: true } or { valid: false, reason: '...' }

   d. Create higher-level validation function for Elysia middleware:
      ```typescript
      export async function validateN8nWebhook(
        request: Request,
        body: unknown,
        ipAddress?: string
      ): Promise<WebhookValidationResult> {
        const secret = process.env.N8N_WEBHOOK_SECRET;

        // If no secret configured, skip validation (development mode)
        if (!secret) {
          console.warn('[WebhookValidator] N8N_WEBHOOK_SECRET not set, skipping validation');
          return { valid: true, reason: 'validation_disabled' };
        }

        const signature = request.headers.get('x-n8n-signature');
        const timestamp = request.headers.get('x-n8n-timestamp');
        const payload = JSON.stringify(body);

        const result = validateWebhookSignature({
          payload,
          signature,
          timestamp,
          secret,
          timestampTolerance: 300000 // 5 minutes
        });

        // Log validation failures as security events
        if (!result.valid) {
          await logAuditEvent({
            event: 'webhook_validation_failed',
            userId: 'unknown',
            actor: 'webhook',
            severity: 'warning',
            metadata: {
              reason: result.reason,
              ipAddress,
              hasSignature: !!signature,
              hasTimestamp: !!timestamp
            }
          });
        }

        return result;
      }
      ```

   e. Export all functions and types.
  </action>
  <verify>
Run `bun run build` - should compile without errors.

Test the signature creation and validation:
```bash
cd apps/omnii_mcp && bun -e "
const { createWebhookSignature, validateWebhookSignature } = require('./src/services/workflows/webhook-validator');

const payload = JSON.stringify({ test: 'data' });
const secret = 'test-secret';
const signature = createWebhookSignature(payload, secret);

console.log('Signature:', signature);

const result = validateWebhookSignature({
  payload,
  signature,
  secret
});

console.log('Valid:', result.valid);

const badResult = validateWebhookSignature({
  payload,
  signature: 'bad-signature',
  secret
});

console.log('Bad signature rejected:', !badResult.valid);
"
```
  </verify>
  <done>
Webhook validator created with HMAC-SHA256, timing-safe comparison, and timestamp validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate validation into webhook routes</name>
  <files>
    apps/omnii_mcp/src/routes/n8n-webhooks.ts
    apps/omnii_mcp/src/services/workflows/index.ts
  </files>
  <action>
1. Update `apps/omnii_mcp/src/services/workflows/index.ts`:
   - Add export for webhook-validator:
     ```typescript
     export * from './execution-tracker';
     export * from './webhook-validator';
     ```

2. Update `apps/omnii_mcp/src/routes/n8n-webhooks.ts`:

   a. Add imports at top:
      ```typescript
      import { validateN8nWebhook } from '../services/workflows';
      import { logAuditEvent } from '../services/audit';
      ```

   b. For the `/n8n/progress/:sessionId` POST endpoint:
      - At the start of the handler, add validation:
        ```typescript
        // Validate webhook signature
        const validation = await validateN8nWebhook(
          request,
          body,
          request.headers.get('x-forwarded-for') || 'unknown'
        );

        if (!validation.valid) {
          set.status = 401;
          return {
            error: 'Invalid webhook signature',
            details: validation.reason
          };
        }
        ```

   c. For the `/n8n/response/:sessionId` POST endpoint:
      - Add same validation logic at the start

   d. Add audit logging for successful webhook receipts:
      ```typescript
      await logAuditEvent({
        event: 'webhook_received',
        userId: body.userId || 'unknown',
        actor: 'webhook',
        resource: { type: 'n8n_webhook', id: sessionId },
        action: 'execute',
        metadata: {
          endpoint: 'progress', // or 'response'
          agentType: body.agentType
        }
      });
      ```
  </action>
  <verify>
Run `bun run build` - should compile without errors.

Check that validation is integrated:
```bash
cd apps/omnii_mcp && grep -n "validateN8nWebhook" src/routes/n8n-webhooks.ts
```
Should show validation calls in the routes.
  </verify>
  <done>
Webhook validation integrated into n8n routes. Invalid signatures rejected with 401. All webhook events logged.
  </done>
</task>

</tasks>

<verification>
1. `bun run build` compiles without errors
2. createWebhookSignature produces valid HMAC-SHA256
3. timingSafeCompare uses crypto.timingSafeEqual
4. Invalid signatures are rejected in webhook routes
5. Failed validations are logged as security events
6. Successful webhooks are audit logged
</verification>

<success_criteria>
- HMAC-SHA256 signature validation working
- Timing-safe comparison prevents timing attacks
- Timestamp validation prevents replay attacks (when timestamp provided)
- Development mode allows skipping validation when N8N_WEBHOOK_SECRET not set
- Security events logged for failed validation attempts
- Webhook routes return 401 for invalid signatures
</success_criteria>

<output>
After completion, create `.planning/phases/06-orchestration-automation/06-04-SUMMARY.md`
</output>
