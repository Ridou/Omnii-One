---
phase: 06-orchestration-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/omnii_mcp/package.json
  - apps/omnii_mcp/src/services/audit/audit-logger.ts
  - apps/omnii_mcp/src/services/audit/audit-events.ts
  - apps/omnii_mcp/src/services/audit/index.ts
autonomous: true

must_haves:
  truths:
    - "All data access events are logged with structured metadata"
    - "PII fields are automatically redacted in audit logs"
    - "Audit events include actor, resource, action, and timestamp"
  artifacts:
    - path: "apps/omnii_mcp/src/services/audit/audit-logger.ts"
      provides: "Pino-based audit logging service with PII redaction"
      exports: ["auditLogger", "logAuditEvent", "AuditEvent"]
    - path: "apps/omnii_mcp/src/services/audit/audit-events.ts"
      provides: "Audit event type definitions"
      exports: ["AuditEventType", "AuditActor", "AuditResource"]
  key_links:
    - from: "apps/omnii_mcp/src/services/audit/audit-logger.ts"
      to: "pino"
      via: "import and configuration"
      pattern: "import pino from 'pino'"
---

<objective>
Implement Pino-based audit logging service with PII redaction for GDPR compliance (SEC-04).

Purpose: Audit logging captures data access events for compliance, enabling reconstruction of who accessed what data and when. This is foundational for workflow execution tracking and webhook security logging.

Output: Audit logging service with structured event types, automatic PII redaction, and correlation ID support.
</objective>

<execution_context>
@/Users/santino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/santino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-orchestration-automation/06-RESEARCH.md

# Existing services for pattern reference
@apps/omnii_mcp/src/services/integrations/n8n-agent-client.ts
@apps/omnii_mcp/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Pino and create audit event types</name>
  <files>
    apps/omnii_mcp/package.json
    apps/omnii_mcp/src/services/audit/audit-events.ts
  </files>
  <action>
1. Install Pino and pino-pretty:
   ```bash
   cd apps/omnii_mcp && bun add pino pino-pretty
   ```

2. Create `apps/omnii_mcp/src/services/audit/audit-events.ts` with:
   - AuditEventType enum with event categories:
     - `workflow_execution_triggered`
     - `workflow_execution_completed`
     - `workflow_execution_failed`
     - `workflow_list_requested`
     - `workflow_status_requested`
     - `webhook_received`
     - `webhook_validation_failed`
     - `mcp_tool_invoked`
     - `graph_data_accessed`
   - AuditActor type: `'user' | 'ai_assistant' | 'system' | 'webhook'`
   - AuditResource interface: `{ type: string; id?: string; name?: string }`
   - AuditAction type: `'create' | 'read' | 'update' | 'delete' | 'execute' | 'list'`
   - AuditSeverity type: `'info' | 'warning' | 'error'`
   - AuditEvent interface with all fields (event, userId, actor, resource, action, severity, metadata, correlationId, timestamp)

3. Export all types for use by audit logger and other services.
  </action>
  <verify>
Run `bun run build` in apps/omnii_mcp - should compile without errors. Check pino is in package.json dependencies.
  </verify>
  <done>
Pino installed, audit event types defined and exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Pino audit logger with PII redaction</name>
  <files>
    apps/omnii_mcp/src/services/audit/audit-logger.ts
    apps/omnii_mcp/src/services/audit/index.ts
  </files>
  <action>
1. Create `apps/omnii_mcp/src/services/audit/audit-logger.ts`:

   a. Import pino and audit event types

   b. Define redaction paths for PII (per research):
      ```typescript
      const REDACT_PATHS = [
        'email',
        'phone',
        'phoneNumber',
        'ssn',
        'password',
        'token',
        'apiKey',
        'metadata.email',
        'metadata.phone',
        'parameters.email',
        'parameters.phone_number',
        'parameters.address',
        'req.headers.authorization',
        'req.headers["x-api-key"]'
      ];
      ```

   c. Create pino instance with configuration:
      - level: from AUDIT_LOG_LEVEL env var (default 'info')
      - redact: { paths: REDACT_PATHS, censor: '[REDACTED]' }
      - base: { service: 'omnii-mcp', environment: process.env.NODE_ENV }
      - timestamp: pino.stdTimeFunctions.isoTime
      - formatters: { level: (label) => ({ level: label.toUpperCase() }) }

   d. Create logAuditEvent function that:
      - Accepts AuditEvent object
      - Adds timestamp if not present
      - Adds default actor ('user') if not specified
      - Calls auditLogger.info with structured event data
      - Logs message format: `Audit: ${event.event}`

   e. Create helper functions:
      - logWorkflowEvent(event, userId, workflowId, metadata?)
      - logWebhookEvent(event, source, success, metadata?)
      - logMcpToolEvent(toolName, userId, actor, metadata?)

   f. Export auditLogger instance and all functions

2. Create `apps/omnii_mcp/src/services/audit/index.ts`:
   - Re-export everything from audit-logger.ts
   - Re-export everything from audit-events.ts
  </action>
  <verify>
Create a simple test script that imports audit logger and logs a test event:
```bash
cd apps/omnii_mcp && bun -e "
const { logAuditEvent } = require('./src/services/audit');
logAuditEvent({
  event: 'workflow_list_requested',
  userId: 'test-user',
  actor: 'ai_assistant',
  action: 'list',
  metadata: { email: 'test@example.com' }
});
console.log('Audit log test complete');
"
```
Should see structured log output with email redacted as [REDACTED].
  </verify>
  <done>
Audit logger created with PII redaction. logAuditEvent and helper functions working. Barrel export configured.
  </done>
</task>

</tasks>

<verification>
1. `bun add pino pino-pretty` completes successfully
2. `bun run build` in apps/omnii_mcp compiles without errors
3. Audit logger imports successfully and logs structured events
4. PII fields (email, phone, etc.) are automatically redacted in log output
5. All types exported from barrel index file
</verification>

<success_criteria>
- Pino installed and configured with PII redaction
- AuditEvent interface and related types defined
- logAuditEvent function working with structured output
- Helper functions for common audit patterns available
- Barrel export aggregates all audit module exports
</success_criteria>

<output>
After completion, create `.planning/phases/06-orchestration-automation/06-01-SUMMARY.md`
</output>
