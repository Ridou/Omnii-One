---
phase: 06-orchestration-automation
plan: 06
type: execute
wave: 4
depends_on: ["06-01", "06-02", "06-03", "06-04", "06-05"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "MCP tools for workflow operations are accessible via API"
    - "Audit logs capture all workflow operations"
    - "Webhook validation protects against spoofing"
  artifacts: []
  key_links: []
---

<objective>
End-to-end verification of Phase 6 orchestration and automation features.

Purpose: Validate that all components work together: n8n workflow client, MCP tools, webhook validation, audit logging, and execution tracking.

Output: Verified system ready for production use.
</objective>

<execution_context>
@/Users/santino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/santino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-orchestration-automation/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify build and dependencies</name>
  <files></files>
  <action>
1. Run full build to ensure all code compiles:
   ```bash
   cd apps/omnii_mcp && bun run build
   ```

2. Verify dependencies are installed:
   ```bash
   cd apps/omnii_mcp && bun pm ls | grep -E "(pino|exponential-backoff)"
   ```

3. Check that all new modules can be imported:
   ```bash
   cd apps/omnii_mcp && bun -e "
   // Audit module
   const audit = require('./src/services/audit');
   console.log('Audit exports:', Object.keys(audit));

   // Workflows module
   const workflows = require('./src/services/workflows');
   console.log('Workflows exports:', Object.keys(workflows));

   // Integrations module
   const integrations = require('./src/services/integrations');
   console.log('Integrations exports:', Object.keys(integrations));

   // MCP tools
   const tools = require('./src/mcp/tools');
   console.log('MCP tools:', tools.getToolNames().length, 'tools registered');
   console.log('Workflow tools:', tools.getToolNames().filter(n => n.includes('workflow')));
   "
   ```
  </action>
  <verify>
Build succeeds without errors. All modules export expected functions and classes.
  </verify>
  <done>
Build verified. All new modules importable and functional.
  </done>
</task>

<task type="auto">
  <name>Task 2: Start server and verify health endpoints</name>
  <files></files>
  <action>
1. Start the development server:
   ```bash
   cd apps/omnii_mcp && bun run dev &
   sleep 5
   ```

2. Check server health:
   ```bash
   curl -s http://localhost:8081/health | jq
   ```

3. Check MCP health (should show 10 tools now):
   ```bash
   curl -s http://localhost:8081/mcp/health | jq
   ```

4. Check n8n webhook health:
   ```bash
   curl -s http://localhost:8081/api/n8n/health | jq
   ```

5. Stop the dev server when done:
   ```bash
   pkill -f "bun run dev" || true
   ```
  </action>
  <verify>
All health endpoints return 200 OK. MCP health shows 10 tools.
  </verify>
  <done>
Server starts successfully. Health endpoints operational. 10 MCP tools registered.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 6 Orchestration & Automation implementation:

1. **Audit Logging Service** (06-01)
   - Pino-based structured logging
   - PII redaction for GDPR compliance
   - Event types for workflows, webhooks, MCP tools

2. **Workflow Execution Tracking** (06-02)
   - Supabase table for idempotent execution
   - ExecutionTracker service with exactly-once semantics
   - Status tracking (pending/running/completed/failed)

3. **n8n REST API Client** (06-03)
   - List workflows, get status, trigger execution
   - Integrated with audit logging
   - Exponential backoff retry

4. **Webhook Signature Validation** (06-04)
   - HMAC-SHA256 signature validation
   - Timing-safe comparison
   - Replay attack prevention via timestamp validation

5. **MCP Workflow Tools** (06-05)
   - omnii_list_workflows: List available n8n workflows
   - omnii_execute_workflow: Trigger workflow with parameters
   - omnii_workflow_status: Check execution status
  </what-built>
  <how-to-verify>
**Manual verification steps:**

1. **Start the server:**
   ```bash
   cd apps/omnii_mcp && bun run dev
   ```

2. **Check MCP tools are registered (should show 10 tools):**
   ```bash
   curl -s http://localhost:8081/mcp/health | jq '.toolCount'
   ```

3. **Test audit logging (check console output):**
   - Make any MCP request
   - Verify structured JSON log output appears
   - Check that any email/phone fields would be redacted

4. **Test webhook endpoint (without signature - should fail if N8N_WEBHOOK_SECRET is set):**
   ```bash
   curl -X POST http://localhost:8081/api/n8n/progress/test-session \
     -H "Content-Type: application/json" \
     -d '{"sessionId":"test","progress":50,"message":"Test progress"}'
   ```
   - If N8N_WEBHOOK_SECRET is set: Should return 401
   - If not set: Should succeed (dev mode)

5. **Test list_workflows tool via test endpoint (if available):**
   ```bash
   curl -X POST http://localhost:8081/api/test/mcp/tool \
     -H "Content-Type: application/json" \
     -d '{"tool":"omnii_list_workflows","input":{"active_only":true}}'
   ```
   - Should return list of workflows (or empty if n8n not configured)

6. **Verify Swagger documentation includes new endpoints:**
   Visit http://localhost:8081/swagger
   - Check n8n webhook endpoints are documented
   - Check new tools appear in any tool documentation

**Note:** Full n8n workflow execution testing requires:
- N8N_API_KEY environment variable set
- n8n instance running with workflows configured

For now, verify the code compiles, endpoints respond, and tools are registered.
  </how-to-verify>
  <resume-signal>
Type "approved" if all checks pass, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
1. Build compiles without errors
2. All new modules importable
3. Server starts and health endpoints respond
4. MCP health shows 10 tools (was 7, now +3 workflow tools)
5. n8n webhook endpoints operational
6. Human verification of end-to-end functionality
</verification>

<success_criteria>
- Phase 6 requirements met:
  - ORCH-01: n8n workflow integration via webhooks (existing + enhanced)
  - ORCH-02: Webhook endpoints for external triggers (existing + secured)
  - ORCH-03: AI-triggered workflow execution (MCP tools)
  - ORCH-04: User-defined automation support (n8n workflows)
  - ORCH-05: n8n MCP tools for workflow operations (3 new tools)
  - ORCH-06: Error handling and retry logic (backoff, idempotency)
  - SEC-04: Audit logging for data access (Pino service)
</success_criteria>

<output>
After completion, create `.planning/phases/06-orchestration-automation/06-06-SUMMARY.md`
</output>
