---
phase: 06-orchestration-automation
plan: 07
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - apps/omnii_mcp/src/mcp/tools/search-nodes.ts
  - apps/omnii_mcp/src/mcp/tools/get-context.ts
  - apps/omnii_mcp/src/mcp/tools/list-entities.ts
  - apps/omnii_mcp/src/mcp/tools/calendar-query.ts
  - apps/omnii_mcp/src/mcp/tools/contact-lookup.ts
  - apps/omnii_mcp/src/mcp/tools/task-operations.ts
  - apps/omnii_mcp/src/mcp/tools/extract-relationships.ts
autonomous: true

must_haves:
  truths:
    - "All graph data access via MCP tools is logged for compliance"
    - "Audit logs capture tool name, user ID, resource type, and action"
    - "PII in tool parameters is automatically redacted in logs"
  artifacts:
    - path: "apps/omnii_mcp/src/mcp/tools/search-nodes.ts"
      provides: "Search nodes tool with audit logging"
      contains: "logAuditEvent"
    - path: "apps/omnii_mcp/src/mcp/tools/get-context.ts"
      provides: "Get context tool with audit logging"
      contains: "logAuditEvent"
    - path: "apps/omnii_mcp/src/mcp/tools/list-entities.ts"
      provides: "List entities tool with audit logging"
      contains: "logAuditEvent"
    - path: "apps/omnii_mcp/src/mcp/tools/calendar-query.ts"
      provides: "Calendar query tool with audit logging"
      contains: "logAuditEvent"
    - path: "apps/omnii_mcp/src/mcp/tools/contact-lookup.ts"
      provides: "Contact lookup tool with audit logging"
      contains: "logAuditEvent"
    - path: "apps/omnii_mcp/src/mcp/tools/task-operations.ts"
      provides: "Task operations tool with audit logging"
      contains: "logAuditEvent"
    - path: "apps/omnii_mcp/src/mcp/tools/extract-relationships.ts"
      provides: "Extract relationships tool with audit logging"
      contains: "logAuditEvent"
  key_links:
    - from: "apps/omnii_mcp/src/mcp/tools/*.ts"
      to: "audit-logger"
      via: "logAuditEvent import and calls"
      pattern: "import.*logAuditEvent.*from.*audit"
---

<objective>
Retrofit audit logging to all existing MCP tools for SEC-04 compliance (data access logging).

Purpose: SEC-04 requires audit logging for all data access events. The new workflow tools (06-05) have audit logging, but the 7 existing graph data access tools do not. This plan adds logAuditEvent calls to all existing MCP tool handlers.

Output: All 7 existing MCP tools updated with audit logging for graph_data_accessed events.
</objective>

<execution_context>
@/Users/santino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/santino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-orchestration-automation/06-01-SUMMARY.md

# Existing MCP tools to be updated
@apps/omnii_mcp/src/mcp/tools/index.ts
@apps/omnii_mcp/src/mcp/tools/search-nodes.ts
@apps/omnii_mcp/src/mcp/tools/calendar-query.ts

# Audit service to use
@apps/omnii_mcp/src/services/audit/audit-logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add audit logging to graph read tools (search-nodes, get-context, list-entities)</name>
  <files>
    apps/omnii_mcp/src/mcp/tools/search-nodes.ts
    apps/omnii_mcp/src/mcp/tools/get-context.ts
    apps/omnii_mcp/src/mcp/tools/list-entities.ts
  </files>
  <action>
For each of the 3 files, add audit logging following this pattern:

1. Add import at top:
   ```typescript
   import { logAuditEvent } from '../../services/audit';
   ```

2. In the handler function, immediately after input validation, add audit log:

**For search-nodes.ts (`handleSearchNodes`):**
```typescript
// Log audit event for graph data access
await logAuditEvent({
  event: 'graph_data_accessed',
  userId: userId || 'unknown',
  actor: 'ai_assistant',
  action: 'read',
  resource: { type: 'graph_search', name: 'search_nodes' },
  metadata: {
    tool: 'omnii_search_nodes',
    query: parsed.data.query,
    entityTypes: parsed.data.entity_types,
    limit: parsed.data.limit
  }
});
```

**For get-context.ts (`handleGetContext`):**
```typescript
await logAuditEvent({
  event: 'graph_data_accessed',
  userId: userId || 'unknown',
  actor: 'ai_assistant',
  action: 'read',
  resource: { type: 'graph_context', name: 'get_context' },
  metadata: {
    tool: 'omnii_get_context',
    nodeId: parsed.data.node_id,
    depth: parsed.data.depth
  }
});
```

**For list-entities.ts (`handleListEntities`):**
```typescript
await logAuditEvent({
  event: 'graph_data_accessed',
  userId: userId || 'unknown',
  actor: 'ai_assistant',
  action: 'list',
  resource: { type: 'graph_entities', name: 'list_entities' },
  metadata: {
    tool: 'omnii_list_entities',
    entityType: parsed.data.entity_type,
    limit: parsed.data.limit
  }
});
```

3. Also add error logging on failures:
```typescript
// In catch block
await logAuditEvent({
  event: 'graph_data_accessed',
  userId: userId || 'unknown',
  actor: 'ai_assistant',
  severity: 'error',
  resource: { type: 'graph_search', name: 'search_nodes' },
  metadata: {
    tool: 'omnii_search_nodes',
    error: (error as Error).message
  }
});
```
  </action>
  <verify>
Run `bun run build` - should compile without errors.

Verify imports added:
```bash
cd apps/omnii_mcp && grep -l "logAuditEvent" src/mcp/tools/search-nodes.ts src/mcp/tools/get-context.ts src/mcp/tools/list-entities.ts
```
Should list all 3 files.
  </verify>
  <done>
search-nodes, get-context, and list-entities tools updated with audit logging.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add audit logging to domain-specific tools (calendar, contacts, tasks, relationships)</name>
  <files>
    apps/omnii_mcp/src/mcp/tools/calendar-query.ts
    apps/omnii_mcp/src/mcp/tools/contact-lookup.ts
    apps/omnii_mcp/src/mcp/tools/task-operations.ts
    apps/omnii_mcp/src/mcp/tools/extract-relationships.ts
  </files>
  <action>
For each of the 4 files, add audit logging following this pattern:

1. Add import at top:
   ```typescript
   import { logAuditEvent } from '../../services/audit';
   ```

2. In the handler function, immediately after input validation, add audit log:

**For calendar-query.ts (`handleCalendarQuery`):**
```typescript
await logAuditEvent({
  event: 'graph_data_accessed',
  userId: userId || 'unknown',
  actor: 'ai_assistant',
  action: 'read',
  resource: { type: 'calendar', name: 'calendar_query' },
  metadata: {
    tool: 'omnii_calendar_query',
    startDate: parsed.data.start_date,
    endDate: parsed.data.end_date,
    calendarId: parsed.data.calendar_id
  }
});
```

**For contact-lookup.ts (`handleContactLookup`):**
```typescript
await logAuditEvent({
  event: 'graph_data_accessed',
  userId: userId || 'unknown',
  actor: 'ai_assistant',
  action: 'read',
  resource: { type: 'contact', name: 'contact_lookup' },
  metadata: {
    tool: 'omnii_contact_lookup',
    // Note: query may contain PII - audit service will redact if needed
    hasQuery: !!parsed.data.query,
    contactId: parsed.data.contact_id
  }
});
```

**For task-operations.ts (`handleTaskOperations`):**
```typescript
// Determine action type based on operation
const actionType = parsed.data.operation === 'list' ? 'list' :
                   parsed.data.operation === 'create' ? 'create' :
                   parsed.data.operation === 'update' ? 'update' : 'read';

await logAuditEvent({
  event: 'graph_data_accessed',
  userId: userId || 'unknown',
  actor: 'ai_assistant',
  action: actionType,
  resource: { type: 'task', name: 'task_operations' },
  metadata: {
    tool: 'omnii_task_operations',
    operation: parsed.data.operation,
    taskId: parsed.data.task_id
  }
});
```

**For extract-relationships.ts (`handleExtractRelationships`):**
```typescript
await logAuditEvent({
  event: 'graph_data_accessed',
  userId: userId || 'unknown',
  actor: 'ai_assistant',
  action: 'read',
  resource: { type: 'relationship', name: 'extract_relationships' },
  metadata: {
    tool: 'omnii_extract_relationships',
    nodeId: parsed.data.node_id,
    relationshipTypes: parsed.data.relationship_types
  }
});
```

3. Add error logging in catch blocks for each file.
  </action>
  <verify>
Run `bun run build` - should compile without errors.

Verify imports added:
```bash
cd apps/omnii_mcp && grep -l "logAuditEvent" src/mcp/tools/calendar-query.ts src/mcp/tools/contact-lookup.ts src/mcp/tools/task-operations.ts src/mcp/tools/extract-relationships.ts
```
Should list all 4 files.
  </verify>
  <done>
calendar-query, contact-lookup, task-operations, and extract-relationships tools updated with audit logging.
  </done>
</task>

</tasks>

<verification>
1. `bun run build` compiles without errors
2. All 7 existing MCP tool files contain `logAuditEvent` import
3. All 7 tool handlers log `graph_data_accessed` event on invocation
4. Error cases also log audit events with severity 'error'
5. PII-sensitive metadata (emails, queries) is handled safely (audit service redacts)
</verification>

<success_criteria>
- SEC-04 compliance: All graph data access events are logged
- Audit events include: tool name, user ID, resource type, action
- Error cases logged for debugging and compliance
- No breaking changes to tool functionality
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-orchestration-automation/06-07-SUMMARY.md`
</output>
