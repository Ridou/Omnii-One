---
phase: 06-orchestration-automation
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - apps/omnii_mcp/src/services/integrations/n8n-workflow-client.ts
  - apps/omnii_mcp/src/services/integrations/index.ts
autonomous: true

must_haves:
  truths:
    - "Backend can list available n8n workflows via REST API"
    - "Backend can check execution status of running workflows"
    - "Backend can trigger workflow execution via webhook URLs"
  artifacts:
    - path: "apps/omnii_mcp/src/services/integrations/n8n-workflow-client.ts"
      provides: "n8n REST API client for workflow operations"
      exports: ["N8nWorkflowClient", "n8nWorkflowClient", "Workflow", "WorkflowExecution"]
  key_links:
    - from: "apps/omnii_mcp/src/services/integrations/n8n-workflow-client.ts"
      to: "n8n REST API"
      via: "fetch calls to /api/v1/workflows"
      pattern: "fetch.*api/v1/workflows"
    - from: "apps/omnii_mcp/src/services/integrations/n8n-workflow-client.ts"
      to: "audit-logger"
      via: "logAuditEvent import"
      pattern: "logAuditEvent"
---

<objective>
Create n8n REST API client for workflow management operations (ORCH-01, ORCH-04, ORCH-05).

Purpose: Enable listing available workflows, checking execution status, and triggering workflows programmatically. This client will be used by MCP tools to expose workflow operations to AI assistants.

Output: N8nWorkflowClient service with workflow list, execute, and status operations.
</objective>

<execution_context>
@/Users/santino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/santino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-orchestration-automation/06-RESEARCH.md

# Existing n8n client for pattern reference
@apps/omnii_mcp/src/services/integrations/n8n-agent-client.ts
@apps/omnii_mcp/src/config/n8n-agent.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create n8n workflow client with REST API operations</name>
  <files>
    apps/omnii_mcp/src/services/integrations/n8n-workflow-client.ts
  </files>
  <action>
1. Create `apps/omnii_mcp/src/services/integrations/n8n-workflow-client.ts`:

   a. Import from config and audit logger:
      ```typescript
      import { n8nAgentConfig } from '../../config/n8n-agent.config';
      import { logAuditEvent } from '../audit';
      import { backOff } from 'exponential-backoff';
      ```

   b. Define types for n8n API responses:
      ```typescript
      export interface Workflow {
        id: string;
        name: string;
        active: boolean;
        createdAt: string;
        updatedAt: string;
        nodes?: unknown[];
        connections?: unknown;
        settings?: {
          description?: string;
          webhookPath?: string;
        };
      }

      export interface N8nExecution {
        id: string;
        workflowId: string;
        finished: boolean;
        mode: string;
        status: 'running' | 'success' | 'error' | 'waiting';
        startedAt: string;
        stoppedAt?: string;
        data?: unknown;
      }

      export interface WorkflowTriggerResult {
        executionId?: string;
        success: boolean;
        data?: unknown;
        error?: string;
      }
      ```

   c. Create N8nWorkflowClient class:

      - Constructor: Initialize with baseUrl from config, apiKey from N8N_API_KEY env var
        Log warning if API key not configured (some operations require it)

      - Private method `getHeaders()`: Return headers with X-N8N-API-KEY if available

      - `async listWorkflows(): Promise<Workflow[]>`
        - GET /api/v1/workflows with backOff retry
        - Parse response, return workflow array
        - Log audit event for workflow list request
        - Handle errors gracefully (return empty array if API unavailable)

      - `async getWorkflow(workflowId: string): Promise<Workflow | null>`
        - GET /api/v1/workflows/{workflowId}
        - Return null if not found (404)

      - `async getExecutionStatus(executionId: string): Promise<N8nExecution | null>`
        - GET /api/v1/executions/{executionId}
        - Return null if not found

      - `async triggerWorkflow(workflowId: string, data: unknown): Promise<WorkflowTriggerResult>`
        - First, get workflow to find webhook path
        - If workflow has webhook node, POST to webhook URL
        - If no webhook, try production webhook URL pattern: /webhook/{workflowId}
        - Use backOff with retry for transient errors
        - Log audit event for workflow trigger

      - `async triggerWorkflowByWebhook(webhookUrl: string, data: unknown): Promise<WorkflowTriggerResult>`
        - Direct POST to provided webhook URL
        - Used when webhook URL is already known

   d. Add error handling:
      - 401/403: Log and throw auth error
      - 404: Return null (not found)
      - 429: Respect rate limit, log warning
      - 5xx: Retry with backOff

   e. Create singleton: `export const n8nWorkflowClient = new N8nWorkflowClient();`

2. Add environment variable to config reference:
   - N8N_API_KEY: Optional API key for n8n REST API (required for workflow list/status, not for webhook triggers)
  </action>
  <verify>
Run `bun run build` in apps/omnii_mcp - should compile without errors.

Test import:
```bash
cd apps/omnii_mcp && bun -e "
const { n8nWorkflowClient } = require('./src/services/integrations/n8n-workflow-client');
console.log('n8nWorkflowClient available:', !!n8nWorkflowClient);
console.log('Methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(n8nWorkflowClient)));
"
```
  </verify>
  <done>
N8nWorkflowClient created with listWorkflows, getWorkflow, getExecutionStatus, triggerWorkflow methods. Audit logging integrated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update integrations barrel export</name>
  <files>
    apps/omnii_mcp/src/services/integrations/index.ts
  </files>
  <action>
1. Check if `apps/omnii_mcp/src/services/integrations/index.ts` exists. If not, create it.

2. Add export for n8n-workflow-client:
   ```typescript
   // Existing exports (if any)
   export * from './n8n-agent-client';

   // New export
   export * from './n8n-workflow-client';
   ```

3. Ensure both n8n clients are accessible from single import path.
  </action>
  <verify>
```bash
cd apps/omnii_mcp && bun -e "
const { n8nAgentClient, n8nWorkflowClient } = require('./src/services/integrations');
console.log('Both clients exported:', !!n8nAgentClient && !!n8nWorkflowClient);
"
```
  </verify>
  <done>
Integrations barrel export updated with both n8n clients.
  </done>
</task>

</tasks>

<verification>
1. `bun run build` compiles without errors
2. N8nWorkflowClient exports listWorkflows, getWorkflow, getExecutionStatus, triggerWorkflow
3. Audit logging calls made for workflow operations
4. Error handling with backOff retry implemented
5. Barrel export includes both n8n clients
</verification>

<success_criteria>
- N8nWorkflowClient can list workflows from n8n API
- Workflow trigger via webhook URL works
- Execution status queries supported
- Audit events logged for all operations
- Both n8n clients accessible from integrations barrel
</success_criteria>

<output>
After completion, create `.planning/phases/06-orchestration-automation/06-03-SUMMARY.md`
</output>
