---
phase: 01-foundation-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/omnii_mcp/src/services/neo4j/http-client.ts
  - apps/omnii_mcp/src/services/neo4j/index.ts
  - apps/omnii_mcp/src/types/neo4j.types.ts
autonomous: true

must_haves:
  truths:
    - "Neo4j queries execute successfully from Bun runtime"
    - "HTTP Query API returns same results as driver would"
    - "Connection errors surface with helpful messages"
  artifacts:
    - path: "apps/omnii_mcp/src/services/neo4j/http-client.ts"
      provides: "Neo4jHTTPClient class with query method"
      exports: ["Neo4jHTTPClient"]
    - path: "apps/omnii_mcp/src/types/neo4j.types.ts"
      provides: "TypeScript interfaces for Neo4j HTTP responses"
      exports: ["Neo4jQueryResult", "Neo4jHTTPConfig"]
  key_links:
    - from: "apps/omnii_mcp/src/services/neo4j/http-client.ts"
      to: "Neo4j Aura HTTP Query API"
      via: "fetch to /db/{database}/query/v2"
      pattern: "fetch.*query/v2"
---

<objective>
Replace the broken neo4j-driver with an HTTP Query API client that works reliably with Bun runtime.

Purpose: The official neo4j-driver has unresolved TCP-level incompatibilities with Bun for cluster connections (neo4j+s protocol), causing 60-second timeouts. The HTTP Query API is the official workaround that works with all runtimes.

Output: A drop-in Neo4j HTTP client that can execute Cypher queries via the official HTTP Query API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md

# Existing implementation to replace
@apps/omnii_mcp/src/config/neo4j.config.ts
@apps/omnii_mcp/src/services/neo4j/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Neo4j HTTP Client types and core implementation</name>
  <files>
    apps/omnii_mcp/src/types/neo4j.types.ts
    apps/omnii_mcp/src/services/neo4j/http-client.ts
  </files>
  <action>
Create TypeScript types for Neo4j HTTP Query API responses based on official Neo4j documentation:

**neo4j.types.ts:**
```typescript
// Response structure from Neo4j HTTP Query API v2
export interface Neo4jQueryResult {
  data: {
    fields: string[];
    values: any[][];
  };
  counters?: {
    nodesCreated?: number;
    nodesDeleted?: number;
    relationshipsCreated?: number;
    relationshipsDeleted?: number;
    propertiesSet?: number;
    labelsAdded?: number;
    labelsRemoved?: number;
  };
  bookmarks?: string[];
}

export interface Neo4jHTTPConfig {
  uri: string;        // https://xxxxx.databases.neo4j.io
  user: string;
  password: string;
  database: string;
}

export interface Neo4jHTTPError {
  code: string;
  message: string;
}
```

**http-client.ts:**
Create Neo4jHTTPClient class that:
1. Accepts config via constructor (uri, user, password, database)
2. Generates Basic auth header from credentials
3. Implements `query(cypher: string, params?: Record<string, any>): Promise<Neo4jQueryResult>`
4. POSTs to `${uri}/db/${database}/query/v2` with JSON body `{ statement, parameters }`
5. Handles errors with descriptive messages (auth failures, network issues, Cypher syntax errors)
6. Includes connection test method `testConnection(): Promise<boolean>` that runs `RETURN 1`

Use native fetch (Bun has built-in fetch). Do NOT import node-fetch or axios.

The URI format for Aura is `https://xxxxx.databases.neo4j.io` (HTTPS, not neo4j+s).
Extract the HTTPS URL from NEO4J_URI env var by replacing `neo4j+s://` with `https://`.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/omnii_mcp && pnpm exec tsc --noEmit src/services/neo4j/http-client.ts
```
  </verify>
  <done>
Neo4jHTTPClient class exists with typed query method, handles auth and errors gracefully
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate HTTP client and update service exports</name>
  <files>
    apps/omnii_mcp/src/services/neo4j/index.ts
    apps/omnii_mcp/src/config/neo4j.config.ts
  </files>
  <action>
Update the Neo4j service layer to use the new HTTP client:

1. **Update neo4j.config.ts:**
   - Remove neo4j-driver import and all driver-related code
   - Keep environment variable checks but update for HTTP format
   - Export a function `getNeo4jHTTPConfig(): Neo4jHTTPConfig` that:
     - Reads NEO4J_URI, NEO4J_USER, NEO4J_PASSWORD, NEO4J_DATABASE from env
     - Converts neo4j+s:// URI to https:// format
     - Returns typed config object

2. **Update services/neo4j/index.ts:**
   - Import Neo4jHTTPClient from ./http-client
   - Create singleton instance using getNeo4jHTTPConfig()
   - Update SimpleNeo4jService methods to use HTTP client instead of driver sessions
   - Key methods to update:
     - `listNodes()` - use http client query
     - `searchSimilarConcepts()` - use http client query
     - `getContextForQuery()` - use http client query
     - `healthCheck()` - use http client testConnection()
   - Keep the same public API so existing routes don't break

3. **Remove neo4j-driver dependency:**
   ```bash
   cd apps/omnii_mcp && pnpm remove neo4j-driver
   ```

Important: The HTTP API returns data in `{ fields: [...], values: [[...], [...]] }` format, not Neo4j Record objects. Update the result mapping logic accordingly.
  </action>
  <verify>
1. neo4j-driver no longer in package.json:
```bash
grep -c "neo4j-driver" apps/omnii_mcp/package.json || echo "Removed successfully"
```

2. TypeScript compiles:
```bash
cd apps/omnii_mcp && pnpm exec tsc --noEmit
```

3. App starts (will fail on missing env vars, which is expected):
```bash
cd apps/omnii_mcp && timeout 5 bun run src/app.ts 2>&1 | head -20
```
  </verify>
  <done>
neo4j-driver removed, HTTP client integrated, existing service API preserved, app compiles and starts
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **No driver dependency:**
   ```bash
   ! grep -q "neo4j-driver" apps/omnii_mcp/package.json
   ```

2. **HTTP client exports available:**
   ```bash
   grep -l "Neo4jHTTPClient" apps/omnii_mcp/src/services/neo4j/http-client.ts
   ```

3. **TypeScript compiles cleanly:**
   ```bash
   cd apps/omnii_mcp && pnpm exec tsc --noEmit
   ```

4. **Service API unchanged (existing code won't break):**
   ```bash
   grep -E "neo4jService\.(listNodes|searchSimilarConcepts|healthCheck)" apps/omnii_mcp/src/**/*.ts
   ```
</verification>

<success_criteria>
- Neo4j queries can execute via HTTP Query API from Bun runtime
- neo4j-driver package removed from dependencies
- Existing neo4jService API preserved for backward compatibility
- TypeScript types match Neo4j HTTP Query API v2 response format
- Connection errors provide helpful diagnostic messages
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md`
</output>
