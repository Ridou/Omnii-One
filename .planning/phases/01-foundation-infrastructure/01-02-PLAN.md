---
phase: 01-foundation-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/omnii_mcp/src/config/env.ts
  - apps/omnii_mcp/src/config/env.validation.ts
  - .env.example
autonomous: true

must_haves:
  truths:
    - "App fails fast on startup if required env vars are missing"
    - "Error messages clearly identify which variables are missing"
    - "OMNII_* namespace used for shared infrastructure variables"
    - "Bun native .env loading works (no dotenv package)"
  artifacts:
    - path: "apps/omnii_mcp/src/config/env.ts"
      provides: "Validated environment configuration singleton"
      exports: ["env", "EnvConfig"]
    - path: "apps/omnii_mcp/src/config/env.validation.ts"
      provides: "Zod schema for environment validation"
      exports: ["envSchema"]
  key_links:
    - from: "apps/omnii_mcp/src/config/env.ts"
      to: "process.env"
      via: "Zod parse on module load"
      pattern: "envSchema\\.parse\\(process\\.env\\)"
---

<objective>
Establish a robust environment configuration system with Zod validation and OMNII_* namespace for shared infrastructure.

Purpose: Current env.validation.ts validates but uses old variable names. Need to migrate to OMNII_* namespace (per Phase 0 decision) and make validation fail-fast on startup with helpful error messages.

Output: Type-safe environment configuration that validates on app startup with clear error messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md

# Phase 0 environment reconciliation
@.planning/phases/00-monorepo-consolidation-preparation/00-04-SUMMARY.md

# Current implementation
@apps/omnii_mcp/src/config/env.validation.ts
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create new environment validation schema with OMNII_* namespace</name>
  <files>
    apps/omnii_mcp/src/config/env.ts
  </files>
  <action>
Create a new env.ts file (separate from existing env.validation.ts) that:

1. **Define Zod schema with OMNII_* namespace:**
```typescript
import { z } from 'zod';

export const envSchema = z.object({
  // === Shared Infrastructure (OMNII_* namespace) ===
  // Supabase
  OMNII_SUPABASE_URL: z.string().url().describe('Supabase project URL'),
  OMNII_SUPABASE_ANON_KEY: z.string().min(1).describe('Supabase anon key'),
  OMNII_SUPABASE_SERVICE_ROLE_KEY: z.string().min(1).optional().describe('Supabase service role (server only)'),

  // Neo4j Aura (for provisioning API)
  OMNII_NEO4J_AURA_API_TOKEN: z.string().min(1).optional().describe('Neo4j Aura API token for provisioning'),
  OMNII_NEO4J_AURA_TENANT_ID: z.string().min(1).optional().describe('Neo4j Aura tenant ID'),

  // OpenAI
  OMNII_OPENAI_API_KEY: z.string().startsWith('sk-').describe('OpenAI API key'),

  // Redis
  OMNII_REDIS_URL: z.string().url().optional().describe('Redis connection URL'),

  // === MCP App-Specific (MCP_* namespace) ===
  MCP_BASE_URL: z.string().url().default('http://localhost:8081'),
  MCP_PORT: z.coerce.number().default(8081),

  // === Legacy Neo4j (for existing dev databases, will be per-user in production) ===
  NEO4J_URI: z.string().startsWith('neo4j+s://').optional().describe('Legacy Neo4j URI'),
  NEO4J_USER: z.string().min(1).optional(),
  NEO4J_PASSWORD: z.string().min(1).optional(),
  NEO4J_DATABASE: z.string().default('neo4j'),

  // === n8n Integration ===
  N8N_AGENT_SWARM_URL: z.string().url().optional(),
  N8N_AGENT_ENABLED: z.coerce.boolean().default(false),
  N8N_AGENT_TIMEOUT: z.coerce.number().default(60000),

  // === Third-party APIs ===
  COMPOSIO_API_KEY: z.string().min(1).optional(),
  ANTHROPIC_API_KEY: z.string().startsWith('sk-ant-').optional(),

  // === Environment ===
  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
});

export type EnvConfig = z.infer<typeof envSchema>;
```

2. **Create fail-fast validation with helpful errors:**
```typescript
function formatValidationError(error: z.ZodError): string {
  const issues = error.issues.map(issue => {
    const path = issue.path.join('.');
    return `  - ${path}: ${issue.message}`;
  });
  return `Environment validation failed:\n${issues.join('\n')}\n\nCheck .env.example for required variables.`;
}

let _env: EnvConfig | null = null;

export function getEnv(): EnvConfig {
  if (_env) return _env;

  const result = envSchema.safeParse(process.env);

  if (!result.success) {
    console.error(formatValidationError(result.error));
    process.exit(1);
  }

  _env = result.data;
  console.log('Environment validated successfully');
  return _env;
}

// Validate immediately on import (fail-fast)
export const env = getEnv();
```

3. **Remove dotenv if present** - Bun loads .env files automatically.

Important: Support BOTH old names (NEO4J_URI) and new names (OMNII_*) during transition. Old names are optional, new names are the standard going forward.
  </action>
  <verify>
TypeScript compiles:
```bash
cd apps/omnii_mcp && pnpm exec tsc --noEmit src/config/env.ts
```
  </verify>
  <done>
env.ts exists with OMNII_* schema, fail-fast validation, and helpful error messages
  </done>
</task>

<task type="auto">
  <name>Task 2: Update .env.example and migrate existing config usages</name>
  <files>
    .env.example
    apps/omnii_mcp/src/config/env.validation.ts
    apps/omnii_mcp/src/app.ts
  </files>
  <action>
1. **Update root .env.example** to include Phase 1 variables:
   - Add OMNII_SUPABASE_URL, OMNII_SUPABASE_ANON_KEY section
   - Add OMNII_NEO4J_AURA_API_TOKEN, OMNII_NEO4J_AURA_TENANT_ID section
   - Keep existing variables for backward compatibility
   - Add comments explaining the namespace strategy

2. **Deprecate old env.validation.ts:**
   - Add deprecation comment at top pointing to new env.ts
   - Keep file for backward compatibility but export from new env.ts

3. **Update app.ts to use new env config:**
   - Import `env` from './config/env'
   - Replace direct process.env access with env.* where applicable
   - This ensures validation runs on startup (fail-fast)

4. **Create apps/omnii_mcp/.env.example** with MCP-specific variables:
```bash
# MCP Backend Configuration
# Copy to .env.local for local development (gitignored)

# === MCP App Settings ===
MCP_BASE_URL=http://localhost:8081
MCP_PORT=8081

# === Shared Infrastructure (from root .env) ===
# These should be set in root .env, not duplicated here
# OMNII_SUPABASE_URL=
# OMNII_OPENAI_API_KEY=

# === Legacy Neo4j (dev only, production uses per-user DBs) ===
NEO4J_URI=neo4j+s://your-instance.databases.neo4j.io
NEO4J_USER=neo4j
NEO4J_PASSWORD=your-password
NEO4J_DATABASE=neo4j
```
  </action>
  <verify>
1. .env.example has OMNII_* variables:
```bash
grep -c "OMNII_" .env.example
```

2. App imports new env config:
```bash
grep -l "from.*config/env" apps/omnii_mcp/src/app.ts
```

3. TypeScript compiles:
```bash
cd apps/omnii_mcp && pnpm exec tsc --noEmit
```
  </verify>
  <done>
.env.example updated with OMNII_* namespace, app.ts uses new env config, validation runs on startup
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **OMNII_* namespace in schema:**
   ```bash
   grep -c "OMNII_" apps/omnii_mcp/src/config/env.ts
   ```

2. **Fail-fast validation:**
   ```bash
   grep -l "process.exit(1)" apps/omnii_mcp/src/config/env.ts
   ```

3. **TypeScript compiles:**
   ```bash
   cd apps/omnii_mcp && pnpm exec tsc --noEmit
   ```

4. **App starts and validates (expect env var errors without .env):**
   ```bash
   cd apps/omnii_mcp && timeout 3 bun run src/app.ts 2>&1 | grep -E "(validation|Environment)"
   ```
</verification>

<success_criteria>
- App fails fast on startup if required OMNII_* env vars are missing
- Error messages clearly identify which variables are missing with helpful descriptions
- OMNII_* namespace used for shared infrastructure variables
- Legacy variable names supported for backward compatibility during transition
- No dotenv package used (Bun native .env loading)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md`
</output>
