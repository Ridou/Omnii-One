---
phase: 01-foundation-infrastructure
plan: 04
type: execute
wave: 3
depends_on: ["01-01", "01-03"]
files_modified:
  - apps/omnii_mcp/src/services/neo4j/provisioning.ts
  - apps/omnii_mcp/src/routes/webhooks/auth.ts
  - apps/omnii_mcp/src/services/neo4j/index.ts
autonomous: true
user_setup:
  - service: neo4j-aura
    why: "Neo4j Aura API for database provisioning"
    env_vars:
      - name: OMNII_NEO4J_AURA_API_TOKEN
        source: "Neo4j Aura Console -> Account -> API Credentials -> Create API Key"
      - name: OMNII_NEO4J_AURA_TENANT_ID
        source: "Neo4j Aura Console -> Account -> Tenant ID (in URL or settings)"
    dashboard_config:
      - task: "Create API credentials with database management permissions"
        location: "Neo4j Aura Console -> Account -> API Credentials"

must_haves:
  truths:
    - "New user signup triggers database provisioning"
    - "Provisioned database credentials stored in Supabase user_databases"
    - "Provisioning status tracked (pending, ready, failed)"
    - "Neo4j HTTP client can connect to user's provisioned database"
  artifacts:
    - path: "apps/omnii_mcp/src/services/neo4j/provisioning.ts"
      provides: "Neo4j Aura API client for database provisioning"
      exports: ["provisionUserDatabase", "getProvisioningStatus"]
    - path: "apps/omnii_mcp/src/routes/webhooks/auth.ts"
      provides: "Supabase auth webhook handler for signup"
      exports: ["authWebhooks"]
  key_links:
    - from: "apps/omnii_mcp/src/routes/webhooks/auth.ts"
      to: "apps/omnii_mcp/src/services/neo4j/provisioning.ts"
      via: "provisionUserDatabase(userId)"
      pattern: "provisionUserDatabase"
    - from: "apps/omnii_mcp/src/services/neo4j/provisioning.ts"
      to: "Neo4j Aura API"
      via: "POST https://api.neo4j.io/v1/instances"
      pattern: "api\\.neo4j\\.io"
    - from: "apps/omnii_mcp/src/services/neo4j/provisioning.ts"
      to: "Supabase user_databases table"
      via: "insert into user_databases"
      pattern: "user_databases.*insert"
---

<objective>
Implement automatic Neo4j database provisioning when users sign up, storing connection details in Supabase for per-user isolation.

Purpose: SEC-01 requires user data isolation at the database level. Database-per-user provisioning via Aura API ensures complete isolation. The webhook flow: Supabase auth event -> webhook -> Aura API -> store credentials.

Output: Working database provisioning triggered by Supabase auth webhook on user signup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Neo4j Aura provisioning service</name>
  <files>
    apps/omnii_mcp/src/services/neo4j/provisioning.ts
    apps/omnii_mcp/src/types/neo4j.types.ts
  </files>
  <action>
1. **Add Aura API types to neo4j.types.ts:**
```typescript
// Neo4j Aura API types
export interface AuraInstanceRequest {
  name: string;
  version: '5';
  region: string;
  memory: string;
  type: 'free-db' | 'professional-db' | 'enterprise-db';
  tenant_id: string;
  cloud_provider: 'gcp' | 'aws' | 'azure';
}

export interface AuraInstanceResponse {
  data: {
    id: string;
    name: string;
    status: 'creating' | 'running' | 'stopped' | 'deleting';
    connection_url: string;  // neo4j+s://xxx
    username: string;
    password: string;
    tenant_id: string;
  };
}

export interface AuraInstanceStatus {
  data: {
    id: string;
    status: 'creating' | 'running' | 'stopped' | 'deleting';
  };
}
```

2. **Create provisioning.ts:**
```typescript
import { createSupabaseAdmin } from '@omnii/auth';
import type { AuraInstanceRequest, AuraInstanceResponse, AuraInstanceStatus } from '../types/neo4j.types';

const AURA_API_BASE = 'https://api.neo4j.io/v1';

async function auraFetch<T>(
  endpoint: string,
  options: RequestInit = {}
): Promise<T> {
  const token = process.env.OMNII_NEO4J_AURA_API_TOKEN;
  if (!token) {
    throw new Error('Missing OMNII_NEO4J_AURA_API_TOKEN');
  }

  const response = await fetch(`${AURA_API_BASE}${endpoint}`, {
    ...options,
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
      ...options.headers,
    },
  });

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`Aura API error: ${response.status} - ${error}`);
  }

  return response.json();
}

/**
 * Provision a new Neo4j database for a user.
 * Called by auth webhook on signup.
 */
export async function provisionUserDatabase(userId: string): Promise<{
  instanceId: string;
  status: 'pending' | 'ready' | 'failed';
}> {
  const supabase = createSupabaseAdmin();
  const tenantId = process.env.OMNII_NEO4J_AURA_TENANT_ID;

  if (!tenantId) {
    throw new Error('Missing OMNII_NEO4J_AURA_TENANT_ID');
  }

  // Create instance in Aura
  const instanceRequest: AuraInstanceRequest = {
    name: `omnii-user-${userId.substring(0, 8)}`,
    version: '5',
    region: 'us-central1',  // GCP region
    memory: '1GB',          // Smallest size
    type: 'free-db',        // Use free tier for dev, change for prod
    tenant_id: tenantId,
    cloud_provider: 'gcp',
  };

  try {
    const result = await auraFetch<AuraInstanceResponse>('/instances', {
      method: 'POST',
      body: JSON.stringify(instanceRequest),
    });

    // Convert neo4j+s:// to https:// for HTTP API
    const httpUri = result.data.connection_url.replace('neo4j+s://', 'https://');

    // Store in Supabase (status pending until DB is ready)
    const { error: insertError } = await supabase
      .from('user_databases')
      .insert({
        user_id: userId,
        neo4j_uri: httpUri,
        neo4j_user: result.data.username,
        neo4j_password: result.data.password,
        database_name: result.data.name,
        status: 'pending',
        aura_instance_id: result.data.id,
      });

    if (insertError) {
      console.error('Failed to store database credentials:', insertError);
      throw new Error('Failed to store database credentials');
    }

    // Start background polling for readiness
    pollInstanceStatus(userId, result.data.id);

    return {
      instanceId: result.data.id,
      status: 'pending',
    };

  } catch (error) {
    console.error('Database provisioning failed:', error);

    // Store failed status
    await supabase.from('user_databases').insert({
      user_id: userId,
      neo4j_uri: '',
      neo4j_user: '',
      neo4j_password: '',
      database_name: '',
      status: 'failed',
    });

    throw error;
  }
}

/**
 * Poll Aura API for instance readiness, update status when ready.
 * Runs in background (non-blocking).
 */
async function pollInstanceStatus(userId: string, instanceId: string): Promise<void> {
  const supabase = createSupabaseAdmin();
  const maxAttempts = 60;  // ~5 minutes at 5s intervals
  const pollInterval = 5000;

  for (let attempt = 0; attempt < maxAttempts; attempt++) {
    await new Promise(resolve => setTimeout(resolve, pollInterval));

    try {
      const status = await auraFetch<AuraInstanceStatus>(`/instances/${instanceId}`);

      if (status.data.status === 'running') {
        await supabase
          .from('user_databases')
          .update({ status: 'ready' })
          .eq('user_id', userId);

        console.log(`Database ready for user ${userId}`);
        return;
      }

      if (status.data.status === 'stopped' || status.data.status === 'deleting') {
        await supabase
          .from('user_databases')
          .update({ status: 'failed' })
          .eq('user_id', userId);

        console.error(`Database provisioning failed for user ${userId}`);
        return;
      }

    } catch (error) {
      console.error(`Error polling instance status:`, error);
    }
  }

  // Timeout - mark as failed
  await supabase
    .from('user_databases')
    .update({ status: 'failed' })
    .eq('user_id', userId);
}

/**
 * Get provisioning status for a user.
 */
export async function getProvisioningStatus(userId: string): Promise<{
  status: 'pending' | 'ready' | 'failed' | 'not_found';
  database?: { uri: string; name: string };
}> {
  const supabase = createSupabaseAdmin();

  const { data, error } = await supabase
    .from('user_databases')
    .select('status, neo4j_uri, database_name')
    .eq('user_id', userId)
    .single();

  if (error || !data) {
    return { status: 'not_found' };
  }

  return {
    status: data.status as 'pending' | 'ready' | 'failed',
    database: data.status === 'ready' ? {
      uri: data.neo4j_uri,
      name: data.database_name,
    } : undefined,
  };
}
```
  </action>
  <verify>
TypeScript compiles:
```bash
cd apps/omnii_mcp && pnpm exec tsc --noEmit src/services/neo4j/provisioning.ts
```
  </verify>
  <done>
Provisioning service creates Aura instances, stores credentials, polls for readiness
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase auth webhook handler</name>
  <files>
    apps/omnii_mcp/src/routes/webhooks/auth.ts
    apps/omnii_mcp/src/routes/index.ts
  </files>
  <action>
1. **Create apps/omnii_mcp/src/routes/webhooks/auth.ts:**
```typescript
import { Elysia, t } from 'elysia';
import { provisionUserDatabase, getProvisioningStatus } from '../services/neo4j/provisioning';

// Supabase webhook payload type
const SignupWebhookBody = t.Object({
  type: t.Literal('INSERT'),
  table: t.Literal('users'),
  record: t.Object({
    id: t.String(),
    email: t.Optional(t.String()),
    created_at: t.String(),
  }),
  schema: t.Literal('auth'),
});

export const authWebhooks = new Elysia({ prefix: '/webhooks/auth' })
  // Health check for webhook endpoint
  .get('/health', () => ({ status: 'ok', webhook: 'auth' }))

  // Supabase auth.users INSERT webhook
  // Configure in Supabase: Database -> Webhooks -> auth.users -> INSERT
  .post('/signup', async ({ body, set }) => {
    const { record } = body;
    const userId = record.id;

    console.log(`[Auth Webhook] New user signup: ${userId}`);

    try {
      const result = await provisionUserDatabase(userId);

      console.log(`[Auth Webhook] Database provisioning started: ${result.instanceId}`);

      return {
        success: true,
        userId,
        instanceId: result.instanceId,
        status: result.status,
        message: 'Database provisioning started. Use /webhooks/auth/status/:userId to check progress.',
      };

    } catch (error) {
      console.error(`[Auth Webhook] Provisioning failed:`, error);
      set.status = 500;
      return {
        success: false,
        userId,
        error: error instanceof Error ? error.message : 'Unknown error',
      };
    }
  }, {
    body: SignupWebhookBody,
  })

  // Status check endpoint
  .get('/status/:userId', async ({ params }) => {
    const status = await getProvisioningStatus(params.userId);
    return status;
  }, {
    params: t.Object({
      userId: t.String(),
    }),
  });
```

2. **Wire webhooks into main routes (apps/omnii_mcp/src/routes/index.ts):**
   - Import authWebhooks
   - Add to routes: `.use(authWebhooks)`
  </action>
  <verify>
1. Webhook endpoint exists:
```bash
grep -l "/webhooks/auth/signup" apps/omnii_mcp/src/routes/webhooks/auth.ts
```

2. Routes integrated:
```bash
grep -l "authWebhooks" apps/omnii_mcp/src/routes/index.ts
```

3. TypeScript compiles:
```bash
cd apps/omnii_mcp && pnpm exec tsc --noEmit
```
  </verify>
  <done>
Auth webhook handles signup, triggers provisioning, status endpoint available
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Neo4j service to support per-user databases</name>
  <files>
    apps/omnii_mcp/src/services/neo4j/index.ts
    apps/omnii_mcp/src/services/neo4j/http-client.ts
  </files>
  <action>
1. **Add factory method to http-client.ts:**
```typescript
import { createSupabaseAdmin } from '@omnii/auth';

/**
 * Create Neo4j HTTP client for authenticated user.
 * Looks up user's database credentials from Supabase.
 */
export async function createClientForUser(userId: string): Promise<Neo4jHTTPClient> {
  const supabase = createSupabaseAdmin();

  const { data, error } = await supabase
    .from('user_databases')
    .select('neo4j_uri, neo4j_user, neo4j_password, database_name, status')
    .eq('user_id', userId)
    .single();

  if (error || !data) {
    throw new Error('User database not found. Provisioning may still be in progress.');
  }

  if (data.status !== 'ready') {
    throw new Error(`Database not ready. Current status: ${data.status}`);
  }

  return new Neo4jHTTPClient({
    uri: data.neo4j_uri,
    user: data.neo4j_user,
    password: data.neo4j_password,
    database: data.database_name,
  });
}
```

2. **Update SimpleNeo4jService in index.ts:**
   - Add method `getClientForUser(userId: string): Promise<Neo4jHTTPClient>`
   - Update methods to optionally accept userId parameter
   - For backward compatibility, keep existing methods working with legacy single-database mode

```typescript
// Add to SimpleNeo4jService class
async getClientForUser(userId: string): Promise<Neo4jHTTPClient> {
  return createClientForUser(userId);
}

// Update methods to support user-specific queries
async listNodesForUser(userId: string, nodeType: NodeType = 'Concept', limit = 100): Promise<NodeData[]> {
  const client = await this.getClientForUser(userId);
  const result = await client.query(
    `MATCH (n:${nodeType}) WHERE n.user_id = $userId RETURN n LIMIT $limit`,
    { userId, limit }
  );
  // Map result.data.values to NodeData[]
  return this.mapQueryResultToNodes(result);
}
```

3. **Export the factory:**
```typescript
export { createClientForUser } from './http-client';
```
  </action>
  <verify>
1. Factory method exists:
```bash
grep -l "createClientForUser" apps/omnii_mcp/src/services/neo4j/http-client.ts
```

2. Service updated:
```bash
grep -l "getClientForUser" apps/omnii_mcp/src/services/neo4j/index.ts
```

3. TypeScript compiles:
```bash
cd apps/omnii_mcp && pnpm exec tsc --noEmit
```
  </verify>
  <done>
Neo4j service supports per-user database connections via createClientForUser factory
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Provisioning service:**
   ```bash
   grep -l "provisionUserDatabase" apps/omnii_mcp/src/services/neo4j/provisioning.ts
   ```

2. **Webhook handler:**
   ```bash
   grep -l "/webhooks/auth/signup" apps/omnii_mcp/src/routes/webhooks/auth.ts
   ```

3. **User client factory:**
   ```bash
   grep -l "createClientForUser" apps/omnii_mcp/src/services/neo4j/http-client.ts
   ```

4. **TypeScript compiles:**
   ```bash
   cd apps/omnii_mcp && pnpm exec tsc --noEmit
   ```

5. **App starts:**
   ```bash
   cd apps/omnii_mcp && timeout 5 bun run src/app.ts 2>&1 | head -20
   ```
</verification>

<success_criteria>
- provisionUserDatabase creates Neo4j Aura instance via API
- Credentials stored in Supabase user_databases table
- Status polling updates status from pending to ready
- Auth webhook endpoint receives Supabase signup events
- createClientForUser factory returns configured client for user
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-04-SUMMARY.md`
</output>
