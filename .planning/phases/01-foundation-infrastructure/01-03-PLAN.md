---
phase: 01-foundation-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["01-02"]
files_modified:
  - packages/auth/src/index.ts
  - packages/auth/src/supabase.ts
  - packages/auth/src/middleware.ts
  - packages/db/src/schema.ts
  - apps/omnii_mcp/src/routes/auth.ts
autonomous: true
user_setup:
  - service: supabase
    why: "Authentication provider for Google OAuth"
    env_vars:
      - name: OMNII_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: OMNII_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon public"
      - name: OMNII_SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role secret"
    dashboard_config:
      - task: "Enable Google OAuth provider"
        location: "Supabase Dashboard -> Authentication -> Providers -> Google"
      - task: "Configure Google OAuth credentials"
        location: "Google Cloud Console -> APIs & Services -> Credentials"

must_haves:
  truths:
    - "User can sign up with Google OAuth via Supabase"
    - "JWT tokens contain user ID for tenant isolation"
    - "better-auth code removed from packages/auth"
    - "Auth middleware validates Supabase JWTs"
  artifacts:
    - path: "packages/auth/src/supabase.ts"
      provides: "Supabase client factory"
      exports: ["createSupabaseClient", "createSupabaseAdmin"]
    - path: "packages/auth/src/middleware.ts"
      provides: "Elysia auth middleware for JWT validation"
      exports: ["authMiddleware"]
    - path: "packages/db/src/schema.ts"
      provides: "user_databases table for per-user Neo4j connections"
      contains: "user_databases"
  key_links:
    - from: "packages/auth/src/middleware.ts"
      to: "Supabase Auth"
      via: "supabase.auth.getUser(token)"
      pattern: "getUser.*token"
    - from: "apps/omnii_mcp/src/routes/auth.ts"
      to: "packages/auth"
      via: "import authMiddleware"
      pattern: "import.*authMiddleware.*@omnii/auth"
---

<objective>
Standardize on Supabase Auth for the entire stack, removing better-auth, and create auth middleware for protecting routes.

Purpose: The codebase currently has both better-auth (packages/auth) and Supabase Auth (mobile app), creating confusion. FOUND-03 requirement specifies Supabase. Standardizing enables consistent JWT handling and webhook integration for database provisioning.

Output: Supabase-based auth package with middleware for protecting Elysia routes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md

# Prior plan context
@.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md

# Current implementation to replace
@packages/auth/src/index.ts
@packages/db/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace better-auth with Supabase client in packages/auth</name>
  <files>
    packages/auth/src/supabase.ts
    packages/auth/src/index.ts
    packages/auth/package.json
  </files>
  <action>
1. **Create packages/auth/src/supabase.ts:**
```typescript
import { createClient, SupabaseClient } from '@supabase/supabase-js';

// Server-side client with service role (for admin operations)
export function createSupabaseAdmin(): SupabaseClient {
  const url = process.env.OMNII_SUPABASE_URL;
  const serviceKey = process.env.OMNII_SUPABASE_SERVICE_ROLE_KEY;

  if (!url || !serviceKey) {
    throw new Error('Missing OMNII_SUPABASE_URL or OMNII_SUPABASE_SERVICE_ROLE_KEY');
  }

  return createClient(url, serviceKey, {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  });
}

// Client-side client with anon key (for user operations)
export function createSupabaseClient(): SupabaseClient {
  const url = process.env.OMNII_SUPABASE_URL;
  const anonKey = process.env.OMNII_SUPABASE_ANON_KEY;

  if (!url || !anonKey) {
    throw new Error('Missing OMNII_SUPABASE_URL or OMNII_SUPABASE_ANON_KEY');
  }

  return createClient(url, anonKey);
}

// Re-export types
export type { SupabaseClient, User, Session } from '@supabase/supabase-js';
```

2. **Update packages/auth/src/index.ts:**
   - Remove all better-auth imports and code
   - Export from supabase.ts: `export * from './supabase';`
   - Export middleware: `export * from './middleware';` (created in Task 2)
   - Keep Session type export for backward compatibility (alias Supabase Session)

3. **Update packages/auth/package.json:**
   - Remove better-auth, @better-auth/expo dependencies
   - Add @supabase/supabase-js if not present
   - Verify workspace protocol for internal deps

```bash
cd packages/auth && pnpm remove better-auth @better-auth/expo
cd packages/auth && pnpm add @supabase/supabase-js
```
  </action>
  <verify>
1. better-auth removed:
```bash
! grep -q "better-auth" packages/auth/package.json && echo "better-auth removed"
```

2. Supabase client exports:
```bash
grep -l "createSupabaseClient" packages/auth/src/supabase.ts
```

3. TypeScript compiles:
```bash
cd packages/auth && pnpm exec tsc --noEmit
```
  </verify>
  <done>
better-auth removed, Supabase client factories created, package updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Elysia auth middleware and user_databases schema</name>
  <files>
    packages/auth/src/middleware.ts
    packages/db/src/schema.ts
    apps/omnii_mcp/src/routes/auth.ts
  </files>
  <action>
1. **Create packages/auth/src/middleware.ts:**
```typescript
import { Elysia } from 'elysia';
import { createSupabaseClient } from './supabase';
import type { User } from '@supabase/supabase-js';

export interface AuthContext {
  user: User;
  tenantId: string;  // user.id - for database-per-user isolation
}

/**
 * Elysia middleware that validates Supabase JWT and extracts user info.
 * Usage: app.use(authMiddleware).get('/protected', ({ user, tenantId }) => ...)
 */
export const authMiddleware = new Elysia({ name: 'auth' })
  .derive(async ({ headers, set }): Promise<AuthContext> => {
    const authHeader = headers.authorization;

    if (!authHeader?.startsWith('Bearer ')) {
      set.status = 401;
      throw new Error('Missing or invalid authorization header');
    }

    const token = authHeader.substring(7);
    const supabase = createSupabaseClient();

    const { data: { user }, error } = await supabase.auth.getUser(token);

    if (error || !user) {
      set.status = 401;
      throw new Error('Invalid or expired token');
    }

    return {
      user,
      tenantId: user.id,  // Used for database-per-user lookup
    };
  });
```

2. **Add user_databases table to packages/db/src/schema.ts:**
```typescript
// Add after existing Post table

export const UserDatabase = pgTable("user_databases", (t) => ({
  id: t.uuid().notNull().primaryKey().defaultRandom(),
  userId: t.uuid().notNull().unique(),  // Supabase auth.users.id
  neo4jUri: t.text().notNull(),         // https://xxx.databases.neo4j.io
  neo4jUser: t.text().notNull(),
  neo4jPassword: t.text().notNull(),    // Encrypted in production
  databaseName: t.text().notNull(),     // e.g., "omnii-user-{userId}"
  status: t.varchar({ length: 20 }).notNull().default('pending'), // pending, ready, failed
  createdAt: t.timestamp().defaultNow().notNull(),
  updatedAt: t.timestamp({ mode: "date", withTimezone: true }).$onUpdateFn(() => sql`now()`),
}));

export const CreateUserDatabaseSchema = createInsertSchema(UserDatabase).omit({
  id: true,
  createdAt: true,
  updatedAt: true,
});
```

3. **Create apps/omnii_mcp/src/routes/auth.ts:**
```typescript
import { Elysia } from 'elysia';
import { authMiddleware } from '@omnii/auth';

export const authRoutes = new Elysia({ prefix: '/auth' })
  // Public health check
  .get('/health', () => ({ status: 'ok', provider: 'supabase' }))

  // Protected route example - requires valid JWT
  .use(authMiddleware)
  .get('/me', ({ user, tenantId }) => ({
    id: user.id,
    email: user.email,
    tenantId,
    provider: user.app_metadata?.provider || 'email',
  }));
```

4. **Wire auth routes into main app (apps/omnii_mcp/src/app.ts or routes/index.ts):**
   - Import authRoutes
   - Add to Elysia app: `.use(authRoutes)`
  </action>
  <verify>
1. Middleware exports:
```bash
grep -l "authMiddleware" packages/auth/src/middleware.ts
```

2. user_databases table in schema:
```bash
grep -l "user_databases" packages/db/src/schema.ts
```

3. Auth routes exist:
```bash
grep -l "/auth/me" apps/omnii_mcp/src/routes/auth.ts
```

4. TypeScript compiles across workspace:
```bash
pnpm exec turbo run build --filter=@omnii/auth --filter=@omnii/db --dry-run
```
  </verify>
  <done>
Auth middleware validates JWTs, user_databases schema ready, auth routes wired into MCP app
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **No better-auth dependency:**
   ```bash
   ! grep -rq "better-auth" packages/auth/ && echo "better-auth fully removed"
   ```

2. **Supabase client available:**
   ```bash
   grep -l "createSupabaseClient" packages/auth/src/supabase.ts
   ```

3. **Auth middleware available:**
   ```bash
   grep -l "authMiddleware" packages/auth/src/middleware.ts
   ```

4. **user_databases table defined:**
   ```bash
   grep -l "user_databases" packages/db/src/schema.ts
   ```

5. **TypeScript compiles:**
   ```bash
   cd packages/auth && pnpm exec tsc --noEmit
   cd packages/db && pnpm exec tsc --noEmit
   ```
</verification>

<success_criteria>
- better-auth completely removed from packages/auth
- Supabase client factories work with OMNII_* env vars
- Auth middleware validates Supabase JWTs and extracts user/tenantId
- user_databases table schema ready for database provisioning
- Auth routes expose /auth/health and /auth/me endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md`
</output>
